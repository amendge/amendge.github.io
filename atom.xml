<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://github.com/amendge/amendge.github.io</id>
    <title>Amend</title>
    <updated>2021-04-08T08:58:22.061Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://github.com/amendge/amendge.github.io"/>
    <link rel="self" href="https://github.com/amendge/amendge.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://github.com/amendge/amendge.github.io/images/avatar.png</logo>
    <icon>https://github.com/amendge/amendge.github.io/favicon.ico</icon>
    <rights>All rights reserved 2021, Amend</rights>
    <entry>
        <title type="html"><![CDATA[ã€å®è·µã€‘åŸºäºPrometheuså‡½æ•°çš„åŠ¨æ€å‘Šè­¦è§„åˆ™]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/shi-jian-ji-yu-prometheus-han-shu-de-dong-tai-gao-jing-gui-ze/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/shi-jian-ji-yu-prometheus-han-shu-de-dong-tai-gao-jing-gui-ze/">
        </link>
        <updated>2021-02-23T16:01:56.000Z</updated>
        <summary type="html"><![CDATA[<p>å¯¹äºç›‘æ§æ¥è¯´ï¼Œå‘Šè­¦è§„åˆ™æ˜¯å‘Šè­¦æ£€æµ‹å‘å‡ºçš„åŸºæœ¬ï¼Œå½“å‰å¸‚é¢ä¸Šå‡ ä¹æ‰€æœ‰çš„å¼€æºå‘Šè­¦è½¯ä»¶æä¾›çš„è§„åˆ™åŸºæœ¬ä¸Šéƒ½æ˜¯é™æ€å‘Šè­¦è§„åˆ™æˆ–è€…èŒƒå›´å‘Šè­¦</p>
]]></summary>
        <content type="html"><![CDATA[<p>å¯¹äºç›‘æ§æ¥è¯´ï¼Œå‘Šè­¦è§„åˆ™æ˜¯å‘Šè­¦æ£€æµ‹å‘å‡ºçš„åŸºæœ¬ï¼Œå½“å‰å¸‚é¢ä¸Šå‡ ä¹æ‰€æœ‰çš„å¼€æºå‘Šè­¦è½¯ä»¶æä¾›çš„è§„åˆ™åŸºæœ¬ä¸Šéƒ½æ˜¯é™æ€å‘Šè­¦è§„åˆ™æˆ–è€…èŒƒå›´å‘Šè­¦</p>
<!-- more -->
<h1 id="å…ˆçœ‹ä¸‹å®˜æ–¹æ–‡æ¡£">å…ˆçœ‹ä¸‹å®˜æ–¹æ–‡æ¡£</h1>
<h2 id="å®˜æ–¹å‡½æ•°è‹±æ–‡æ³¨é‡Š">å®˜æ–¹å‡½æ•°è‹±æ–‡æ³¨é‡Š</h2>
<pre><code>Holt-Winters is similar to a weighted moving average, where historical data has exponentially less influence on the current data.
Holt-Winter also accounts for trends in data. The smoothing factor (0 &lt; sf &lt; 1) affects how historical data will affect the current data. A lower smoothing factor increases the influence of historical data. The trend factor (0 &lt; tf &lt; 1) affects
how trends in historical data will affect the current data. A higher trend factor increases the influence.
of trends. Algorithm taken from https://en.wikipedia.org/wiki/Exponential_smoothing titled: &quot;Double exponential smoothing&quot;.
</code></pre>
<p>ä¸­æ–‡æ³¨é‡Šï¼š<br>
Holt-Wintersç±»ä¼¼äºåŠ æƒç§»åŠ¨å¹³å‡ï¼Œå…¶ä¸­å†å²æ•°æ®å¯¹å½“å‰æ•°æ®çš„å½±å“å‘ˆæŒ‡æ•°çº§å‡å°ã€‚<br>
Holt-Wintersä¹Ÿè§£é‡Šäº†æ•°æ®çš„è¶‹åŠ¿ã€‚å¹³æ»‘å› å­(0 &lt; sf &lt; 1)å½±å“å†å²æ•°æ®å¯¹ç”µæµçš„å½±å“<br>
æ•°æ®ã€‚å¹³æ»‘å› å­è¶Šä½ï¼Œå†å²æ•°æ®çš„å½±å“è¶Šå¤§ã€‚è¶‹åŠ¿å› å­(0 &lt; tf &lt; 1)å½±å“<br>
å†å²æ•°æ®çš„è¶‹åŠ¿å°†å¦‚ä½•å½±å“å½“å‰æ•°æ®ã€‚è¶‹åŠ¿å› å­è¶Šé«˜ï¼Œå½±å“è¶Šå¤§çš„è¶‹åŠ¿ã€‚ç®—æ³•å–è‡ªhttps://en.wikipedia.org/wiki/Exponential_smoothingæ ‡é¢˜:â€œåŒæŒ‡æ•°å¹³æ»‘â€</p>
<h2 id="å®˜æ–¹å‡½æ•°ä»£ç ">å®˜æ–¹å‡½æ•°ä»£ç </h2>
<pre><code>func funcHoltWinters(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector {
	samples := vals[0].(Matrix)[0]

	// The smoothing factor argument.
	sf := vals[1].(Vector)[0].V

	// The trend factor argument.
	tf := vals[2].(Vector)[0].V

	// Sanity check the input.
	if sf &lt;= 0 || sf &gt;= 1 {
		panic(errors.Errorf(&quot;invalid smoothing factor. Expected: 0 &lt; sf &lt; 1, got: %f&quot;, sf))
	}
	if tf &lt;= 0 || tf &gt;= 1 {
		panic(errors.Errorf(&quot;invalid trend factor. Expected: 0 &lt; tf &lt; 1, got: %f&quot;, tf))
	}

	l := len(samples.Points)

	// Can't do the smoothing operation with less than two points.
	if l &lt; 2 {
		return enh.Out
	}

	var s0, s1, b float64
	// Set initial values.
	s1 = samples.Points[0].V
	b = samples.Points[1].V - samples.Points[0].V

	// Run the smoothing operation.
	var x, y float64
	for i := 1; i &lt; l; i++ {

		// Scale the raw value against the smoothing factor.
		x = sf * samples.Points[i].V

		// Scale the last smoothed value with the trend at this point.
		b = calcTrendValue(i-1, tf, s0, s1, b)
		y = (1 - sf) * (s1 + b)

		s0, s1 = s1, x+y
	}

	return append(enh.Out, Sample{
		Point: Point{V: s1},
	})
}
</code></pre>
<h2 id="calctrendvalueæ³¨é‡Š">calcTrendValueæ³¨é‡Š</h2>
<pre><code> Calculate the trend value at the given index i in raw data d.
This is somewhat analogous to the slope of the trend at the given index.
The argument &quot;tf&quot; is the trend factor.
The argument &quot;s0&quot; is the computed smoothed value.
The argument &quot;s1&quot; is the computed trend factor.
The argument &quot;b&quot; is the raw input value.
</code></pre>
<p>ä¸­æ–‡æ³¨é‡Šï¼š</p>
<ul>
<li>è®¡ç®—åŸå§‹æ•°æ®dä¸­ç»™å®šç´¢å¼•iå¤„çš„è¶‹åŠ¿å€¼ã€‚</li>
<li>è¿™æœ‰ç‚¹ç±»ä¼¼äºç»™å®šæŒ‡æ•°å¤„è¶‹åŠ¿çš„æ–œç‡ã€‚</li>
<li>å‚æ•°â€œtfâ€æ˜¯è¶‹åŠ¿å› å­ã€‚</li>
<li>å‚æ•°&quot;s0&quot;æ˜¯è®¡ç®—å¾—åˆ°çš„å¹³æ»‘å€¼ã€‚</li>
<li>å‚æ•°&quot;s1&quot;æ˜¯è®¡ç®—å‡ºæ¥çš„è¶‹åŠ¿å› å­ã€‚</li>
<li>å‚æ•°â€œbâ€æ˜¯åŸå§‹è¾“å…¥å€¼ã€‚</li>
</ul>
<h2 id="calctrendvalueä»£ç ">calcTrendValueä»£ç </h2>
<pre><code>func calcTrendValue(i int, tf, s0, s1, b float64) float64 {
	if i == 0 {
		return b
	}
	x := tf * (s1 - s0)
	y := (1 - tf) * b
	return x + y
}
</code></pre>
<h2 id="ä»£ç è§‚åæ„Ÿ">ä»£ç è§‚åæ„Ÿ</h2>
<p>å¯¹äºæˆ‘æ¥è¯´è¿™ä¸ªä»£ç çœ‹çš„å¤§æ¦‚å°±æ˜¯ä¸€ä¸ªç®—æ³•çš„æ€è·¯ï¼Œå¦‚ä½•åŸºäºå½“å‰ç»™å®šçš„åºåˆ—å€¼,å†æ ¹æ®å¹³æ»‘å› å­ã€å†å²æ•°æ®æ¯”é‡å»ç®—ä¸€ä¸ªè¶‹åŠ¿å€¼</p>
<h1 id="å®è·µ">å®è·µ</h1>
<h2 id="åŸºäºç½‘ç»œæµé‡åšçªå¢çªé™å¼‚å¸¸æ£€æµ‹">åŸºäºç½‘ç»œæµé‡åšçªå¢çªé™å¼‚å¸¸æ£€æµ‹</h2>
<p>æ ¹æ®æœºå™¨å…¥å£æµé‡åšå¼‚å¸¸çªå¢çªé™å‘Šè­¦,å› ä¸ºæµé‡å¯¹äºç°ç½‘æ¥è¯´æ˜¯ä¸€ä¸ªå‘¨æœŸæ€§å˜åŒ–çš„å€¼ï¼Œæ ¹æ®ç°ç½‘è¯·æ±‚æ•°æ®çš„ç¨³å®šæ€§ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´å†…æµé‡æ—¶è¶‹äºä¸€å®šè§„å¾‹è¿›è¡Œä¸‹é™å’Œä¸Šå‡ï¼Œå¦‚æœæœ‰å¤§æ¯”ä¾‹çš„ä¸‹é™æˆ–ä¸Šå‡å°±å›æœ‰é—®é¢˜<br>
1.PrometheusæŸ¥è¯¢æµé‡è¯­å¥</p>
<pre><code>sum(irate(node_network_receive_bytes_total{app=&quot;01&quot;,idc=&quot;bj&quot;,group=&quot;test&quot;,device=~&quot;eth1&quot;}[5m] offset 1m)*8)by(device)
</code></pre>
<p>2.Prometheus record offset 5m</p>
<pre><code>groups:
- name: instance_net_record_rules
  rules:
  - record: net_offset_5m:node_network_receive:bj_test_01
    expr: sum(irate(node_network_receive_bytes_total{app=&quot;01&quot;,idc=&quot;bj&quot;,group=&quot;test&quot;,device=~&quot;eth1&quot;}[1m] offset 5m)*8)by(device)
</code></pre>
<p>æ­£å¼çš„å‘Šè­¦è§„åˆ™<br>
ä¸­æ–‡æ³¨é‡Š:app=&quot;01&quot;,idc=&quot;bj&quot;,group=&quot;test&quot;çš„æœºå™¨eth1ç½‘å¡å…¥å£æµé‡å’Œäº”åˆ†é’Ÿå‰æµé‡å¯¹æ¯” æ³¢åŠ¨è¶…30%</p>
<pre><code>abs(sum(irate(node_network_receive_bytes_total{app=&quot;01&quot;,idc=&quot;bj&quot;,group=&quot;test&quot;,device=~&quot;eth1&quot;}[1m])*8)by(device) - holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8))/1024^2 &gt; holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8)*0.3/1024^2 &gt;5
</code></pre>
<p>æ‹†åˆ†è§£æ:</p>
<ul>
<li>absæ˜¯ä¸ºäº†å»æ­£æ•´æ•°</li>
<li>holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8))/1024^2 æ ¹æ®ä¸€åˆ†é’Ÿå‰æ‰€å¾—çš„æ•°æ®è¿›è¡Œå¹³æ»‘æ‹Ÿåˆé™¤å½“å‰å¤§æ¦‚çš„æ•°æ®</li>
<li>1024^2 æµé‡å•ä½è½¬æ¢</li>
<li>å¤§äº5 ä¸ºäº†å»é™¤æœ€ä½è°·æ—¶æµé‡è¾ƒä½å‘Šè­¦<br>
4.å¯¹æ¯”<br>
holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8)ç­‰åŒäº<br>
sum(irate(node_network_receive_bytes_total{app=&quot;01&quot;,idc=&quot;bj&quot;,group=&quot;test&quot;,device=~&quot;eth1&quot;}[1m])*8)by(device)<br>
æ•ˆæœå›¾:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617866977845.png" alt="" loading="lazy"></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ã€ç›‘æ§ã€‘å‘Šè­¦èšåˆ|å‘Šè­¦å¬å›åŠŸèƒ½å®ç°]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/jian-kong-gao-jing-ju-he-orgao-jing-zhao-hui-gong-neng-shi-xian/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/jian-kong-gao-jing-ju-he-orgao-jing-zhao-hui-gong-neng-shi-xian/">
        </link>
        <updated>2021-01-13T13:40:14.000Z</updated>
        <summary type="html"><![CDATA[<pre><code>    ç›‘æ§ç³»ç»Ÿå‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå½“ä½ çš„ç³»ç»Ÿç›‘æ§è§„åˆ™å’Œæ•°æ®æ¯”è¾ƒå®Œå–„çš„æ—¶å€™æˆ–è€…è¦†ç›–é¢æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œåœ¨å‘ç”Ÿé—®é¢˜æ—¶å°±ä¼šäº§ç”Ÿå¤§é‡çš„å‘Šè­¦ä¿¡æ¯æˆ–è€…æŒç»­çš„å‘Šè­¦ï¼Œåœ¨å‘Šè­¦çš„æŒç»­é˜¶æ®µä»ä½-ä¸­-é«˜å’Œç›¸å…³çš„å‘Šè­¦éƒ½ä¼šå‡ºç°å¤šæ¬¡ã€‚æ‰€ä»¥åœ¨å‘Šè­¦å‘ç”Ÿæ—¶å¯¹äºå…³é”®ä¿¡æ¯çš„æå–å°¤ä¸ºå…³é”®
</code></pre>
]]></summary>
        <content type="html"><![CDATA[<pre><code>    ç›‘æ§ç³»ç»Ÿå‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå½“ä½ çš„ç³»ç»Ÿç›‘æ§è§„åˆ™å’Œæ•°æ®æ¯”è¾ƒå®Œå–„çš„æ—¶å€™æˆ–è€…è¦†ç›–é¢æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œåœ¨å‘ç”Ÿé—®é¢˜æ—¶å°±ä¼šäº§ç”Ÿå¤§é‡çš„å‘Šè­¦ä¿¡æ¯æˆ–è€…æŒç»­çš„å‘Šè­¦ï¼Œåœ¨å‘Šè­¦çš„æŒç»­é˜¶æ®µä»ä½-ä¸­-é«˜å’Œç›¸å…³çš„å‘Šè­¦éƒ½ä¼šå‡ºç°å¤šæ¬¡ã€‚æ‰€ä»¥åœ¨å‘Šè­¦å‘ç”Ÿæ—¶å¯¹äºå…³é”®ä¿¡æ¯çš„æå–å°¤ä¸ºå…³é”®
</code></pre>
<!-- more -->
<h1 id="é’ˆå¯¹åº”ç”¨å‘Šè­¦">é’ˆå¯¹åº”ç”¨å‘Šè­¦:</h1>
<p>æˆ‘ä»¬åº”ç”¨å‘Šè­¦ä¸»è¦é‡‡ç”¨Prometheusï¼ŒåŸºäºAlertmanageråšäº†åŸºäºalertnameã€instanceå’Œpodçš„åˆ†ç»„èšåˆè¦†ç›–å®¹å™¨å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„åˆ†ç»„èšåˆï¼Œä»¥åŠæ ¹æ®å®šä¹‰çš„çº§åˆ«è¿›è¡Œäº†åŒç»„ã€åŒæœºå™¨ã€åŒé›†ç¾¤é«˜çº§åˆ«é™é»˜ä½çº§åˆ«<br>
å‚è€ƒ: https://www.noalert.cn/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/</p>
<h1 id="é’ˆå¯¹ä¸šåŠ¡å‘Šè­¦">é’ˆå¯¹ä¸šåŠ¡å‘Šè­¦ï¼š</h1>
<p>é€»è¾‘æ¶æ„:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864543945.jpg" alt="" loading="lazy"><br>
ä¸šåŠ¡æ¨¡å—:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864150672.png" alt="" loading="lazy"><br>
æˆ‘ä»¬çš„ä¸šåŠ¡å‘Šè­¦å…¨éƒ¨æ˜¯åŸºäºç°ç½‘æ—¥å¿—å»åšçš„ç›‘æ§å‘Šè­¦åˆ†æ,ç°ç½‘åŸºæœ¬è¦†ç›–æ‰€æœ‰ç»„ä»¶çš„æ€§èƒ½æ—¥å¿—å’Œä¸šåŠ¡æ—¥å¿—ã€‚å¯¹äºæ¶ˆè´¹é“¾è·¯ã€æ¶ˆè´¹è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œæ‰“æ—¥å¿—çš„è§„èŒƒé—®é¢˜ä¸åšé˜è¿°</p>
<h2 id="ä¸šåŠ¡å‘Šè­¦è§„åˆ™">ä¸šåŠ¡å‘Šè­¦è§„åˆ™ï¼š</h2>
<ul>
<li>åŸºäºç»™å®šçš„çŠ¶æ€ç æˆ–è€—æ—¶è¿›è¡Œå…¨é‡æ—¥å¿—çš„æ¯”ä¾‹åˆ†æå’Œå…³é”®è¯æå–</li>
<li>å‘Šè­¦æ£€æµ‹æ—¶é—´ é»˜è®¤ä¸€åˆ†é’Ÿ</li>
<li>å‘Šè­¦æ£€æµ‹å…¨é‡æ•°æ®é»˜è®¤ä¸ºtype:_doc,éƒ¨åˆ†è‡ªå®šä¹‰</li>
<li>å‘Šè­¦è§„åˆ™å¸¦æœ‰ä¸šåŠ¡æ¨¡å—å±æ€§</li>
<li>å‘Šè­¦è§„åˆ™å¸¦æœ‰å‘Šè­¦æ¨é€åœ°å€</li>
<li>å‘Šè­¦è§„åˆ™å¸¦æœ‰æ£€æµ‹æ¯”ä¾‹å±æ€§</li>
</ul>
<h2 id="ä¸šåŠ¡è§„åˆ™æ¨¡æ¿">ä¸šåŠ¡è§„åˆ™æ¨¡æ¿</h2>
<pre><code>index: access-xxxx-*
name: aiuiathenaosstimeout
type: percentage_match

percentage_config:
  items:
    é«˜: [5, 100]
    ä¸­: [1, 5]
    ä½: [0.1, 1]
percentage_format_string: &quot;%.3f&quot;
match_min_num: 10
aiui_group: ['aiui-athena-nlu']
minutes: 1

filter:
- term:
    _type: doc
match_bucket_filter:
- terms:
    ret: [11004]
http_post_url: &quot;http://xxxxxxx:8088/alert&quot;
http_post_static_payload:
    subject: ä¸Šæµ·-å…¥å£-ç»„ä»¶åç§°-11004å¼‚å¸¸çŠ¶æ€ç ç›‘æ§
    message: ä¸Šæµ·-ç»„ä»¶å¼‚å¸¸ret-11004
</code></pre>
<h2 id="ä¸šåŠ¡å‘Šè­¦æ ¼å¼">ä¸šåŠ¡å‘Šè­¦æ ¼å¼</h2>
<pre><code class="language-{'match_count':">_group': ['athena', 'aiui-test'], '_level': 'ä½', 'num_matches': 1, 'message': 'å‘Šè­¦ä¿¡æ¯äºŒ', 'match_percentage': '0.110', 'subject': 'å‘Šè­¦æ ‡
é¢˜äºŒ'}
</code></pre>
<h1 id="talking-is-cheap-show-me-code">talking is cheap show me code</h1>
<p>##ä»£ç ç¯å¢ƒ</p>
<ul>
<li>Python tornado æ¡†æ¶</li>
<li>elastalert<br>
##ä¸»ä½“æ›´æ”¹</li>
</ul>
<pre><code>AGG_LOOP_MS = 65000  #æ¯«ç§’
MAX_AGG_SECONDS = 3600 #ç§’
ALERT_TTL = 90 #ç§’
EVENT_LOG_FILE =  &quot;./test.log&quot;

now = time.time()
unique_value = str(random.randint(0, 3000000000))
#unique_value = str(random.sample('abcdefghijklmnopqrstuvwxyz0123456789', 8))
logger = EventLogger(EVENT_LOG_FILE)
logger.write(now, &quot;alert&quot;, &quot;merge&quot;, unique_value, ALERT_TTL, json.dumps(data,ensure_ascii=False))
#æ¡†æ¶è°ƒç”¨
ioloop.PeriodicCallback(cronjob_aggregation, AGG_LOOP_MS).start()
ioloop.IOLoop.current().start()
</code></pre>
<h3 id="event_loggerpy-å‘Šè­¦å†™å…¥å’Œè¯»å–">event_logger.py #å‘Šè­¦å†™å…¥å’Œè¯»å–</h3>
<pre><code>#!python3
# -*- coding: utf-8 -*-
import json
import os
import pathlib
import requests

TS = 0
EVENT_TYPE = 1
STATUS = 2
UNIQ_VALUE = 3
TTL = 4
MSG = 5
class EventLogger(object):
    file_path = &quot;&quot;
    content = []

    def __init__(self, file_path):
        self.file_path = file_path
        self.read()

    def __del__(self):
        pass

    def write(self, ts, event_type, status, uniq_value, ttl, msg):
        if isinstance(msg, dict):
            msg = json.dumps(msg)
        with open(self.file_path, &quot;a+&quot;) as f:
            ts = int(ts)
            ttl = int(ttl)
            f.write(&quot;{};{};{};{};{};{}\n&quot;.format(ts, event_type, status, uniq_value, ttl, msg))
            self.content.append((ts, event_type, status, uniq_value, ttl, msg))
            print &quot;alert insert ok&quot;

    def read(self):
        if not os.path.isfile(self.file_path):
            pathlib.Path(self.file_path).touch()
        with open(self.file_path, &quot;r&quot;) as f:
            self.content = []
            #for l in f.readlines():
            for l in f.read().splitlines():
                l = l.split(&quot;;&quot;)
                info = l[:MSG]
                info[TS] = int(info[TS])
                info[TTL] = int(info[TTL])
                msg = &quot;;&quot;.join(l[MSG:])
                self.content.append((info + [msg]))
</code></pre>
<h3 id="èšåˆæ ¸å¿ƒéƒ¨åˆ†">èšåˆæ ¸å¿ƒéƒ¨åˆ†ï¼š</h3>
<pre><code>def cronjob_aggregation():
    logger = EventLogger(EVENT_LOG_FILE)
    content = [x for x in logger.content]
    content.reverse()
    now = time.time()
    left_time = now - MAX_AGG_SECONDS

    msg_to_send = defaultdict(list)
    wechatid_to_send = list()
    already_send_set = dict()
    to_group = 0
    # è·å–æ‰€æœ‰æ²¡æœ‰å‘é€çš„èšåˆæ¶ˆæ¯
    for row in content:
        if row[TS] &lt; left_time:
            break  # è¶…è¿‡æ”¯æŒçš„æœ€å¤§æ¶ˆæ¯è¿‡æœŸæ—¶é—´å°±ä¸å¤„ç†äº†
        if row[EVENT_TYPE] == &quot;alert&quot; and row[STATUS] == &quot;merge&quot; and row[UNIQ_VALUE] not in already_send_set:
            msg_to_send[row[UNIQ_VALUE]].append(row)
        if row[EVENT_TYPE] == &quot;alert&quot; and row[STATUS] == &quot;send&quot; and row[UNIQ_VALUE] not in already_send_set:
            already_send_set[row[UNIQ_VALUE]] = int(row[TTL]) + int(row[TS])  # æ ‡è®°æ¯ä¸ªèšåˆæ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´
        if 'aiui_group' in json.loads(row[MSG]).keys() and row[UNIQ_VALUE] not in already_send_set:
            wechatid_to_send.append(parse_user_info(json.loads(row[MSG]))['id'])
        if 'level' in json.loads(row[MSG]) and row[UNIQ_VALUE] not in already_send_set:
           if json.loads(row[MSG])['level'].encode(&quot;utf-8&quot;) in [&quot;é«˜&quot;,&quot;disaster&quot;]:
              to_group = 1

    # å‘é€è¿™äº›æ¶ˆæ¯
    alert_content = ''
    list_alert_content = []
    level_list = []
    for k, v in msg_to_send.items():
        if int(time.time()) &lt;= already_send_set.get(k, 0):
            continue  # æ²¡åˆ°è¶…æ—¶æ—¶é—´çš„ç›´æ¥è·³è¿‡
        msg_decoded = [json.loads(x[MSG]) for x in v]
        list_alert_content += [x[&quot;message&quot;] for x in msg_decoded]
        alert_content = '\n'.join(list_alert_content)
        subject = &quot;[èšåˆæ¶ˆæ¯] {}&quot;.format(msg_decoded[-1][&quot;subject&quot;])
        logger.write(now, &quot;alert&quot;, &quot;send&quot;, k, v[-1][TTL], json.dumps({&quot;subject&quot;:subject, &quot;message&quot;:alert_content},ensure_ascii=False))
    if msg_to_send.items() and len(msg_to_send.items()) &gt; 1 and to_group == 1:
       subject += ' å…±'+str(len(msg_to_send.items())) +'æ¡å‘Šè­¦'
       send2tag(subject.encode(&quot;utf-8&quot;),alert_content,'|'.join(wechatid_to_send))
       send2group(subject.encode(&quot;utf-8&quot;),alert_content)
    elif msg_to_send.items() and len(msg_to_send.items()) &gt; 1 and to_group == 0:
       subject += ' å…±'+str(len(msg_to_send.items())) +'æ¡å‘Šè­¦'
       send2tag(subject.encode(&quot;utf-8&quot;),alert_content,'|'.join(wechatid_to_send))
    else:
       subject = &quot;[ä¸šåŠ¡å‘Šè­¦] {}&quot;.format(msg_decoded[-1][&quot;subject&quot;])
       send2tag(subject.encode(&quot;utf-8&quot;),alert_content,'|'.join(wechatid_to_send))
</code></pre>
<p><strong>è¿˜å¯ä»¥æ ¹æ®é‡è¦çš„å‘Šè­¦çº§åˆ«è¿›è¡ŒTTLæ—¶é—´å†…çš„é«˜çº§åˆ«å‘Šè­¦å¬å›ï¼Œä»£ç å¦‚ä¸Šæ›´æ”¹æå–æ•°æ®å’Œå‘é€è§„åˆ™å³å¯</strong></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/">
        </link>
        <updated>2020-12-18T06:32:32.000Z</updated>
        <summary type="html"><![CDATA[<p>Prometheuså”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç›‘æ§é¡¹è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹,å†…å­˜æ¶ˆè€—æ˜¯å¾ˆå¤§çš„,å¦‚æœæ ¹æ®æŒ‡æ ‡é¡¹è¿›è¡Œæœé›†åˆ†å‰²ï¼Ÿ</p>
]]></summary>
        <content type="html"><![CDATA[<p>Prometheuså”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç›‘æ§é¡¹è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹,å†…å­˜æ¶ˆè€—æ˜¯å¾ˆå¤§çš„,å¦‚æœæ ¹æ®æŒ‡æ ‡é¡¹è¿›è¡Œæœé›†åˆ†å‰²ï¼Ÿ</p>
<!-- more -->
<h1 id="è½ç›˜è®¾è®¡">è½ç›˜è®¾è®¡ï¼š</h1>
<p>Prometheusåœ¨æ•°æ®è½ç›˜çš„æµç¨‹ä¸Šè¿›è¡Œäº†ä¸€å®šçš„è€ƒè™‘ã€‚<br>
å®Œæ•´çš„æ•°æ®æµç¨‹åº”è¯¥æ˜¯:pull-&gt;prometheus-&gt;memory-&gt;wal-&gt;tsdb-&gt;filesystem.<br>
æ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒPrometheusä¼šæŠŠæœ€æ–°æœé›†åˆ°çš„æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œé’ˆå¯¹æœé›†é‡è¾ƒå¤§ï¼Œmetricså†…åŒ…å«è¾ƒå¤§ã€è¾ƒå¤šlabelçš„å’Œç›‘æ§é¡¹ time seriesè¾ƒå¤šçš„ç›‘æ§æŒ‡æ ‡æ¥è¯´å­˜åœ¨å†…å­˜é‡Œæ˜¯ä¸å¤ªå‹å¥½çš„ï¼Œä¼šå ç”¨è¾ƒé«˜çš„å†…å­˜ä½¿ç”¨ï¼ŒåŒæ—¶å†…å­˜é‡Œé¢ä¹Ÿä¼šå­˜å‚¨ç›¸å¯¹è¾ƒè€è¿˜æ²¡æœ‰è½ç›˜çš„æ•°æ®ã€‚ä»¥t0-t1ä¸ºæœ€æ–°æ—¶é—´ï¼Œt1-t2ä¸ºè¾ƒè€æ—¶é—´ï¼Œt3,t4... å†…å­˜ä¸­: (t0-t1çš„series+t1-t2çš„series)<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617867267806.png" alt="" loading="lazy"></p>
<p>é‚£ä¹ˆå¸¦æ¥çš„é—®é¢˜å°±æ¥äº†ï¼š<br>
1.å¦‚æœPrometheusé‡å¯æ€ä¹ˆåŠï¼Ÿ<br>
å¦‚æœPrometheusé‡å¯çš„è¯ï¼ŒPrometheusæœ¬åœ°ä¼šæœ‰ç¼“å­˜æ–‡ä»¶WALå­˜å‚¨è¿˜æœªè½ç›˜çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´ä¸ä¼šé€ æˆå¤§é‡çš„æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯åœ¨ä¸€å®šçš„æ•°æ®é‡ä¸‹ï¼ŒPrometheusé‡å¯ä¼šè¿›è¡ŒWALæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ŒåŠ è½½è¿‡ç¨‹ä¼šé€ æˆ1-2ä¸ªæ‹‰å–é—´éš”çš„æ•°æ®ä¸¢å¤±ï¼Œå‡ºç°æ–­å±‚ã€‚åŒæ—¶æ ¹æ®æ•°æ®é‡å¤§å°ä¸åŒï¼ŒåŠ è½½æ—¶é—´ä¹Ÿä¼šä¸ä¸€æ ·<br>
2.å¦‚æœæŸ¥è¯¢æ›´åŠ ä¹…è¿œçš„æ•°æ®æ€ä¹ˆåŠï¼Ÿ<br>
Prometheuså¯¹äºæ›´åŠ ä¹…è¿œçš„æ•°æ®æŸ¥è¯¢æ–¹å¼æ˜¯ä»filesystem-&gt;tsdb-&gt;Memoryçš„æ–¹å¼,å¦‚æœå¯¹äºä¸€äº›time seriesè¾ƒå¤šçš„æŒ‡æ ‡æ¥è¯´ï¼Œå‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ­¤æ—¶å†…å­˜ä¸­(æŸ¥è¯¢çš„time series+æ–°æ‹‰å–çš„time series),æ‰€æœ‰ä¼šå‘ç°æ ¹æ®æŸ¥è¯¢æ•°æ®é‡çš„ä¸åŒå†…å­˜ä¼šæœ‰ä¸åŒç¨‹åº¦çš„ä¸Šå‡ï¼Œå¾ˆå¤§çš„å¯èƒ½æ’‘çˆ†å†…å­˜è¿›è¡Œé‡å¯ã€‚<br>
3.å¦‚æœè½ç›˜+å†…å­˜ä¸è¶³æ€ä¹ˆåŠ<br>
å¦‚æœå¯¹äºæ–°æ‹‰å–æ•°æ®æ¥ä¸åŠè½ç›˜å°±ä¼šè¿›è¡Œé‡å¯ã€OOMç­‰ï¼Œé‚£è¿™ä¸ªæ—¶å€™æœ‰å¿…è¦æ‰©å¤§å†…å­˜æˆ–è€…è¿›è¡Œåˆ†ç¦»äº†</p>
<h1 id="é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»">é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»</h1>
<h2 id="æ¶æ„ç­–ç•¥">æ¶æ„ç­–ç•¥</h2>
<figure data-type="image" tabindex="1"><img src="https://github.com/amendge/amendge.github.io/post-images/1617867218714.png" alt="" loading="lazy"></figure>
<h2 id="é€»è¾‘">é€»è¾‘</h2>
<p>1.å°†æ‰€æœ‰è¦æ‹‰èµ·çš„targetç­‰ä¿¡æ¯æ‰“å¥½æ ‡ç­¾æ³¨å†Œåˆ°consul<br>
2.Prometheusé€šè¿‡hashmodæ–¹å¼åˆ†å—æ‹‰å–consulé…ç½®<br>
3.æ¯ä¸ªå•ç‹¬Prometheuséƒ½ä¼šæ‹‰å–ä¸åŒäºå…¶ä»–çš„é…ç½®<br>
4.æœ€å¥½å¯¹æ¯ä¸ªå•ç‹¬çš„Prometheusåšæ•°æ®æ±‡æ€»æˆ–è€…æŸ¥è¯¢æ±‡æ€»</p>
<h2 id="æ­¥éª¤ä»¥k8séƒ¨ç½²ä¸ºä¾‹">æ­¥éª¤(ä»¥K8Séƒ¨ç½²ä¸ºä¾‹)</h2>
<p>1.é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼<br>
Dockerfile:</p>
<pre><code>FROM  prometheus/prometheus:2.20.0
MAINTAINER name gecailong

COPY ./entrypoint.sh /bin

ENTRYPOINT [&quot;/bin/entrypoint.sh&quot;]
</code></pre>
<pre><code>entrypoint.shï¼š

#!/bin/sh

ID=${POD_NAME##*-}

cp /etc/prometheus/prometheus.yml /prometheus/prometheus-hash.yml

sed -i &quot;s/ID_NUM/$ID/g&quot; /prometheus/prometheus-hash.yml

/bin/prometheus --config.file=/prometheus/prometheus-hash.yml --query.max-concurrency=20 --storage.tsdb.path=/prometheus --storage.tsdb.max-block-duration=2h --storage.tsdb.min-block-duration=2h  --storage.tsdb.retention=2h --web.listen-address=:9090 --web.enable-lifecycle --web.enable-admin-api
</code></pre>
<p><strong>IDNUMï¼š ä¸ºæˆ‘ä»¬åé¢é…ç½®åšå‡†å¤‡</strong><br>
2.Prometheuséƒ¨ç½²<br>
Prometheusé…ç½®æ–‡ä»¶:</p>
<pre><code>  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

      external_labels:
         monitor: 'k8s-sh-prod'
         service: 'k8s-all'
         ID: 'ID_NUM'
         ...
</code></pre>
<p>è¿™ä¸ªIDæ˜¯ä¸ºäº†æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥åŒºåˆ†åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºç­‰ä¸‹hashmodæ¨¡å—çš„å¯¹åº”å€¼</p>
<p>ä»¥æ‹‰å–Nodeä¿¡æ¯ä¸ºä¾‹:</p>
<pre><code>    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250 
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
        #ä»¥ä¸‹ä¸ºhashmodé…ç½®éƒ¨åˆ†
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10   #è¦åˆ†æˆçš„æ¨¡å—æ€»æ•°
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM  #å½“å‰æ‰€å±æ¨¡å—æ•°
        action:        keep
</code></pre>
<p>éƒ¨ç½²æ–‡ä»¶:</p>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
  name: prometheus-sts
  namespace: monitoring
spec:
  serviceName: &quot;prometheus&quot;
  replicas: 10   #hashmodæ€»æ¨¡å—æ•°
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - image: prometheus:2.20.0-hash
        name: prometheus
        securityContext:
           runAsUser: 0
        command:
        - &quot;/bin/entrypoint.sh&quot;  #hashmodè„šæœ¬æ‰§è¡Œ
        env:
        - name: POD_NAME   #æ ¹æ®statefulsetçš„ç‰¹æ€§ä¼ å…¥PODåç§°ç”¨äºæ¨¡å—å–å€¼
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
</code></pre>
<p>é’ˆå¯¹æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢çš„é—®é¢˜å¯ä»¥é€šè¿‡Thanosè¿›è¡ŒæŸ¥è¯¢èšåˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡victoriametricsè¿›è¡Œæ•°æ®å­˜å‚¨çš„èšåˆåœ¨grafanaç•Œé¢è¿›è¡Œç»Ÿä¸€çš„æŸ¥è¯¢</p>
<p>é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¦‚ä½•ç”¨åŸç”ŸPrometheusç›‘æ§å¤§è§„æ¨¡Kubernetesé›†ç¾¤]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/">
        </link>
        <updated>2020-11-02T05:53:54.000Z</updated>
        <summary type="html"><![CDATA[<figure data-type="image" tabindex="1"><img src="/post-images/1617861678108.png" alt="" loading="lazy"></figure>
]]></summary>
        <content type="html"><![CDATA[<figure data-type="image" tabindex="1"><img src="https://github.com/amendge/amendge.github.io/post-images/1617861678108.png" alt="" loading="lazy"></figure>
<!-- more -->
<p>æ¦‚è¿°<br>
å¯¹äºPrometheusçš„ç»„ä»¶èƒ½åŠ›æ˜¯æ¯‹åº¸ç½®ç–‘çš„ï¼Œä½†æ˜¯ä½¿ç”¨ä¹…äº†ä¼šå‘ç°å¾ˆå¤šçš„æ€§èƒ½é—®é¢˜ï¼Œè¯¸å¦‚å†…å­˜é—®é¢˜ã€å¤§è§„æ¨¡æ‹‰å–é—®é¢˜ã€å¤§è§„æ¨¡å­˜å‚¨é—®é¢˜ç­‰ç­‰</p>
<p>å¦‚ä½•åŸºäºäº‘åŸç”ŸPrometheusè¿›è¡ŒK8Sé›†ç¾¤åŸºç¡€ç›‘æ§å¤§è§„æ¨¡æ•°æ®æ‹‰å–æœ¬æ–‡å°†ä¼šç»™å‡ºå½“å‰ç­”æ¡ˆ</p>
<h1 id="æ¶æ„å›¾">æ¶æ„å›¾</h1>
<p><img src="https://github.com/amendge/amendge.github.io/post-images/1617861700664.png" alt="" loading="lazy"><br>
æˆ‘ä»¬å½“å‰çš„ç›‘æ§å¹³å°æ¶æ„å›¾ï¼Œæ ¹æ®æ¶æ„å›¾å¯ä»¥çœ‹å‡ºæˆ‘ä»¬å½“å‰çš„ç›‘æ§å¹³å°ç»“åˆäº†å¤šä¸ªæˆç†Ÿå¼€æºç»„ä»¶å’Œèƒ½åŠ›å®Œæˆäº†å½“å‰é›†ç¾¤çš„æ•°æ®+æŒ‡æ ‡+å±•ç¤ºçš„å·¥ä½œ<br>
å½“å‰æˆ‘ä»¬ç›‘æ§ä¸åŒçš„K8Sé›†ç¾¤ï¼ŒåŒ…å«ä¸åŒåŠŸèƒ½ã€ä¸åŒä¸šåŠ¡çš„é›†ç¾¤ï¼ŒåŒ…å«ä¸šåŠ¡ã€åŸºç¡€å’Œå‘Šè­¦ä¿¡æ¯</p>
<h1 id="é’ˆå¯¹k8sé›†ç¾¤ç›‘æ§">é’ˆå¯¹K8Sé›†ç¾¤ç›‘æ§</h1>
<p>æˆ‘ä»¬é‡‡ç”¨å¸¸è§çš„2ç§ç›‘æ§æ¶æ„ä¹‹ä¸€ï¼š<br>
1.Prometheus-operator<br>
2.Prometheuså•ç‹¬é…ç½®(é€‰æ‹©çš„æ¶æ„)<br>
tips:å¯¹äºPrometheus-operator ç¡®å®æ˜“äºéƒ¨ç½²åŒ–ã€ç®€å•çš„servicemonitorçœäº†å¾ˆå¤§çš„åŠ›æ°”,ä¸è¿‡å¯¹äºæˆ‘ä»¬è¿™æ ·å¤šç§ç§æœ‰åŒ–é›†ç¾¤æ¥è¯´ç»´æŠ¤æˆæœ¬ç¨å¾®æœ‰ç‚¹é«˜,æˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆæ›´å¤šçš„æ˜¯æƒ³çœç•¥åˆ›å»ºæœåŠ¡å‘ç°çš„æ­¥éª¤ï¼Œæ›´å¤šçš„é‡‡ç”¨æœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œçš„èƒ½åŠ›</p>
<h1 id="æ•°æ®æ‹‰å–">æ•°æ®æ‹‰å–</h1>
<p>åœ¨æ•°æ®æ‹‰å–æ–¹é¢æˆ‘ä»¬åšäº†ä¸€å®šçš„è°ƒæ•´ä¸ºäº†åº”å¯¹å¤§è§„æ¨¡èŠ‚ç‚¹æˆ–è€…æ•°æ®å¯¹äºapiserverçš„å¤§å‹åŠ›é—®é¢˜å’Œå¤§è§„æ¨¡æ•°æ®æ‹‰å–Prometheuså†…å­˜oomé—®é¢˜<br>
a.åˆ©ç”¨K8såšæœåŠ¡å‘ç°ï¼Œç›‘æ§æ•°æ®æ‹‰å–ç”±Prometheusä¹‹é—´æ‹‰å–ï¼Œé™ä½apiserveræ‹‰å–å‹åŠ›<br>
b.é‡‡ç”¨hashmodæ–¹å¼è¿›è¡Œåˆ†å¸ƒå¼æ‹‰å–ç¼“è§£å†…å­˜å‹åŠ›<br>
RBACæƒé™ä¿®æ”¹;</p>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: prometheus
  namespace: monitoring
rules:
- apiGroups: [&quot;&quot;]
  resources:
  - nodes
  - nodes/proxy
  - nodes/metrics #æ–°å¢è·¯å¾„ä¸ºäº†å¤–éƒ¨æ‹‰å–
  - nodes/metrics/cadvisor #æ–°å¢è·¯å¾„ä¸ºäº†å¤–éƒ¨æ‹‰å–
  - services
  - endpoints
  - pods
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- nonResourceURLs: [&quot;/metrics&quot;]
  verbs: [&quot;get&quot;]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring

</code></pre>
<p><code>éœ€è¦æ–°å¢å¯¹äºNodeèŠ‚ç‚¹çš„/metricså’Œ/metrics/cadvsiorè·¯å¾„çš„æ‹‰å–æƒé™</code><br>
ä»¥å®Œæ•´é…ç½®æ‹‰å–ç¤ºä¾‹:</p>
<ul>
<li>å¯¹äºthanosçš„æ•°æ®å†™å…¥æä¾›å†™å…¥é˜¿é‡Œäº‘OSSç¤ºä¾‹</li>
<li>å¯¹äºnode_exporteræ•°æ®æå– çº¿ä¸Šé™¤K8Så¤–çš†ä½¿ç”¨consulä½œä¸ºé…ç½®æ³¨å†Œå’Œå‘ç°</li>
<li>å¯¹äºä¸šåŠ¡è‡ªå®šä¹‰åŸºäºK8SåšæœåŠ¡å‘ç°å’Œæ‹‰å–</li>
</ul>
<h2 id="ä¸»æœºå‘½åè§„åˆ™">ä¸»æœºå‘½åè§„åˆ™</h2>
<p>æœºæˆ¿-ä¸šåŠ¡çº¿-ä¸šåŠ¡å±æ€§-åºåˆ—æ•° (ä¾‹:bja-athena-etcd-001)</p>
<h2 id="consulè‡ªåŠ¨æ³¨å†Œç¤ºä¾‹è„šæœ¬">consulè‡ªåŠ¨æ³¨å†Œç¤ºä¾‹è„šæœ¬</h2>
<pre><code>#!/bin/bash
  
#ip=$(ip addr show eth0|grep inet | awk '{ print $2; }' | sed 's/\/.*$//')
ip=$(ip addr | egrep -o '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | egrep &quot;^192\.168|^172\.21|^10\.101|^10\.100&quot; | egrep -v &quot;\.255$&quot; | awk -F. '{print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.&quot;$4}' | head -n 1)
ahost=`echo $HOSTNAME`
idc=$(echo $ahost|awk -F &quot;-&quot; '{print $1}')
app=$(echo $ahost|awk -F &quot;-&quot; '{print $2}')
group=$(echo $ahost|awk -F &quot;-&quot; '{print $3}')

if [ &quot;$app&quot; != &quot;test&quot; ]
then
echo &quot;success&quot;
curl -X PUT -d &quot;{\&quot;ID\&quot;: \&quot;${ahost}_${ip}_node\&quot;, \&quot;Name\&quot;: \&quot;node_exporter\&quot;, \&quot;Address\&quot;: \&quot;${ip}\&quot;, \&quot;tags\&quot;: [\&quot;idc=${idc}\&quot;,\&quot;group=${group}\&quot;,\&quot;app=${app}\&quot;,\&quot;server=${ahost}\&quot;], \&quot;Port\&quot;: 9100,\&quot;checks\&quot;: [{\&quot;tcp\&quot;:\&quot;${ip}:9100\&quot;,\&quot;interval\&quot;: \&quot;60s\&quot;}]}&quot; http://consul_server:8500/v1/agent/service/register
fi

</code></pre>
<h2 id="å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹">å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹</h2>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  bucket.yaml: |
    type: S3
    config:
      bucket: &quot;gcl-download&quot;
      endpoint: &quot;gcl-download.oss-cn-beijing.aliyuncs.com&quot;
      access_key: &quot;xxxxxxxxxxxxxx&quot;
      insecure: false
      signature_version2: false
      secret_key: &quot;xxxxxxxxxxxxxxxxxx&quot;
      http_config:
        idle_conn_timeout: 0s

  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

      external_labels:
         monitor: 'k8s-sh-prod'
         service: 'k8s-all'
         ID: 'ID_NUM'
         
    remote_write:
      - url: &quot;http://vmstorage:8400/insert/0/prometheus/&quot;
    remote_read:
      - url: &quot;http://vmstorage:8401/select/0/prometheus&quot;
         
    scrape_configs:
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https 
   
    - job_name: 'kubernetes-cadvisor'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        #ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      #bearer_token: monitoring
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics/cadvisor
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM
        action:        keep
      metric_relabel_configs:
      - source_labels: [container]
        regex: (.+)
        target_label: container_name
        replacement: $1
        action: replace
      - source_labels: [pod]
        regex: (.+)
        target_label: pod_name
        replacement: $1
        action: replace
    
    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        #ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      #bearer_token: monitoring
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM
        action:        keep
      metric_relabel_configs:
      - source_labels: [container]
        regex: (.+)
        target_label: container_name
        replacement: $1
        action: replace
      - source_labels: [pod]
        regex: (.+)
        target_label: pod_name
        replacement: $1
        action: replace

    - job_name: 'kubernetes-service-endpoints'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - monitoring
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name

    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

    - job_name: 'ingress-nginx-endpoints'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - nginx-ingress
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2

    - job_name: 'node_exporter'
      consul_sd_configs:
      - server: 'consul_server:8500'
      relabel_configs:
          - source_labels: [__address__]
          modulus:       10
          target_label:  __tmp_hash
          action:        hashmod
          - source_labels: [__tmp_hash]
          regex:         ID_NUM
          action:        keep
          - source_labels: [__tmp_hash]
          regex:       '(.*)'
          replacement: '${1}'
          target_label: hash_num
          - source_labels: [__meta_consul_tags]
          regex: .*test.*
          action: drop
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){0}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){1}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){2}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){3}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){4}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){5}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){6}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'
          - source_labels: [__meta_consul_tags]
          regex: ',(?:[^,]+,){7}([^=]+)=([^,]+),.*'
          replacement: '${2}'
          target_label: '${1}'

    - job_name: 'è‡ªå®šä¹‰ä¸šåŠ¡ç›‘æ§'
      proxy_url: http://127.0.0.1:8888   #æ ¹æ®ä¸šåŠ¡å±æ€§
      scrape_interval: 5s
      metrics_path: '/'  #æ ¹æ®ä¸šåŠ¡æä¾›è·¯å¾„
      params:   ##æ ¹æ®ä¸šåŠ¡å±æ€§æ˜¯å¦å¸¦æœ‰
        method: ['get']  
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_name_label]
        action: keep
        regex: monitor  #ä¸šåŠ¡è‡ªå®šä¹‰label
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_pod_name]
        action: keep
        regex: (.*)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
</code></pre>
<h2 id="è‡ªå®šä¹‰ä¸šåŠ¡æ‹‰å–æ ‡è¯†å¯é›†æˆcicd">è‡ªå®šä¹‰ä¸šåŠ¡æ‹‰å–æ ‡è¯†(å¯é›†æˆCICD)</h2>
<pre><code>  template:
    metadata:
      annotations:
        prometheus.io/port: &quot;port&quot; #ä¸šåŠ¡ç«¯å£
        prometheus.io/scrape: &quot;true&quot;
        prometheus.name/label: monitor  #è‡ªå®šä¹‰æ ‡ç­¾
</code></pre>
<h2 id="hashmodé…ç½®æ–¹å¼">hashmodé…ç½®æ–¹å¼ï¼š</h2>
<h3 id="1é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼">1.é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼</h3>
<p>Dockerfile:</p>
<pre><code>FROM  prometheus/prometheus:2.20.0
MAINTAINER name gecailong

COPY ./entrypoint.sh /bin

ENTRYPOINT [&quot;/bin/entrypoint.sh&quot;]
</code></pre>
<p>entrypoint.shï¼š</p>
<pre><code>#!/bin/sh

ID=${POD_NAME##*-}

cp /etc/prometheus/prometheus.yml /prometheus/prometheus-hash.yml

sed -i &quot;s/ID_NUM/$ID/g&quot; /prometheus/prometheus-hash.yml

/bin/prometheus --config.file=/prometheus/prometheus-hash.yml --query.max-concurrency=20 --storage.tsdb.path=/prometheus --storage.tsdb.max-block-duration=2h --storage.tsdb.min-block-duration=2h  --storage.tsdb.retention=2h --web.listen-address=:9090 --web.enable-lifecycle --web.enable-admin-api
</code></pre>
<p><strong>IDNUMï¼š ä¸ºæˆ‘ä»¬åé¢é…ç½®åšå‡†å¤‡_</strong></p>
<h3 id="2prometheuséƒ¨ç½²">2.Prometheuséƒ¨ç½²</h3>
<p>Prometheusé…ç½®æ–‡ä»¶:</p>
<pre><code>  prometheus.yml: |
      external_labels:
         monitor: 'k8s-sh-prod'
         service: 'k8s-all'
         ID: 'ID_NUM'
         ...
</code></pre>
<p>è¿™ä¸ªIDæ˜¯ä¸ºäº†æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥åŒºåˆ†åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºç­‰ä¸‹hashmodæ¨¡å—çš„å¯¹åº”å€¼<br>
éƒ¨ç½²æ–‡ä»¶:</p>
<pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
  name: prometheus-sts
  namespace: monitoring
spec:
  serviceName: &quot;prometheus&quot;
  replicas: 10 #hashmodæ€»æ¨¡å—æ•°
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - image: gecailong/prometheus-hash:0.0.1
        name: prometheus
        securityContext:
           runAsUser: 0
        command:
        - &quot;/bin/entrypoint.sh&quot;
        env:
        - name: POD_NAME  #æ ¹æ®statefulsetçš„ç‰¹æ€§ä¼ å…¥PODåç§°ç”¨äºæ¨¡å—å–å€¼
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
        volumeMounts:
        - mountPath: &quot;/etc/prometheus&quot;
          name: config-volume
        - mountPath: &quot;/prometheus&quot;
          name: data
        resources:
          requests:
            cpu: 500m
            memory: 1000Mi
          limits:
            memory: 2000Mi
      - image: gecailong/prometheus-thanos:v0.17.1
        name: sidecar
        imagePullPolicy: IfNotPresent
        args:
        - &quot;sidecar&quot;
        - &quot;--grpc-address=0.0.0.0:10901&quot;
        - &quot;--grpc-grace-period=1s&quot;
        - &quot;--http-address=0.0.0.0:10902&quot;
        - &quot;--http-grace-period=1s&quot;
        - &quot;--prometheus.url=http://127.0.0.1:9090&quot;
        - &quot;--tsdb.path=/prometheus&quot;
        - &quot;--log.level=info&quot;
        - &quot;--objstore.config-file=/etc/prometheus/bucket.yaml&quot;
        ports:
        - name: http-sidecar
          containerPort: 10902
        - name: grpc-sidecar
          containerPort: 10901
        volumeMounts:
        - mountPath: &quot;/etc/prometheus&quot;
          name: config-volume
        - mountPath: &quot;/prometheus&quot;
          name: data
      serviceAccountName: prometheus
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      imagePullSecrets: 
        - name: regsecret
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-config
      - name: data
        hostPath:
          path: /data/prometheus
</code></pre>
<h1 id="æ•°æ®èšåˆ">æ•°æ®èšåˆ</h1>
<p>Thanosæˆ‘ä»¬ä»18å¹´ä¸€å¼€å§‹å°±ç”¨çš„å®ƒï¼Œè™½ç„¶ä¸€å¼€å§‹çš„ç‰ˆæœ¬æœ‰å¾ˆå¤šbugä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šå›°æ‰°,åŒæ—¶æˆ‘ä»¬ä¹Ÿæäº†å¾ˆå¤šçš„issueï¼Œæ…¢æ…¢çš„ç¨³å®šä¹‹åï¼Œæˆ‘ä»¬åœ¨æ­¤ä¹‹å‰çº¿ä¸Šéƒ½æ˜¯ä½¿ç”¨v0.2.1ç‰ˆæœ¬è¿›è¡Œçº¿ä¸Šé•¿æœŸä½¿ç”¨,æœ€æ–°çš„ç‰ˆæœ¬å·²ç»å»é™¤äº†åŸºäºgrpc clusteræœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼ŒUIä¹Ÿæ›´åŠ çš„ä¸°å¯Œã€‚ğŸ˜€æˆ‘ä»¬ä¹Ÿè¿›è¡Œäº†ç›‘æ§å¹³å°æ¶æ„é‡æ„<br>
æˆ‘ä»¬æ•°æ®èšåˆé‡‡ç”¨Thanosè¿›è¡ŒæŸ¥è¯¢æ•°æ®èšåˆï¼ŒåŒæ—¶åé¢æˆ‘ä»¬æåˆ°çš„æ•°æ®å­˜å‚¨ç»„ä»¶victoriametricsä¹Ÿå¯ä»¥å®ç°æ•°æ®èšåˆçš„åŠŸèƒ½ï¼Œé’ˆå¯¹Thanosï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒçš„å‡ ä¸ªå­ç»„ä»¶ï¼šqueryã€sidecarã€ruleï¼Œè‡³äºå…¶ä»–çš„ç»„ä»¶å¦‚compactã€storeã€bucketç­‰ä¾æ®è‡ªå·±çš„ä¸šåŠ¡æ²¡æœ‰è¿›è¡Œä½¿ç”¨.<br>
æˆ‘ä»¬çš„Thanos+Prometheusçš„æ¶æ„å›¾å·²åœ¨å¼€å¤´å±•ç¤ºï¼Œä»¥ä¸‹ä»…ç»™å‡ºéƒ¨ç½²å’Œæ³¨æ„äº‹é¡¹:<br>
Thanosç»„ä»¶éƒ¨ç½²:<br>
sidecar:(æˆ‘ä»¬é‡‡ç”¨å’ŒPrometheusæ”¾åœ¨åŒä¸€POD)</p>
<pre><code>      - image: gecailong/prometheus-thanos:v0.17.1
        name: thanos
        imagePullPolicy: IfNotPresent
        args:
        - &quot;sidecar&quot;
        - &quot;--grpc-address=0.0.0.0:10901&quot;
        - &quot;--grpc-grace-period=1s&quot;
        - &quot;--http-address=0.0.0.0:10902&quot;
        - &quot;--http-grace-period=1s&quot;
        - &quot;--prometheus.url=http://127.0.0.1:9090&quot;
        - &quot;--tsdb.path=/prometheus&quot;
        - &quot;--log.level=info&quot;
        - &quot;--objstore.config-file=/etc/prometheus/bucket.yaml&quot;
        ports:
        - name: http-sidecar
          containerPort: 10902
        - name: grpc-sidecar
          containerPort: 10901
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - mountPath: &quot;/etc/prometheus&quot;
          name: config-volume
        - mountPath: &quot;/prometheus&quot;
          name: data
</code></pre>
<p>queryç»„ä»¶éƒ¨ç½²:</p>
<pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: query
  name: thanos-query
  namespace: monitoring
spec:
  replicas: 3
  selector:
    matchLabels:
      app: query
  template:
    metadata:
      labels:
        app: query
    spec:
      containers:
      - image: gecailong/prometheus-thanos:v0.17.1
        name: query
        imagePullPolicy: IfNotPresent
        args:
        - &quot;query&quot;
        - &quot;--http-address=0.0.0.0:19090&quot;
        - &quot;--grpc-address=0.0.0.0:10903&quot;
        - &quot;--store=dnssrv+_grpc._tcp.prometheus-sidecar-svc.monitoring.svc.cluster.local&quot;
        - &quot;--store=dnssrv+_grpc._tcp.sidecar-query.monitoring.svc.cluster.local&quot;
        - &quot;--store=dnssrv+_grpc._tcp.sidecar-rule.monitoring.svc.cluster.local&quot;
        ports:
        - name: http-query
          containerPort: 19090
        - name: grpc-query
          containerPort: 10903
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
</code></pre>
<p>ruleç»„ä»¶éƒ¨ç½²:</p>
<pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: query
  name: thanos-rule
  namespace: monitoring
spec:
  replicas: 2
  serviceName: &quot;sidecar-rule&quot;
  selector:
    matchLabels:
      app: rule
  template:
    metadata:
      labels:
        app: rule
    spec:
      containers:
      - image: gecailong/prometheus-thanos:v0.17.1
        name: rule
        imagePullPolicy: IfNotPresent
        args:
        - &quot;rule&quot;
        - &quot;--http-address=0.0.0.0:10902&quot;
        - &quot;--grpc-address=0.0.0.0:10901&quot;
        - &quot;--data-dir=/data&quot;
        - &quot;--rule-file=/prometheus-rules/*.yaml&quot;
        - &quot;--alert.query-url=http://sidecar-query:19090&quot;
        - &quot;--alertmanagers.url=http://alertmanager:9093&quot;
        - &quot;--query=http://sidecar-query:19090&quot;
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - mountPath: &quot;/prometheus-rules&quot;
          name: config-volume
        - mountPath: &quot;/data&quot;
          name: data
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            memory: 1500Mi
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-rule
      - name: data
        hostPath:
          path: /data/prometheus
</code></pre>
<p>ruleé€šç”¨å‘Šè­¦è§„åˆ™å’Œé…ç½®:</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rule
  namespace: monitoring
data:
  k8s_cluster_rule.yaml: |+
    groups:
    - name: pod_etcd_monitor
      rules:
      - alert: pod_etcd_num_is_changing
        expr: sum(kube_pod_info{pod=~&quot;etcd.*&quot;})by(monitor) &lt; 3
        for: 1m
        labels:
          level: high
          service: etcd
        annotations:
          summary: &quot;é›†ç¾¤:{{ $labels.monitor }},etcdé›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&quot;
          description: &quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&quot;
    - name: pod_scheduler_monitor
      rules:
      - alert: pod_scheduler_num_is_changing
        expr: sum(kube_pod_info{pod=~&quot;kube-scheduler.*&quot;})by(monitor) &lt; 3
        for: 1m
        labels:
          level: high
          service: scheduler
        annotations:
          summary: &quot;é›†ç¾¤:{{ $labels.monitor }},scheduleré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&quot;
          description: &quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&quot;
    - name: pod_controller_monitor
      rules:
      - alert: pod_controller_num_is_changing
        expr: sum(kube_pod_info{pod=~&quot;kube-controller-manager.*&quot;})by(monitor) &lt; 3
        for: 1m
        labels:
          level: high
          service: controller
        annotations:
          summary: &quot;é›†ç¾¤:{{ $labels.monitor }},controlleré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&quot;
          description: &quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&quot;
    - name: pod_apiserver_monitor
      rules:
      - alert: pod_apiserver_num_is_changing
        expr: sum(kube_pod_info{pod=~&quot;kube-apiserver.*&quot;})by(monitor) &lt; 3
        for: 1m
        labels:
          level: high
          service: controller
        annotations:
          summary: &quot;é›†ç¾¤:{{ $labels.monitor }},apiserveré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&quot;
          description: &quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&quot;

  k8s_master_resource_rules.yaml: |+
    groups:
    - name: node_cpu_resource_monitor
      rules:
      - alert: èŠ‚ç‚¹CPUä½¿ç”¨é‡
        expr:  sum(kube_pod_container_resource_requests_cpu_cores{node=~&quot;.*&quot;})by(node)/sum(kube_node_status_capacity_cpu_cores{node=~&quot;.*&quot;})by(node)&gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„CPUä½¿ç”¨æ ¸æ•°å·²ç»è¶…è¿‡äº†70%&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot;
    - name: node_memory_resource_monitor
      rules:
      - alert: èŠ‚ç‚¹å†…å­˜ä½¿ç”¨é‡
        expr:  sum(kube_pod_container_resource_limits_memory_bytes{node=~&quot;.*&quot;})by(node)/sum(kube_node_status_capacity_memory_bytes{node=~&quot;.*&quot;})by(node)&gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„memoryä½¿ç”¨æ ¸æ•°å·²ç»è¶…è¿‡äº†70%&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot;
    - name: èŠ‚ç‚¹PODä½¿ç”¨ç‡
      rules:
      - alert: èŠ‚ç‚¹podä½¿ç”¨ç‡
        expr: sum by(node,monitor) (kube_pod_info{node=~&quot;.*&quot;}) / sum by(node,monitor) (kube_node_status_capacity_pods{node=~&quot;.*&quot;})&gt; 0.9
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„PODä½¿ç”¨æ•°é‡å·²ç»è¶…è¿‡äº†90%&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot;      
    - name: master_cpu_used
      rules:
      - alert: ä¸»èŠ‚ç‚¹CPUä½¿ç”¨ç‡
        expr:  sum(kube_pod_container_resource_limits_cpu_cores{node=~'master.*'})by(node)/sum(kube_node_status_capacity_cpu_cores{node=~'master.*'})by(node)&gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„CPUç”³è¯·æ ¸æ•°å·²ç»è¶…è¿‡äº†0.7,å½“å‰å€¼ä¸º{{ $value }}!&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot; 
    - name: master_memory_resource_monitor
      rules:
      - alert: ä¸»èŠ‚ç‚¹å†…å­˜ä½¿ç”¨ç‡
        expr:  sum(kube_pod_container_resource_limits_memory_bytes{node=~'master.*'})by(node)/sum(kube_node_status_capacity_memory_bytes{node=~'master.*'})by(node)&gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„å†…å­˜ä½¿ç”¨é‡å·²ç»è¶…è¿‡äº†70%&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot;
    - name: master_pod_resource_monitor
      rules:
      - alert: ä¸»èŠ‚ç‚¹PODä½¿ç”¨ç‡
        expr: sum(kube_pod_info{node=~&quot;master.*&quot;}) by (node) / sum(kube_node_status_capacity_pods{node=~&quot;master.*&quot;}) by (node)&gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„PODä½¿ç”¨æ•°é‡å·²ç»è¶…è¿‡äº†70%&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&quot;     
  k8s_node_rule.yaml: |+
    groups:
    - name: K8sNodeMonitor
      rules:
      - alert: é›†ç¾¤èŠ‚ç‚¹èµ„æºç›‘æ§
        expr: kube_node_status_condition{condition=~&quot;OutOfDisk|MemoryPressure|DiskPressure&quot;,status!=&quot;false&quot;} ==1
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤èŠ‚ç‚¹å†…å­˜æˆ–ç£ç›˜èµ„æºçŸ­ç¼º&quot;
          description: &quot;èŠ‚ç‚¹:{{ $labels.node }},é›†ç¾¤:{{ $labels.monitor }},åŸå› :{{ $labels.condition }}&quot;
      - alert: é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ç›‘æ§
        expr: sum(kube_node_status_condition{condition=&quot;Ready&quot;,status!=&quot;true&quot;})by(node)  == 1
        for: 2m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€å‡ºç°é”™è¯¯&quot;
          description: &quot;èŠ‚ç‚¹:{{ $labels.node }},é›†ç¾¤:{{ $labels.monitor }}&quot;
      - alert: é›†ç¾¤PODçŠ¶æ€ç›‘æ§
        expr: sum (kube_pod_container_status_terminated_reason{reason!~&quot;Completed|Error&quot;})  by (pod,reason) ==1
        for: 1m
        labels:
          level: high
          service: pod
        annotations:
          summary: &quot;é›†ç¾¤podçŠ¶æ€å‡ºç°é”™è¯¯&quot;
          description: &quot;é›†ç¾¤:{{ $labels.monitor }},åç§°:{{ $labels.pod }},åŸå› :{{ $labels.reason}}&quot;
      - alert: é›†ç¾¤èŠ‚ç‚¹CPUä½¿ç”¨ç›‘æ§
        expr:  sum(node_load1) BY (instance) / sum(rate(node_cpu_seconds_total[1m])) BY (instance) &gt; 2
        for: 5m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;æœºå™¨å‡ºç°cpuå¹³å‡è´Ÿè½½è¿‡é«˜&quot;
          description: &quot;èŠ‚ç‚¹: {{ $labels.instance }}å¹³å‡æ¯æ ¸å¤§äº2&quot;
      - alert: NodeMemoryOver80Percent
        expr:  (1 - avg by (instance)(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))* 100 &gt;85
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &quot;æœºå™¨å‡ºç°å†…å­˜ä½¿ç”¨è¶…è¿‡85%&quot;
          description: &quot;èŠ‚ç‚¹: {{ $labels.instance }}&quot;
  k8s_pod_rule.yaml: |+
    groups:
      - name: pod_status_monitor
        rules:
        - alert: podé”™è¯¯çŠ¶æ€ç›‘æ§
          expr: changes(kube_pod_status_phase{phase=~&quot;Failed&quot;}[5m]) &gt;0
          for: 1m
          labels:
            level: high
            service: pod-failed
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€å¼‚å¸¸&quot;
            description: &quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.phase}}&quot;
        - alert: podå¼‚å¸¸çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_status_phase{phase=&quot;Pending&quot;})by(namespace,pod,phase)&gt;0
          for: 3m
          labels:
            level: high
            service: pod-pending
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€peningå¼‚å¸¸è¶…10åˆ†é’Ÿ&quot;
            description: &quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.phase}}&quot;
        - alert: podç­‰å¾…çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_container_status_waiting_reason{reason!=&quot;ContainerCreating&quot;})by(namespace,pod,reason)&gt;0
          for: 1m
          labels:
            level: high
            service: pod-wait
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€Waitå¼‚å¸¸è¶…5åˆ†é’Ÿ&quot;
            description: &quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.reason}}&quot;
        - alert: podéæ­£å¸¸çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_container_status_terminated_reason)by(namespace,pod,reason)&gt;0
          for: 1m
          labels:
            level: high
            service: pod-nocom
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€Terminatedå¼‚å¸¸è¶…5åˆ†é’Ÿ&quot;
            description: &quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.reason}}&quot;
        - alert: podé‡å¯ç›‘æ§
          expr: changes(kube_pod_container_status_restarts_total[20m])&gt;3
          for: 3m
          labels:
            level: high
            service: pod-restart
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podåŠå°æ—¶ä¹‹å†…é‡å¯æ¬¡æ•°è¶…è¿‡3æ¬¡!&quot;
            description: &quot;pod:{{$labels.pod}}&quot;
      - name: deployment_replicas_monitor
        rules:
        - alert: deploymentç›‘æ§
          expr: sum(kube_deployment_status_replicas_unavailable)by(namespace,deployment) &gt;2
          for: 3m
          labels:
            level: high
            service: deployment-replicas
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }},deployment:{{$labels.deployment}} å‰¯æœ¬æ•°æœªè¾¾åˆ°æœŸæœ›å€¼! &quot;
            description: &quot;ç©ºé—´:{{$labels.namespace}}ï¼Œå½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&quot;
      - name: daemonset_replicas_monitor
        rules:
        - alert: Daemonsetç›‘æ§
          expr: sum(kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled)by(daemonset,namespace) &gt;2
          for: 3m
          labels:
            level: high
            service: daemonset
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }},daemonset:{{$labels.daemonset}} å®ˆæŠ¤è¿›ç¨‹æ•°æœªè¾¾åˆ°æœŸæœ›å€¼!&quot;
            description: &quot;ç©ºé—´:{{$labels.namespace}},å½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&quot;
      - name: satefulset_replicas_monitor
        rules:
        - alert: Satefulsetç›‘æ§
          expr: (kube_statefulset_replicas - kube_statefulset_status_replicas_ready) &gt;2
          for: 3m
          labels:
            level: high
            service: statefulset
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }},statefulset:{{$labels.statefulset}} å‰¯æœ¬æ•°æœªè¾¾åˆ°æœŸæœ›å€¼!&quot;
            description: &quot;ç©ºé—´:{{$labels.namespace}}ï¼Œå½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&quot;
      - name: pvc_replicas_monitor
        rules:
        - alert: PVCç›‘æ§
          expr: kube_persistentvolumeclaim_status_phase{phase!=&quot;Bound&quot;} == 1
          for: 5m
          labels:
            level: high
            service: pvc
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }},statefulset:{{$labels.persistentvolumeclaim}} å¼‚å¸¸æœªboundæˆåŠŸ!&quot;
            description: &quot;pvcå‡ºç°å¼‚å¸¸&quot;
      - name: K8sClusterJob
        rules:	  
        - alert: é›†ç¾¤JOBçŠ¶æ€ç›‘æ§
          expr: sum(kube_job_status_failed{job=&quot;kubernetes-service-endpoints&quot;,k8s_app=&quot;kube-state-metrics&quot;})by(job_name) ==1
          for: 1m
          labels:
            level: disaster
            service: job
          annotations:
            summary: &quot;é›†ç¾¤å­˜åœ¨æ‰§è¡Œå¤±è´¥çš„Job&quot;
            description: &quot;é›†ç¾¤:{{ $labels.monitor }},åç§°:{{ $labels.job_name }}&quot;
      - name: pod_container_cpu_resource_monitor
        rules:
        - alert: å®¹å™¨å†…cpuå ç”¨ç›‘æ§
          expr: namespace:container_cpu_usage_seconds_total:sum_rate / sum(kube_pod_container_resource_limits_cpu_cores) by (monitor,namespace,pod_name)&gt; 0.8
          for: 1m
          labels:
            level: high
            service: container_cpu
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }} å‡ºç°Pod CPUä½¿ç”¨ç‡å·²ç»è¶…è¿‡ç”³è¯·é‡çš„80%,&quot;
            description: &quot;namespace:{{$labels.namespace}}çš„pod:{{$labels.pod}},å½“å‰å€¼ä¸º{{ $value }}&quot;
        - alert: å®¹å™¨å†…memå ç”¨ç›‘æ§
          expr: namespace:container_memory_usage_bytes:sum/ sum(kube_pod_container_resource_limits_memory_bytes)by(monitor,namespace,pod_name) &gt; 0.8
          for: 2m
          labels:
            level: high
            service: container_mem
          annotations:
            summary: &quot;é›†ç¾¤:{{ $labels.monitor }} å‡ºç°Pod memoryä½¿ç”¨ç‡å·²ç»è¶…è¿‡ç”³è¯·é‡çš„90%&quot;
            description: &quot;namespace:{{$labels.namespace}}çš„pod:{{$labels.pod}},å½“å‰å€¼ä¸º{{ $value }}&quot;
        
  redis_rules.yaml: |+
    groups:
    - name: k8s_container_rule
    rules:
    - expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (monitor,namespace,pod_name)
        record: namespace:container_cpu_usage_seconds_total:sum_rate
    - expr: sum(container_memory_usage_bytes{container_name=&quot;POD&quot;}) by (monitor,namespace,pod_name)
        record: namespace:container_memory_usage_bytes:sum
</code></pre>
<p><code>æ³¨æ„: å› ä¸ºç»„ä»¶éƒ½åœ¨åŒä¸€é›†ç¾¤æˆ‘ä»¬é‡‡ç”¨dnssrvçš„æ–¹å¼è¿›è¡Œå‘ç°å…¶ä»–ç»„ä»¶èŠ‚ç‚¹ï¼Œå…¶å®å¯¹äºå®¹å™¨å†…éƒ¨çš„dnssrvæ–¹ä¾¿å¾ˆå¤šï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ‰€éœ€è¦çš„headless service å¹¶ä¸”ä½¿ç”¨dns srvçš„è¯ï¼Œéœ€è¦è®¾ç½® clusterIP: None å³å¯.</code><br>
thanos-query-svc:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: query
  name: sidecar-query
spec:
  ports:
  - name: web
    port: 19090
    protocol: TCP
    targetPort: 19090
  selector:
    app: query
</code></pre>
<p>thanos-rule-svc:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: rule
  name: sidecar-rule
spec:
  clusterIP: None
  ports:
  - name: web
    port: 10902
    protocol: TCP
    targetPort: 10902
  - name: grpc
    port: 10901
    protocol: TCP
    targetPort: 10901
  selector:
    app: rule
</code></pre>
<p>prometheus+sidecar:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: prometheus
  name: prometheus-sidecar-svc
spec:
  clusterIP: None
  ports:
  - name: web
    port: 9090
    protocol: TCP
    targetPort: 9090
  - name: grpc
    port: 10901
    protocol: TCP
    targetPort: 10901
  selector:
    app: prometheus
</code></pre>
<p>æ•ˆæœå›¾:<br>
podæŒ‡æ ‡ç›‘æ§å¤šé›†ç¾¤ç¤ºä¾‹:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861801737.png" alt="" loading="lazy"><br>
ç›‘æ§å‘Šè­¦è§„åˆ™ç¤ºä¾‹:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861838781.png" alt="" loading="lazy"><br>
Thanosé¦–é¡µ:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861846507.png" alt="" loading="lazy"></p>
<h1 id="æ•°æ®å­˜å‚¨">æ•°æ®å­˜å‚¨</h1>
<p>å¯¹äºPrometheusçš„æ•°æ®å­˜å‚¨æˆ‘ä»¬ä¹Ÿèµ°äº†å¾ˆå¤šçš„å¼¯è·¯..</p>
<ul>
<li>å¯¹äºå¼€å§‹æˆ‘ä»¬ä½¿ç”¨è¿‡influxdbæœ€ç»ˆå› ä¸ºé›†ç¾¤ç‰ˆé—®é¢˜æ”¾å¼ƒäº†ï¼Œä¹Ÿè¯•è¿‡é‡å†™Prometheus-adapteræ¥å…¥opentsdb,åæ¥å› ä¸ºéƒ¨åˆ†é€šé…ç¬¦ç»´æŠ¤éš¾é—®é¢˜ä¹Ÿæ”¾å¼ƒäº†(å…¶å®è¿˜æ˜¯tcollecterçš„æœé›†é—®é¢˜æ”¾å¼ƒçš„)ï¼Œæˆ‘ä»¬ä¹Ÿå°è¯•è¿‡ç”¨Thanos-store S3æ‰“å…¥cephå› ä¸ºå‰¯æœ¬é—®é¢˜æˆæœ¬å¤ªé«˜ï¼Œä¹Ÿæ‰“å…¥è¿‡é˜¿é‡Œäº‘çš„OSS,å­˜çš„å¤š ä½†æ˜¯å–æ•°æ®æˆäº†ä¸€ä¸ªé—®é¢˜ã€‚åé¢æˆ‘ä»¬è¿æ¥äº†victoriametricsï¼ŒåŸºæœ¬ä¸Šèƒ½è§£å†³æˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä¸»è¦é—®é¢˜ã€‚<br>
æ¶æ„:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861859014.png" alt="" loading="lazy"></li>
</ul>
<p>victoriametrics æœ¬èº«æ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå¯¹äºè¿™æ ·ä¸€ä¸ªè¿œç«¯å­˜å‚¨ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å•ç‹¬ä½œä¸ºPrometheusæ•°æ®æºæŸ¥è¯¢ä½¿ç”¨ã€‚<br>
ä¼˜åŠ¿:<br>
1.å…·æœ‰è¾ƒé«˜çš„å‹ç¼©æ¯”å’Œé«˜æ€§èƒ½<br>
2.å¯ä»¥æä¾›å’ŒPrometheusåŒç­‰çš„æ•°æ®æºå±•ç¤º<br>
3.æ”¯æŒmetricsqlåŒæ—¶æŸ¥è¯¢æ—¶è¿›è¡Œç›¸åŒmeitricsæ•°æ®èšåˆ<br>
4.å¼€æºçš„é›†ç¾¤ç‰ˆæœ¬(ç®€ç›´æ— æ•Œ)<br>
å¯¹äºvictoriametricsæˆ‘ä»¬åšè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œç›¸åŒçš„æ•°æ®åœ¨å’ŒPrometheusåŸæœ‰æ•°æ®å¯¹æ¯”ä¸­<br>
å†…å­˜å¤§æ¦‚å‡å°‘50%ï¼ŒCPUèŠ‚çœè¶…40%ï¼Œç£ç›˜å ç”¨å‡å°‘çº¦40%.å¹¶ä¸”æˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼åˆ†ç¦»äº†å†™å…¥å’Œè¯»å–çš„é€šé“é¿å…äº†æ–°è€æ•°æ®å…±å­˜å†…å­˜é€ æˆçš„å¤§å†…å­˜å’ŒOOMé—®é¢˜ï¼Œä¹ŸåŒæ—¶æä¾›äº†ä¸€ä¸ªé•¿æœŸæ•°æ®å­˜å‚¨çš„æˆæœ¬æ–¹æ¡ˆ<br>
victoriametricséƒ¨ç½²:<br>
vminsertéƒ¨ç½²:</p>
<pre><code>apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitor-vminsert
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vminsert: online
  template:
    metadata:
      labels:
        vminsert: online
    spec:
      containers:
      - args:
        - -storageNode=vmstorage:8400
        image: victoriametrics/vminsert:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vminsert
        ports:
        - containerPort: 8480
          name: vminsert
          protocol: TCP
      dnsPolicy: ClusterFirst
      hostNetwork: true
      nodeSelector:
        vminsert: online
      restartPolicy: Always
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
</code></pre>
<p>vmselectéƒ¨ç½²:</p>
<pre><code>apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitor-vmselect
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vmselect: online
  template:
    metadata:
      labels:
        vmselect: online
    spec:
      containers:
      - args:
        - -storageNode=vmstorage:8400
        image: victoriametrics/vmselect:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vmselect
        ports:
        - containerPort: 8481
          name: vmselect
          protocol: TCP
      dnsPolicy: ClusterFirst
      hostNetwork: true
      nodeSelector:
        vmselect: online
      restartPolicy: Always
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
</code></pre>
<p>vmstorageéƒ¨ç½²:</p>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: monitor-vmstorage
spec:
  replicas: 10
  serviceName: vmstorage
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vmstorage: online
  template:
    metadata:
      labels:
        vmstorage: online
    spec:
      containers:
      - args:
        - --retentionPeriod=1
        - --storageDataPath=/storage
        image: victoriametrics/vmstorage:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vmstorage
        ports:
        - containerPort: 8482
          name: http
          protocol: TCP
        - containerPort: 8400
          name: vminsert
          protocol: TCP
        - containerPort: 8401
          name: vmselect
          protocol: TCP
        volumeMounts:
        - mountPath: /data
          name: data
      hostNetwork: true
      nodeSelector:
        vmstorage: online
      restartPolicy: Always
      volumes:
      - hostPath:
          path: /data/vmstorage
          type: &quot;&quot;
        name: data
</code></pre>
<p>vmstorage-svc (æä¾›æ¥å£ä¾›æŸ¥è¯¢ã€å†™å…¥):</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    vmstorage: staging
  name: vmstorage
spec:
  ports:
  - name: http
    port: 8482
    protocol: TCP
    targetPort: http
  - name: vmselect
    port: 8401
    protocol: TCP
    targetPort: vmselect
  - name: vminsert
    port: 8400
    protocol: TCP
    targetPort: vminsert
  selector:
    vmstorage: staging
  type: NodePort

</code></pre>
<p>vminsert-svc</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    vminsert: online
  name: monitor-vminsert
spec:
  ports:
  - name: vminsert
    port: 8480
    protocol: TCP
    targetPort: vminsert
  selector:
    vminsert: online
  type: NodePort
</code></pre>
<p>vmselet-svc</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    vmselect: online
  name: monitor-vmselect
spec:
  ports:
  - name: vmselect
    port: 8481
    protocol: TCP
    targetPort: vmselect
  selector:
    vmselect: online
  type: NodePort
</code></pre>
<p>è¿›è¡Œéƒ¨ç½²å®Œæˆåéœ€è¦ä¿®æ”¹Prometheusé…ç½®è¿›è¡Œå†™å…¥å’ŒæŸ¥è¯¢æ”¯æŒ</p>
<pre><code>    remote_write:
      - url: &quot;http://vmstorage:8400/insert/0/prometheus/&quot;
    remote_read:
      - url: &quot;http://vmstorage:8401/select/0/prometheus&quot;
</code></pre>
<p>grafanaæ•°æ®æºé…ç½®:</p>
<pre><code>é€‰æ‹©æ•°æ®æºç±»å‹: Prometheus
http://vmstorage:8401/select/0/prometheus
</code></pre>
<p>æ•ˆæœå›¾:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861894002.png" alt="" loading="lazy"></p>
<h1 id="å‘Šè­¦ä¿¡æ¯">å‘Šè­¦ä¿¡æ¯</h1>
<p><code>å‘Šè­¦è§„åˆ™éƒ½æ˜¯ç”±thanos ruleæ¨é€è‡³alertmanager</code><br>
å‘Šè­¦é‡‡ç”¨çš„æ—¶alertmanagerè¿›è¡Œå‘Šè­¦,åŒæ—¶æ­é…è‡ªå·±çš„å‘Šè­¦å¹³å°è¿›è¡Œå‘Šè­¦çš„åˆ†å‘.<br>
åœ¨é…ç½®ä¸­æˆ‘ä»¬æŒ‰ç…§alertnameå’Œmonitorè¿›è¡Œåˆ†ç»„,å¯ä»¥å®ç°ç›¸åŒalert nameä¸‹çš„æ‰€æœ‰å‘Šè­¦åˆ†æˆä¸€ä¸ªç»„ï¼Œè¿›è¡ŒåŸºäºPrometheusçš„èšåˆå‘Šè­¦ï¼ŒåŒæ—¶å› ä¸ºç°ç½‘PODè¾ƒå¤šï¼Œå¦‚å‘ç”Ÿå¤§è§„æ¨¡PODå¼‚å¸¸è¿›è¡Œèšåˆæ—¶æ•°æ®è¾ƒå¤§ï¼Œå•ç‹¬åˆ†ç±»ã€‚æ•ˆæœå¦‚åé¢å±•ç¤º<br>
å‘Šè­¦é™é»˜é…ç½®:å› ä¸ºç°ç½‘å‘Šè­¦éƒ½åœ¨labelä¸­å®šä¹‰äº†å‘Šè­¦çº§åˆ«(warningã€highã€disaster)çº§åˆ«,å¯¹äºæœ€ä½çº§åˆ«çš„å‘Šè­¦æˆ‘ä»¬é»˜è®¤ä¸èµ°å‘Šè­¦å¹³å°ï¼Œæ ¹æ®å‘Šè­¦çš„ç­‰çº§å’Œå‘Šè­¦è§„åˆ™è¿›è¡Œé™é»˜ã€‚<br>
ä¾‹:<br>
1.åŒmonitoré›†ç¾¤ä¸‹æŸä¸€ä¸ªalertnameæŒ‰ç…§instanceè¿›è¡Œé™é»˜ï¼Œ<br>
2.å¯¹äºå¤§é‡PODå‘Šè­¦æˆ‘ä»¬åŸºäºPODå‘Šè­¦ç±»å‹è¿›è¡Œé™é»˜<br>
ç¬¬ä¸€æ¬¡å‘Šè­¦æ—¶ä¼šæ ¹æ®åˆ†ç»„èšåˆä¿¡æ¯è¿›è¡Œæ‰€æœ‰å‘Šè­¦ä¿¡æ¯æ¨é€<br>
alertmanageré…ç½®:</p>
<pre><code>global:
  smtp_smarthost: 'mail.xxxxxxx.com:25'
  smtp_from: 'xxxxxxx@xxxxxxx.com'
  smtp_auth_username: 'xxxxxxx@xxxxxxx.com'
  smtp_auth_password: 'xxxxxxx'
  smtp_require_tls: false

route:
  group_by: ['alertname','pod','monitor']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 6h
  receiver: 'webhook'

  routes:
  - receiver: 'mail'
    match:
      level: warning

receivers:
- name: 'mail'
  email_configs:
  - to: 'amend@xxxxx.com,amend2@xxxxx.com'
    send_resolved: true

- name: 'webhook'
  webhook_configs:
  - url: 'http://alert.xxx.com/alert/prometheus'
    send_resolved: true
inhibit_rules:
  - source_match:
      level: 'disaster'
    target_match_re:
      level: 'high|disaster'
    equal: ['alertname','instance','monitor']
  - source_match:
      level: 'high'
    target_match_re:
      level: 'high'
    equal: ['alertname','instance','monitor']

</code></pre>
<p>å‘Šè­¦èšåˆä»£ç ç¤ºä¾‹(python):</p>
<pre><code>        try:
            payload = eval(self.request.body)
        except json.decoder.JSONDecodeError:
            raise web.HTTPError(400)
        alert_row = payload['alerts']
        try:
            if len(alert_row) &lt;2:
               description =  alert_row[0]['annotations']['description']
               summary =  alert_row[0]['annotations']['summary']
            else:
               for alert in alert_row:
                   description +=  alert['annotations']['description'] + '\n'
               summary = '[èšåˆå‘Šè­¦] '+ alert_row[0]['annotations']['summary']
        except:
            pass
        try:
            namespace =  alert_row[0]['labels']['namespace']
        except:
            pass

</code></pre>
<p>æ•ˆæœ:<br>
1.å¯¹äºPODçš„ç›‘æ§<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861923719.png" alt="" loading="lazy"><br>
2.å¯¹äºinstanceçº§åˆ«å‘Šè­¦<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861946897.png" alt="" loading="lazy"><br>
3.å¯¹äºä¸šåŠ¡çº§åˆ«å‘Šè­¦<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617861956813.png" alt="" loading="lazy"><br>
æºç å’Œæ¨¡æ¿:<br>
https://github.com/gecailong/K8sMonitor</p>
<p>å‚è€ƒ:<br>
https://github.com/thanos-io/thanos<br>
https://github.com/VictoriaMetrics/VictoriaMetrics<br>
https://github.com/gecailong/K8sMonitor<br>
https://blog.csdn.net/liukuan73/article/details/78881008</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¦‚ä½•é’ˆå¯¹é«˜å†™å…¥ä½æŸ¥è¯¢esé›†ç¾¤ä¼˜åŒ–]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/ru-he-zhen-dui-gao-xie-ru-di-cha-xun-es-ji-qun-you-hua/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/ru-he-zhen-dui-gao-xie-ru-di-cha-xun-es-ji-qun-you-hua/">
        </link>
        <updated>2020-07-22T06:32:41.000Z</updated>
        <summary type="html"><![CDATA[<p>é’ˆå¯¹é«˜å¹¶å‘å†™å…¥çš„æ—¥å¿—é›†ç¾¤ã€å‘Šè­¦é›†ç¾¤åšä»æ—¥å¿—å†™å…¥ã€å¤„ç†ã€é›†ç¾¤ä¼˜åŒ–æé«˜å†™å…¥ååé‡</p>
]]></summary>
        <content type="html"><![CDATA[<p>é’ˆå¯¹é«˜å¹¶å‘å†™å…¥çš„æ—¥å¿—é›†ç¾¤ã€å‘Šè­¦é›†ç¾¤åšä»æ—¥å¿—å†™å…¥ã€å¤„ç†ã€é›†ç¾¤ä¼˜åŒ–æé«˜å†™å…¥ååé‡</p>
<!-- more -->
<p>æ¦‚è¿°:ELKç°åœ¨å·²ç»æˆä¸ºå¤§å¤šæ•°å…¬å¸ä½œä¸ºæ—¥å¿—å­˜å‚¨ã€å‘Šè­¦çš„é€šç”¨è§£å†³æ–¹æ¡ˆ,ç›®å‰æˆ‘ä»¬ç°ç½‘é™¤äº†ä¸šåŠ¡æ—¥å¿—èµ°å¤§æ•°æ®ä¹‹å¤–ï¼Œå…¶ä»–ç»„ä»¶å†…éƒ¨æ”¯æŒçš†ä¸ºelkå­˜å‚¨å‘Šè­¦.<br>
é›†ç¾¤è§„æ¨¡:<br>
esé›†ç¾¤ä¸º 28èŠ‚ç‚¹ æ¯ä¸ªèŠ‚ç‚¹5.5Tç›˜æœºæ¢°ç¡¬ç›˜ å­˜å‚¨æ•°æ®çº¦7å¤©/55T å†™å…¥çº¦12w/s</p>
<h1 id="é«˜å†™å…¥ä½æŸ¥è¯¢é›†ç¾¤">é«˜å†™å…¥ä½æŸ¥è¯¢é›†ç¾¤:</h1>
<p>å‘ç´¢å¼•ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ–‡æ¡£é¦–å…ˆè¢«ä¿å­˜åœ¨å†…å­˜ç¼“å­˜ï¼ˆin-memory bufferï¼‰ä¸­ï¼ŒåŒæ—¶å°†æ“ä½œå†™å…¥åˆ°translogä¸­ï¼Œæ­¤æ—¶è¿™æ¡åˆšæ’å…¥çš„æ–‡æ¡£è¿˜ä¸èƒ½è¢«æœç´¢åˆ°ã€‚é»˜è®¤1ç§’é’Ÿrefreshä¸€æ¬¡ï¼Œrefreshæ“ä½œä¼šå°†æ–‡ä»¶å†™åˆ°æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­ï¼Œå¹¶å½¢æˆä¸€ä¸ªsegmentï¼Œrefreshåæ–‡æ¡£å¯ä»¥è¢«æ£€ç´¢åˆ°ã€‚<br>
å½“flushçš„æ—¶å€™ï¼Œæ‰€æœ‰segmentè¢«åŒæ­¥åˆ°ç£ç›˜ï¼ŒåŒæ—¶æ¸…ç©ºtranslogï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ–°çš„translog,LuceneæŠŠæ¯æ¬¡ç”Ÿæˆçš„å€’æ’ç´¢å¼•å«åšä¸€ä¸ªsegmentï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªsegmentå°±æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•</p>
<p>##æ—¥å¿—æ ¼å¼ä¼˜åŒ–:<br>
æ—¥å¿—æ ¼å¼/å­—æ®µï¼š<br>
æ—¥å¿—æ ¼å¼ç»Ÿä¸€é‡‡JSONï¼Œä¾¿äº ELK è§£æå¤„ç†ã€‚æ—¥å¿—ä¸­çš„å„ä¸ªå­—æ®µçš„å€¼ï¼Œéƒ½åº”è¯¥å°½é‡ä½¿ç”¨ è‹±æ–‡ ï¼Œä¸ä½¿ç”¨ä¸­æ–‡ã€‚<br>
æ—¥å¿—å…·ä½“å­—æ®µï¼šåˆ†ä¸º åŸºç¡€æ•°æ® + æ‰©å±•æ•°æ®ã€‚åŸºç¡€æ•°æ®ï¼Œæ˜¯åº•å±‚æ—¥å¿—æ¡†æ¶è‡ªå¸¦çš„ï¼Œæ‰€æœ‰æ—¥å¿—éƒ½éœ€åŒ…å«ã€‚æ‰©å±•æ•°æ®ï¼Œä¸åŒç±»å‹çš„æ—¥å¿—ï¼ŒåŒ…å«ä¸åŒçš„å­—æ®µ<br>
æ—¥å¿—åŸºç¡€æ•°æ®ï¼š</p>
<ul>
<li>hostname: string  ä¸»æœºå</li>
<li>hostipï¼šstring   ä¸»æœºip</li>
<li>timestampï¼šdate  æ—¥å¿—äº§ç”Ÿæ—¶é—´(UTC æ ¼å¼çš„æ—¥æœŸ)</li>
<li>moduleï¼šstring  æœåŠ¡åç§°</li>
<li>retï¼šint  çŠ¶æ€ç </li>
<li>cluster_tagï¼šstring   é›†ç¾¤åŒºåˆ†(ç¯å¢ƒå˜é‡$RUNENV)</li>
<li>calltimeï¼šint è€—æ—¶<br>
æ³¨æ„:åŸºç¡€å­—æ®µå¯å…¨éƒ¨åŒ…å«ä½†å¿…é¡»æœ‰å¯å›Šæ‹¬å­—æ®µ(å¦‚retæˆ–calltime)<br>
æ—¥å¿—æ‰©å±•æ•°æ®:</li>
<li>req\respç­‰è¯·æ±‚ä½“ï¼Œæ‰©å±•å­—æ®µ: TODO,éœ€ä½äºjsonç¬¬ä¸€å±‚å­—æ®µ</li>
<li>statç±»å‹æ—¥å¿—ï¼Œæ‰©å±•å­—æ®µ: {  perf: {rss:xxx, oss:xxx} }</li>
<li>pipeç±»å‹æ—¥å¿—ï¼Œæ‰©å±•å­—æ®µ: [ log:{rss:xxx, oss:xxx} ]</li>
<li>ä¸å¸¦æœ‰typeå­—æ®µä¸logstashå†²çªå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥</li>
</ul>
<h2 id="å†™å…¥é“¾è·¯ä¼˜åŒ–">å†™å…¥é“¾è·¯ä¼˜åŒ–:</h2>
<p>å»é™¤å†™å…¥å¤šä½™å­—æ®µå¦‚ï¼šreq\repç­‰<br>
å‹ç¼©æ— éœ€ç´¢å¼•å­—æ®µ,åšåºåˆ—åŒ–è½¬ä¹‰å‹ç¼©:å¦‚<br>
&quot;log&quot;: &quot;[{&quot;calltime&quot;:5,&quot;methodName&quot;:&quot;getStartNode&quot;,&quot;reqArgs&quot;:[&quot;5ee0fd60&quot;,&quot;START&quot;],&quot;result&quot;:{&quot;audioUrl&quot;:&quot;&quot;,&quot;name&quot;:&quot;å¼€å§‹&quot;,&quot;nodeId&quot;:1,&quot;replyContent&quot;:&quot;&quot;,&quot;toNodeIds&quot;:[2],&quot;type&quot;:&quot;start&quot;}},{&quot;calltime&quot;:6,&quot;methodName&quot;:&quot;getNodeById&quot;,&quot;reqArgs&quot;:[&quot;5ee0fd60&quot;,2],&quot;result&quot;:{&quot;audioUrl&quot;:&quot;http://aiui.xfyun.cn/index-aiui&quot;,&quot;name&quot;:&quot;æ‘˜æœºé—®å€™&quot;,&quot;nodeId&quot;:2,&quot;replyContent&quot;:&quot;æ‘˜æœºé—®å€™&quot;,&quot;toNodeIds&quot;:[3],&quot;type&quot;:&quot;robot&quot;}},{&quot;calltime&quot;:4,&quot;methodName&quot;:&quot;getNodeById&quot;,&quot;reqArgs&quot;:[&quot;5ee0fd60&quot;,3],&quot;result&quot;:{&quot;audioUrl&quot;:&quot;&quot;,&quot;name&quot;:&quot;ç”¨æˆ·ä»»æ„è¯´&quot;,&quot;nodeId&quot;:3,&quot;replyContent&quot;:&quot;&quot;,&quot;toNodeIds&quot;:[4],&quot;type&quot;:&quot;popple&quot;}},{&quot;calltime&quot;:4,&quot;methodName&quot;:&quot;getNextAnswerNodes&quot;,&quot;reqArgs&quot;:[&quot;5ee0fd60&quot;,{&quot;audioUrl&quot;:&quot;http://aiui.xfyun.cn/index-aiui&quot;,&quot;name&quot;:&quot;æ‘˜æœºé—®å€™&quot;,&quot;nodeId&quot;:2,&quot;replyContent&quot;:&quot;æ‘˜æœºé—®å€™&quot;,&quot;toNodeIds&quot;:[3],&quot;type&quot;:&quot;robot&quot;}],&quot;result&quot;:[4]}]&quot;,</p>
<h1 id="es-clusteré›†ç¾¤ä¼˜åŒ–">Es clusteré›†ç¾¤ä¼˜åŒ–:</h1>
<h2 id="æœºå™¨éƒ¨ç½²">æœºå™¨éƒ¨ç½²:</h2>
<p>æ—¥å¿—æ•°æ®éä¸šåŠ¡é‡è¦å¯ä»¥è¯•è¯•RAID0,å†™å…¥æ€§èƒ½ç›¸å¯¹RAID1å¯ä»¥æå‡25-30%</p>
<h2 id="é’ˆå¯¹translogä¼˜åŒ–">é’ˆå¯¹translogä¼˜åŒ–:</h2>
<p>translog.flush_threshold_sizeï¼š 1024mb<br>
translog.durability ==&gt;asyncå¼‚æ­¥æ–¹å¼åŒæ­¥</p>
<h2 id="ç´¢å¼•åˆ·æ–°ä¼˜åŒ–">ç´¢å¼•åˆ·æ–°ä¼˜åŒ–</h2>
<p>éƒ¨åˆ†ç´¢å¼•éå®æ—¶æœç´¢.æƒ³ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦è€Œä¸æ˜¯è¿‘å®æ—¶æœç´¢,é™ä½ç´¢å¼•çš„åˆ·æ–°é¢‘ç‡<br>
&quot;refresh_interval&quot;: &quot;30s&quot;</p>
<h2 id="åˆ†ç‰‡å‰¯æœ¬ä¼˜åŒ–">åˆ†ç‰‡å‰¯æœ¬ä¼˜åŒ–</h2>
<p>åˆ†ç‰‡å’Œå‰¯æœ¬:é’ˆå¯¹å¤§ç´¢å¼•+é«˜å†™å…¥+å­˜å‚¨å¤§å°å¤§äº150GB<br>
number_of_shards 10<br>
number_of_replicas 1 or 0<br>
æ ¹æ®ç´¢å¼•çš„é‡è¦ç¨‹åº¦+æŸ¥è¯¢é€Ÿåº¦è¦æ±‚ æœ‰æ— å‰¯æœ¬</p>
<p>é«˜å†™å…¥+å­˜å‚¨å¤§å°å¤§äº150GB + ä½æŸ¥è¯¢é€Ÿåº¦ æœ‰äº›æ— å‰¯æœ¬ å¹¶ä¸”åˆ†ç‰‡ ç•¥å°äºèŠ‚ç‚¹æ•°</p>
<h2 id="å¢å¤§é™æ€é…ç½®å‚æ•°">å¢å¤§é™æ€é…ç½®å‚æ•°</h2>
<p>indices.memory.index_buffer_size (é»˜è®¤10%)<br>
ç¤ºä¾‹:ç´¢å¼•10shards,1å‰¯æœ¬,æ—¥çº¦3.6äº¿æ¡ï¼Œå­˜å‚¨é‡1Tå·¦å³,è®¾ç½®æˆ30%æé«˜äº†çº¦10%å†™å…¥æ€§èƒ½</p>
<h2 id="é¿å…å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹">é¿å…å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹</h2>
<p>routing.allocation.total_shards_per_node&quot;:&quot;2&quot;</p>
<h2 id="è°ƒæ•´bulkçº¿ç¨‹æ± å’Œé˜Ÿåˆ—">è°ƒæ•´bulkçº¿ç¨‹æ± å’Œé˜Ÿåˆ—</h2>
<h2 id="éƒ¨åˆ†é«˜é¢‘ç´¢å¼•è‡ªå»ºtemplates">éƒ¨åˆ†é«˜é¢‘ç´¢å¼•è‡ªå»ºtemplatesï¼š</h2>
<p>å†™å…¥ä½“è¾ƒå¤§çš„ç´¢å¼•,å¦‚æŸæ¡æ—¥å¿—æ¥è¿‘ä¸Šåƒè¡Œ,ä¸å»ºè®®å¾€esä¸­è¿›è¡Œå†™å…¥,å› å­—æ®µè¾ƒå¤šï¼Œæˆ–è€…æ—¥å¿—ä½“ä¸­å«æœ‰æ— æ³•è§£æçš„jsonä½“æˆ–è€…dictä½“ã€‚è™½ç„¶ç¬¬ä¸€å±‚å­—æ®µç±»å‹è¢«å®šä¹‰ä¸ºtextæˆ–è€…æ•°ç»„ä½“ã€‚ä½†æ˜¯å†…éƒ¨å­—æ®µè¿˜æ˜¯ä¼šè¢«åˆ†ç¦»ï¼Œè¢«mapping.åç»­å¤§é‡æ—¥å¿—å†™å…¥çš„æ—¶å€™å°±ä¼šè¿›è¡Œå¤§é‡çš„mapping,æ—¥å¿—é‡å’Œæ—¥å¿—ä½“éƒ½è¿‡å¤§æˆ–å¯¼è‡´mergeçš„æ—¶å€™è€—æ—¶é«˜ï¼ŒåŒæ—¶è¿›è¡Œæ–°æ—§gcçš„æ—¶å€™ä¹Ÿä¼šè€—æ—¶å¾ˆå¤§ã€‚ä¹Ÿå®¹æ˜“å¯¼è‡´èŠ‚ç‚¹oom</p>
<h1 id="æŸ¥è¯¢ä¼˜åŒ–">æŸ¥è¯¢ä¼˜åŒ–:</h1>
<p>1.é€šè¿‡ç›‘æ§åˆ†æç¡®å®šESé›†ç¾¤èŠ‚ç‚¹è´Ÿè½½,å¯¹é«˜è´Ÿè½½èŠ‚ç‚¹åšå®šå‘ç´¢å¼•åˆ†è§£å’Œå¿…è¦æ—¶é‡å¯æ•£å‹åŠ›æ“ä½œ<br>
2.å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹å¯è¯•å›¾é€šè¿‡Cerebro æˆ–è€…è‡ªèº«es-headè¿›è¡Œç´¢å¼•åˆ†ç‰‡è°ƒæ•´<br>
3.æŸ¥è¯¢æ—¶å°½é‡å‹¿é€‰æ‹©æ—¶é—´é•¿ã€é€šé…å­—ç¬¦æŸ¥è¯¢ã€åˆ†ç‰‡æ•°é‡å¤§</p>
<h1 id="æ€»ç»“è¿‡ç¨‹">æ€»ç»“è¿‡ç¨‹</h1>
<p>è§„èŒƒæ—¥å¿—å†™å…¥æ ¼å¼ã€æ—¥å¿—å†™å…¥å‰è¿›è¡Œåºåˆ—åŒ–ã€å›ºåŒ–æ—¥å¿—å†…å›ºå®šå­—æ®µç”¨äºåç»­å‘Šè­¦<br>
å‡çº§æ—¥å¿—é›†ç¾¤ç‰ˆæœ¬å’Œæ–°çš„å‘Šè­¦å¯¹é½ã€æ—¥å¿—æœºå™¨ç»Ÿä¸€åŒ–ã€æ¨¡æ¿åŒ–ã€é›†ç¾¤æ•°æ®èŠ‚ç‚¹/åè°ƒèŠ‚ç‚¹åˆ†ç¦»<br>
ä¼˜åŒ–é›†ç¾¤é…ç½®ï¼šè°ƒæ•´çº¿ç¨‹æ± å’Œé˜Ÿåˆ—ã€translogå¼‚æ­¥ä¼˜åŒ–ã€ç´¢å¼•ç­‰çº§åˆ·æ–°ä¼˜åŒ–ã€ç´¢å¼•åˆ†ç±»å‰¯æœ¬ä¼˜åŒ–ã€ç´¢å¼•<br>
ä¼˜åŒ–å†™å…¥é“¾è·¯:å»é™¤å†™å…¥å¤šä½™å­—æ®µ(req/respç­‰)ã€å‹ç¼©å­—æ®µå†…éƒ¨å­—å…¸/æ•°ç»„æ—¥å¿—ã€åšæ€§èƒ½æ—¥å¿—çš„è€—æ—¶ä¸¢å¼ƒã€æŒ‰ç…§ç‰¹å®šè§„åˆ™åˆ†å‰²<br>
ç´¢å¼•ä¼˜åŒ–éƒ¨åˆ†é‡è¦ç´¢å¼•ä¼˜åŒ–å‰¯æœ¬ã€è‡ªå»ºtemplatesã€å®šä¹‰å¥½mappingè§„åˆ™<br>
æŸ¥è¯¢ä¼˜åŒ–: çƒ­ç‚¹æ•°æ®è¿›è¡Œå†…å­˜ç¼“å­˜å¿«é€ŸæŸ¥è¯¢ï¼Œé›†ç¾¤éƒ¨åˆ†èŠ‚ç‚¹åšå†·æ•°æ®å­˜å‚¨,å¤§äº3å¤©çš„æ•°æ®æŠ›å…¥å†·èŠ‚ç‚¹ï¼Œ<br>
æ¶ˆè´¹ä¼˜åŒ–: æ¨¡æ¿åŒ–å•keyæ¶ˆè´¹æ¨¡æ¿ä¸cicdæ‰“é€š,ç”±ç‰©ç†æœºå¤šæœºå™¨éƒ¨ç½²å‡çº§è‡³å®¹å™¨åŒ–éƒ¨ç½²<br>
ç¼“å­˜ä¼˜åŒ–ï¼šå› ç¼“å­˜ç»„ä»¶æ— æ³•æ›´æ¢ï¼Œç”±å•èŠ‚ç‚¹rediså‡çº§è‡³temproxyå¤šèŠ‚ç‚¹åˆ†å‘ï¼Œé’ˆå¯¹redisç¼“å­˜é˜Ÿåˆ—é…ç½®å’Œå†™å…¥é—®é¢˜åšäº†ä¼˜åŒ–</p>
<h1 id="æ€»ç»“">æ€»ç»“:</h1>
<p>1.å¦‚æœæœ‰èƒ½åŠ›ä¸ŠSSD+å†…å­˜å¤§å°å¤§äºæ•°æ®60%,å¯ä»¥å¿½ç•¥ä¸Šè¿°æ‰€æœ‰<br>
2.å¦‚æœé’ˆå¯¹ç£ç›˜æ€§èƒ½é—®é¢˜å¯ä»¥è¯•è¯•ç£ç›˜ç¡¬ä»¶æ–¹é¢RAID0<br>
3.æ•´ä½“é“¾è·¯ä¼˜åŒ–éœ€è¦ä»å…¥å£ã€è¿‡æ»¤ã€å†™å…¥éƒ½éœ€è¦è¿›è¡Œä¼˜åŒ–<br>
4.æœ€å¥½çš„ä¼˜åŒ–æ–¹æ³•æ˜¯ç®€äºå½¢,è§„äºå¿ƒ</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ã€ç›‘æ§ã€‘ç›‘æ§åˆ°åº•è¦ç›‘æ§å“ªäº›ä¸œè¥¿]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/jian-kong-jian-kong-dao-di-yao-jian-kong-na-xie-dong-xi/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/jian-kong-jian-kong-dao-di-yao-jian-kong-na-xie-dong-xi/">
        </link>
        <updated>2020-03-06T02:49:52.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ˜å¯¹äºè¿ç»´æ¥è¯´ï¼Œè€ç”Ÿå¸¸è°ˆçš„å°±æ˜¯ç›‘æ§.<br>
é‚£ä¹ˆæˆ‘ä»¬è¯¥ç›‘æ§å“ªäº›ä¸œè¥¿æ‰èƒ½æ‰èƒ½åŠæ—¶çš„å‘ç°é—®é¢˜,ä¸ä¼šèƒŒé”…ï¼Œæ‰ä¸ä¼šäº‹åå¼¥è¡¥å‘¢</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ˜å¯¹äºè¿ç»´æ¥è¯´ï¼Œè€ç”Ÿå¸¸è°ˆçš„å°±æ˜¯ç›‘æ§.<br>
é‚£ä¹ˆæˆ‘ä»¬è¯¥ç›‘æ§å“ªäº›ä¸œè¥¿æ‰èƒ½æ‰èƒ½åŠæ—¶çš„å‘ç°é—®é¢˜,ä¸ä¼šèƒŒé”…ï¼Œæ‰ä¸ä¼šäº‹åå¼¥è¡¥å‘¢</p>
<!-- more -->
<h1 id="åäººåè¨€">åäººåè¨€</h1>
<ul>
<li>
<p>ç›‘æ§å¤§æ³•å¥½ï¼Œè°ä¹Ÿè·‘ä¸äº†</p>
</li>
<li>
<p>ä¸šåŠ¡æœ‰é—®é¢˜ï¼Œç›‘æ§å¸®åŠ©æ‚¨ï¼</p>
<p>æ¶æ„æ¢³ç†å›¾:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864679339.png" alt="" loading="lazy"></p>
</li>
</ul>
<p>ä»ä»¥ä¸Šå›¾å¯ä»¥çœ‹å‡ºä½œè€…è¿™è¾¹æŠŠç›‘æ§åˆ†ä¸ºä»å…¥å£åˆ°åº•éƒ¨çš„ä¸€ä¸ªåˆ†å±‚:</p>
<ul>
<li>æœåŠ¡ç›‘æ§</li>
<li>ä¸­é—´ä»¶ç›‘æ§</li>
<li>ä¸šåŠ¡ç›‘æ§</li>
<li>å…¥å£ç›‘æ§</li>
<li>æ¥å…¥ç›‘æ§</li>
</ul>
<h2 id="æœåŠ¡ç›‘æ§">æœåŠ¡ç›‘æ§</h2>
<p>é’ˆå¯¹æœåŠ¡å™¨çš„åŸºç¡€ç›‘æ§:<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864869984.png" alt="" loading="lazy"></p>
<h2 id="ä¸­é—´ä»¶å®¹å™¨">ä¸­é—´ä»¶/å®¹å™¨</h2>
<p>é’ˆå¯¹æœåŠ¡ä¾èµ–ä¸­é—´ä»¶/è½½ä½“ï¼š<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864887255.png" alt="" loading="lazy"></p>
<h2 id="k8sé›†ç¾¤">K8Sé›†ç¾¤</h2>
<p>å½“å‰K8Så·²ç»æœ‰å¾ˆå¤šå…¬å¸ä½¿ç”¨ä¸­,å¯¹äºå®ƒçš„ç›‘æ§ä¹Ÿæ˜¯è‡³å…³é‡è¦<br>
<img src="https://github.com/amendge/amendge.github.io/post-images/1617864891752.png" alt="" loading="lazy"></p>
<h2 id="ä¸šåŠ¡ç›‘æ§é›†æˆ">ä¸šåŠ¡ç›‘æ§(é›†æˆ)</h2>
<p>å¦‚æœæœ‰å…¬å¸ä½¿ç”¨proemtheusçš„å¯ä»¥è¯•è¯•åœ¨ä¸å½±å“æœåŠ¡æ€§èƒ½çš„æƒ…å†µä¸‹ç»§æ‰¿Prometheuså®¢æˆ·ç«¯ï¼Œå®˜æ–¹æé«˜äº†ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯</p>
<ul>
<li>golang</li>
<li>java(jmx_exporter\pom)</li>
<li>pythonç­‰ç­‰</li>
</ul>
<h2 id="ä¸šåŠ¡ç›‘æ§æ—¥å¿—">ä¸šåŠ¡ç›‘æ§(æ—¥å¿—)</h2>
<p>é’ˆå¯¹ç»„ä»¶æ—¥å¿—ç›‘æ§ä¸€èˆ¬éœ€è¦è§„èŒƒæ ¼å¼.</p>
<ul>
<li>nginxæ—¥å¿—</li>
<li>ç»„ä»¶æ—¥å¿—</li>
<li>è¯·æ±‚æ—¥å¿—</li>
<li>é“¾è·¯æ—¥å¿—<br>
ä¸€èˆ¬ç»„ä»¶æ—¥å¿—å¸¸ç”¨çŠ¶æ€ç æˆ–è€…è€—æ—¶è¿›è¡Œç›‘æ§ï¼Œè€Œç»„ä»¶ä¸šåŠ¡æ—¥å¿—åŒ…å«å¾ˆå¤šæ•æ„Ÿä¿¡æ¯æˆ–ä¸åŒç±»å‹,å¸¸ç”¨å¤§æ•°æ®èšåˆç»Ÿè®¡ç›‘æ§</li>
</ul>
<h2 id="è°ƒç”¨ç›‘æ§">è°ƒç”¨ç›‘æ§</h2>
<p>é’ˆå¯¹ä¸šåŠ¡åšé“¾è·¯æ‹¨æµ‹</p>
<ul>
<li>å…¨é“¾è·¯æ‹¨æµ‹</li>
<li>é‡ç‚¹å®¢æˆ·æ‹¨æµ‹</li>
<li>å…¨ä¸šåŠ¡æ¨¡å—æ‹¨æµ‹</li>
<li>æ ¸å¿ƒç»„ä»¶æ‹¨æµ‹</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é¦–åº]]></title>
        <id>https://github.com/amendge/amendge.github.io/post/welcome/</id>
        <link href="https://github.com/amendge/amendge.github.io/post/welcome/">
        </link>
        <updated>2019-05-14T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘ æ¬¢è¿ä½¿ç”¨æ¥åˆ°Amendçš„ä¸ªäººåšå®¢ï¼<br>
âœï¸ è¿™é‡Œç”¨æ¥è®°å½•æˆ‘çš„æŠ€æœ¯æ”»ç•¥ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘ æ¬¢è¿ä½¿ç”¨æ¥åˆ°Amendçš„ä¸ªäººåšå®¢ï¼<br>
âœï¸ è¿™é‡Œç”¨æ¥è®°å½•æˆ‘çš„æŠ€æœ¯æ”»ç•¥ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<h2 id="talk-is-sheep-show-me-code">talk is sheep show me codeğŸ‘‡</h2>
<p><a href="https://github.com/gecailong">Github</a><br>
<a href="http://www.noalert.cn">blog</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“ ä»ä¸šå¹´é™4å¹´</p>
<p>ğŸŒ‰ ä»ä¸šæ–¹å‘ç›‘æ§ä¸ºä¸»+</p>
<p>ğŸ·ï¸ æˆ‘çš„æ ‡ç­¾:ç›‘æ§ã€å‘Šè­¦ã€è¿ç»´ã€å°å¸…æ¯”</p>
<p>ğŸ“‹ è¿™é‡Œå‘¢è®°å½•çš„ä¸ä»…æ˜¯æˆ‘è‡ªèº«çš„é’»ç ”ã€è¿˜æœ‰å¾ˆå¤šå¤§ç¥ä»¬çš„æŠ€æœ¯ç§¯ç´¯</p>
<p>ğŸ’» å­¦è¿‡python\java\c++\golangï¼Œä½†æ˜¯ç•¥æ‡‚python</p>
<p>ğŸŒ ä½ å¯ä»¥ä½¿ç”¨ ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ æˆ– Coding Pages æŸ¥çœ‹æˆ‘çš„åˆ†äº«å’Œåˆ›ä½œæ¥æ”¯æŒä½ çš„å·¥ä½œ</p>
<p>ğŸŒ± å½“ç„¶æˆ‘è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œæˆ‘ä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œæˆ‘ä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>ğŸ˜˜ Enjoy~</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>